
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>OpenWhisk Action Sequences - Seven Story Rabbit Hole</title>
  <meta name="author" content="Traun Leyden">

  
  <meta name="description" content="This will walk you through getting up and running from scratch with Apache OpenWhisk on OSX, and setting up an Action Sequence where the output of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tleyden.github.io/blog/2017/07/02/openwhisk-action-sequences">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Seven Story Rabbit Hole" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>

  <table><tr><td>
  <h1><a href="/">Seven Story Rabbit Hole</a></h1>
  
    <h2>Sometimes awesome things happen in deep rabbit holes.  Or not.</h2>
  
  </td><td>&nbsp;&nbsp;
  <img class="left" src="/images/rabbit_hole_graphic.png" width="132" height="105" title="image" alt="images">
  </td></tr>
  </table>

</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tleyden.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">OpenWhisk Action Sequences</h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-07-02T11:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2017</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This will walk you through getting up and running from scratch with Apache OpenWhisk on OSX, and setting up an Action Sequence where the output of one OpenWhisk Action is fed into the input of the next Action.</p>

<h2>Install OpenWhisk via Vagrant</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Clone openwhisk
</span><span class='line'>git clone --depth=1 https://github.com/apache/incubator-openwhisk.git openwhisk
</span><span class='line'>
</span><span class='line'># Change directory to tools/vagrant
</span><span class='line'>cd openwhisk/tools/vagrant
</span><span class='line'>
</span><span class='line'># Run script to create vm and run hello action
</span><span class='line'>./hello</span></code></pre></td></tr></table></div></figure>


<p>You should see reams of output, followed by:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==&gt; default: ++ wsk action invoke /whisk.system/utils/echo -p message hello --result
</span><span class='line'>==&gt; default: {
</span><span class='line'>==&gt; default:     "message": "hello"
</span><span class='line'>==&gt; default: }</span></code></pre></td></tr></table></div></figure>


<h2>SSH into Vagrant machine and run OpenWhisk CLI</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant ssh</span></code></pre></td></tr></table></div></figure>


<p>Now you can access the OpenWhisk CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk
</span><span class='line'>
</span><span class='line'>        ____      ___                   _    _ _     _     _
</span><span class='line'>       /\   \    / _ \ _ __   ___ _ __ | |  | | |__ (_)___| | __
</span><span class='line'>  /\  /__\   \  | | | | '_ \ / _ \ '_ \| |  | | '_ \| / __| |/ /
</span><span class='line'> /  \____ \  /  | |_| | |_) |  __/ | | | |/\| | | | | \__ \   &lt;
</span><span class='line'> \   \  /  \/    \___/| .__/ \___|_| |_|__/\__|_| |_|_|___/_|\_\
</span><span class='line'>  \___\/ tm           |_|
</span><span class='line'>
</span><span class='line'>Usage:
</span><span class='line'>  wsk [command]</span></code></pre></td></tr></table></div></figure>


<p>Re-run the &ldquo;Hello world&rdquo; via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke /whisk.system/utils/echo -p message hello --result
</span><span class='line'>{
</span><span class='line'>    "message": "hello"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Hello Go/Docker</h2>

<p>I tried following the <a href="http://jamesthom.as/blog/2017/01/17/openwhisk-and-go/">instructions on James Thomas&#8217; blog</a> for running Go within Docker, but ran into an error (see Disqus comment), and so here&rsquo;s how I worked around it.</p>

<p>First create a simple Go program and cross compile it.  Save the following to <code>exec.go</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main
</span><span class='line'>
</span><span class='line'>import "encoding/json"
</span><span class='line'>import "fmt"
</span><span class='line'>import "os"
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>  // native actions receive one argument, the JSON object as a string
</span><span class='line'>  arg := os.Args[1]
</span><span class='line'>
</span><span class='line'>  // unmarshal the string to a JSON object
</span><span class='line'>  var obj map[string]interface{}
</span><span class='line'>  json.Unmarshal([]byte(arg), &obj)
</span><span class='line'>  name, ok := obj["name"].(string)
</span><span class='line'>  if !ok {
</span><span class='line'>      name = "Stranger"
</span><span class='line'>  }
</span><span class='line'>  msg := map[string]string{"msg": ("Hello, " + name + "!")}
</span><span class='line'>  res, _ := json.Marshal(msg)
</span><span class='line'>  fmt.Println(string(res))
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Cross compile it for Linux:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>env GOOS=linux GOARCH=amd64 go build exec.go</span></code></pre></td></tr></table></div></figure>


<p>Pull the upstream Docker image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker pull openwhisk/dockerskeleton</span></code></pre></td></tr></table></div></figure>


<p>Create a custom docker image based on <code>openwhisk/dockerskeleton</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM openwhisk/dockerskeleton
</span><span class='line'>
</span><span class='line'>COPY exec /action/exec</span></code></pre></td></tr></table></div></figure>


<p>Build and test:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker build -t you/openwhisk-exec-test .
</span><span class='line'>$ docker run you/openwhisk-exec-test /action/exec '{"name": "James"}'
</span><span class='line'>{"msg":"Hello, James!"}</span></code></pre></td></tr></table></div></figure>


<h2>OpenWhisk Hello Go/Docker</h2>

<p>Push up the docker image to dockerhub:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker push you/openwhisk-exec-test</span></code></pre></td></tr></table></div></figure>


<p>Create the OpenWhisk action:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action create go_test --docker you/openwhisk-exec-test</span></code></pre></td></tr></table></div></figure>


<p>Invoke the action to verify it works:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke go_test --blocking --result
</span><span class='line'>{
</span><span class='line'>    "msg": "Hello, Stranger!"
</span><span class='line'>}
</span><span class='line'>$ wsk action invoke go_test --blocking --result --param name James
</span><span class='line'>{
</span><span class='line'>    "msg": "Hello, James!"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Define custom actions</h2>

<h3>Get a list of AWS users using aws-go-sdk</h3>

<p>Save this to <code>main.go</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main
</span><span class='line'>
</span><span class='line'>import (
</span><span class='line'>  "github.com/aws/aws-sdk-go/service/iam"
</span><span class='line'>  "github.com/aws/aws-sdk-go/aws/session"
</span><span class='line'>  "fmt"
</span><span class='line'>  "encoding/json"
</span><span class='line'>  "os"
</span><span class='line'>  "github.com/aws/aws-sdk-go/aws"
</span><span class='line'>  "github.com/aws/aws-sdk-go/aws/credentials"
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>type Params struct {
</span><span class='line'>  AwsAccessKeyId string
</span><span class='line'>  AwsSecretAccessKey string
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>type Result struct {
</span><span class='line'>  Doc interface{} `json:"doc"`
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  // native actions receive one argument, the JSON object as a string
</span><span class='line'>  arg := os.Args[1]
</span><span class='line'>
</span><span class='line'>  // unmarshal the string to a JSON object
</span><span class='line'>  var params Params
</span><span class='line'>  json.Unmarshal([]byte(arg), &params)
</span><span class='line'>
</span><span class='line'>  sess, err := session.NewSession(&aws.Config{
</span><span class='line'>      Credentials: credentials.NewCredentials(
</span><span class='line'>          &credentials.StaticProvider{Value: credentials.Value{
</span><span class='line'>              AccessKeyID:     params.AwsAccessKeyId,
</span><span class='line'>              SecretAccessKey: params.AwsSecretAccessKey,
</span><span class='line'>          }},
</span><span class='line'>      ),
</span><span class='line'>  })
</span><span class='line'>
</span><span class='line'>  // Create the service's client with the session.
</span><span class='line'>  svc := iam.New(sess)
</span><span class='line'>
</span><span class='line'>  listUsersInput := &iam.ListUsersInput{}
</span><span class='line'>
</span><span class='line'>  listUsersOutput, err := svc.ListUsers(listUsersInput)
</span><span class='line'>  if err != nil {
</span><span class='line'>      panic(fmt.Sprintf("Error listing users: %v", err))
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  result := Result{
</span><span class='line'>      Doc: listUsersOutput,
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  outputBytes, err := json.Marshal(result)
</span><span class='line'>  if err != nil {
</span><span class='line'>      panic(fmt.Sprintf("Error marshalling outputBytes: %v", err))
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  fmt.Printf("%s", string(outputBytes))
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Build and package into docker image, and push up to docker hub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ env GOOS=linux GOARCH=amd64 go build -o exec main.go
</span><span class='line'>$ docker build -t you/fetch-aws-keys .
</span><span class='line'>$ docker push you/fetch-aws-keys</span></code></pre></td></tr></table></div></figure>


<p>Create an OpenWhisk action:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action create fetch_aws_keys --docker you/fetch-aws-keys --param AwsAccessKeyId "YOURKEY" --param AwsSecretAccessKey "YOURSECRET"</span></code></pre></td></tr></table></div></figure>


<p>Invoke it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke fetch_aws_keys --blocking --result
</span><span class='line'>{
</span><span class='line'>    "doc": {
</span><span class='line'>        "IsTruncated": false,
</span><span class='line'>        "Marker": null,
</span><span class='line'>        "Users": [
</span><span class='line'>            {
</span><span class='line'>                "Arn": "arn:aws:iam::9798798:user/some.user@yourcompany.co",
</span><span class='line'>                "CreateDate": "2016-01-11T23:49:40Z",
</span><span class='line'>                "PasswordLastUsed": "2017-06-07T17:41:08Z",
</span><span class='line'>                "Path": "/",
</span><span class='line'>                "UserId": "AIDAHGJJK87878KKW",
</span><span class='line'>                "UserName": "some.user@yourcompany.co"
</span><span class='line'>            },
</span><span class='line'>        ...
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Write to a CloudantDB</h3>

<h4>Cloudant Setup</h4>

<p>Create a Cloudant database via the Bluemix web admin.</p>

<p>Under the <strong>Permissions</strong> control panel section for the database, choose <strong>Generate a new API key</strong>.</p>

<p>Check the <strong>_writer</strong> permission and make a note of the <strong>Key</strong> and <strong>Password</strong></p>

<p>Verify connectivity by making a curl request:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -u "yourkey:yourpassword" http://67687-818ca382-081d--bluemix.cloudant.com/yourdb/_all_docs
</span><span class='line'>{"total_rows":0,"offset":0,"rows":[
</span><span class='line'>
</span><span class='line'>]}</span></code></pre></td></tr></table></div></figure>


<h4>OpenWhisk + Cloudant</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk package bind /whisk.system/cloudant myCloudant -p username MYUSERNAME -p password MYPASSWORD -p host MYCLOUDANTACCOUNT.cloudant.com</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m currently getting this error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>error: Binding creation failed: The supplied authentication is not authorized to access this resource. (code 751)</span></code></pre></td></tr></table></div></figure>


<h3>Switch to BlueMix</h3>

<p>At this point I swiched to the OpenWhisk on Bluemix, and downloaded the <code>wsk</code> cli from the Bluemix website, and configure it with my api key per the instructions.  Then I re-installed the action via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action create fetch_aws_keys --docker you/fetch-aws-keys --param AwsAccessKeyId "YOURKEY" --param AwsSecretAccessKey "YOURSECRET"</span></code></pre></td></tr></table></div></figure>


<p>and made sure it worked by running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke fetch_aws_keys --blocking --result</span></code></pre></td></tr></table></div></figure>


<h4>Cloudant Setup</h4>

<p>Following <a href="https://github.com/apache/incubator-openwhisk-package-cloudant/blob/master/README.md#setting-up-a-cloudant-database-in-bluemix">these instructions</a>:</p>

<p>You can get your Bluemix Org name (maybe the first part of your email address by default) and BlueMix space (dev by default) from the Bluemix web admin.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk property set --namespace myBluemixOrg_myBluemixSpace
</span><span class='line'>ok: whisk namespace set to myBluemixOrg_myBluemixSpace</span></code></pre></td></tr></table></div></figure>


<p>Refresh packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk package refresh
</span><span class='line'>myBluemixOrg_myBluemixSpace refreshed successfully
</span><span class='line'>created bindings:
</span><span class='line'>updated bindings:
</span><span class='line'>deleted bindings:</span></code></pre></td></tr></table></div></figure>


<p>It didn&rsquo;t work according to the docs, and no bindings were created even though I had created a Cloudant database in the Bluemix admin earlier.</p>

<p>I retried the <code>package bind</code> command that had failed earlier:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk package bind /whisk.system/cloudant myCloudant -p username MYUSERNAME -p password MYPASSWORD -p host MYCLOUDANTACCOUNT.cloudant.com</span></code></pre></td></tr></table></div></figure>


<p>and this time success!!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ok: created binding myCloudant</span></code></pre></td></tr></table></div></figure>


<p>Try writing to the db with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke /yournamespace/myCloudant/write --blocking --result --param dbname yourdb --param doc "{\"_id\":\"heisenberg\",\"name\":\"Walter White\"}"</span></code></pre></td></tr></table></div></figure>


<p>and you should get a response like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    "id": "heisenberg",
</span><span class='line'>    "ok": true,
</span><span class='line'>    "rev": "1-f413f4b74a724e391fa5dd2e9c8e9d3f"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Connect them in a sequence</h2>

<h3>Create a new package binding pinned to a particular db</h3>

<p>The <code>/yournamespace/myCloudant/write</code> action expects a <code>dbname</code> parameter, but the upstream <code>fetch_aws_keys</code> doesn&rsquo;t contain that parameter.  (and it&rsquo;s better that it doesn&rsquo;t, to reduce decoupling).  So if you try to connect the two actions in a sequence at this point, it will fail.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk package bind /whisk.system/cloudant myCloudantTestDb -p username MYUSERNAME -p password MYPASSWORD -p host MYCLOUDANTACCOUNT.cloudant.com -p dbname testdb</span></code></pre></td></tr></table></div></figure>


<h3>Create sequence action</h3>

<p>Create a sequence that will invoke these actions in sequence:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action create fetch_and_write_aws_keys --sequence fetch_aws_keys,/namespace/myCloudantTestDb/write</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Fetch the AWS keys</li>
<li>Write the doc containing the AWS keys to the <code>testdb</code> database bound to the myCloudantTestDb package</li>
</ol>


<p>Try it out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke fetch_and_write_aws_keys --blocking --result
</span><span class='line'>{
</span><span class='line'>    "id": "d80f24dc270208191c07c802bee4e58d",
</span><span class='line'>    "ok": true,
</span><span class='line'>    "rev": "1-ff66b6a20f50ea36d9019481276aa0bb"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>To view the resulting document:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action invoke /traun.leyden_dev/cloudantKeynuker/read --blocking --result --param id d80f24dc270208191c07c802bee4e58d
</span><span class='line'>{
</span><span class='line'>    "IsTruncated": false,
</span><span class='line'>    "Marker": null,
</span><span class='line'>    "Users": [
</span><span class='line'>        {
</span><span class='line'>            "Arn": "arn:aws:iam::9798798:user/some.user@yourcompany.co",
</span><span class='line'>            "CreateDate": "2016-01-11T23:49:40Z",
</span><span class='line'>            "PasswordLastUsed": "2017-06-07T17:41:08Z",
</span><span class='line'>            "Path": "/",
</span><span class='line'>            "UserId": "AIDAHGJJK87878KKW",
</span><span class='line'>            "UserName": "ome.user@yourcompany.co"
</span><span class='line'>        },</span></code></pre></td></tr></table></div></figure>


<h2>Drive with a scheduler</h2>

<p>Let&rsquo;s say we wanted this to run every minute.</p>

<p>First create an alarm trigger that will fire every minute:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk trigger create everyMinute --feed /whisk.system/alarms/alarm -p cron '* * * * *'</span></code></pre></td></tr></table></div></figure>


<p>Now create a rule that will invoke the <code>fetch_and_write_aws_keys</code> action (which is a sequence action) whenever the <code>everyMinute</code> feed is triggered:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk rule create fetch_and_write_aws_keys_every_minute everyMinute fetch_and_write_aws_keys</span></code></pre></td></tr></table></div></figure>


<p>To verify that it is working, check your cloudant database to look for new docs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -u "yourkey:yourpassword" http://67687-818ca382-081d--bluemix.cloudant.com/yourdb/_all_docs</span></code></pre></td></tr></table></div></figure>


<p>Or you can also monitor the activations:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk activation poll
</span><span class='line'>Activation: everyMinute (f454e74ae4254657b0c920d14ea0d078)
</span><span class='line'>[]
</span><span class='line'>
</span><span class='line'>Activation: write (5d0e5c2a5af449efa1063b8dab71ba40)
</span><span class='line'>[
</span><span class='line'>    "2017-07-04T18:49:01.820736174Z stdout: success { ok: true,",
</span><span class='line'>    "2017-07-04T18:49:01.820773215Z stdout: id: '6a3e007478278726c5ecd7c85a9fe845',",
</span><span class='line'>    "2017-07-04T18:49:01.820781052Z stdout: rev: '1-25dae194be45260756aa43454fa28e60' }"
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>Activation: fetch_aws_keys (5d3a343b5a224130b4ea4bcb82517dc3)
</span><span class='line'>[
</span><span class='line'>    "2017-07-04T18:49:01.748729114Z stdout: XXX_THE_END_OF_A_WHISK_ACTIVATION_XXX",
</span><span class='line'>    "2017-07-04T18:49:01.748801169Z stderr: XXX_THE_END_OF_A_WHISK_ACTIVATION_XXX"
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>Activation: fetch_and_write_aws_keys (14619d5125a247f983a6d1e840820bb4)
</span><span class='line'>[
</span><span class='line'>    "5d3a343b5a224130b4ea4bcb82517dc3",
</span><span class='line'>    "5d0e5c2a5af449efa1063b8dab71ba40"
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>Activation: fetch_and_write_aws_keys_every_minute (de37f6b2bbaa407eb343b3859d9b3f74)
</span><span class='line'>[]
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Traun Leyden</span></span>

      








  


<time datetime="2017-07-02T11:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2017</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/openwhisk/'>openwhisk</a>, <a class='category' href='/blog/categories/serverless/'>serverless</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://tleyden.github.io/blog/2017/07/02/openwhisk-action-sequences/" data-via="tleydn" data-counturl="http://tleyden.github.io/blog/2017/07/02/openwhisk-action-sequences/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/06/14/running-postgresql-in-docker/" title="Previous Post: Running PostgreSQL in Docker">&laquo; Running PostgreSQL in Docker</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>
  Sr. Software engineer at <a href="http://www.couchbase.com">Couchbase</a> - web scale distributed data platform. 
  </p>

  <p>
  Follow me on twitter: <a href="https://twitter.com/tleydn">@tleydn</a>
  </p>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/07/02/openwhisk-action-sequences/">OpenWhisk Action Sequences</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/14/running-postgresql-in-docker/">Running PostgreSQL in Docker</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/20/understanding-function-closures-in-go/">Understanding Function Closures in Go</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/11/21/tuning-the-go-http-client-library-for-load-testing/">Tuning the Go HTTP Client Settings for Load Testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/10/31/install-couchbase-server-plus-mobile-on-docker-cloud/">Install Couchbase Server + Mobile on Docker Cloud</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/tleyden">@tleyden</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tleyden',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Traun Leyden -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sevenstoryrabbithole';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://tleyden.github.io/blog/2017/07/02/openwhisk-action-sequences/';
        var disqus_url = 'http://tleyden.github.io/blog/2017/07/02/openwhisk-action-sequences/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

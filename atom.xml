<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Seven Story Rabbit Hole]]></title>
  <link href="http://tleyden.github.io/atom.xml" rel="self"/>
  <link href="http://tleyden.github.io/"/>
  <updated>2013-11-14T17:44:54-08:00</updated>
  <id>http://tleyden.github.io/</id>
  <author>
    <name><![CDATA[Traun Leyden]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Running couchbase cluster under docker]]></title>
    <link href="http://tleyden.github.io/blog/2013/11/14/running-couchbase-cluster-under-docker/"/>
    <updated>2013-11-14T15:45:00-08:00</updated>
    <id>http://tleyden.github.io/blog/2013/11/14/running-couchbase-cluster-under-docker</id>
    <content type="html"><![CDATA[<p>This tutorial will show you how to run a cluster of Couchbase Servers, where each node is running inside of a docker image.</p>

<p><img src="http://cl.ly/image/2G0h381N3o42/docker%20couchbase%20cluster.png" alt="Diagram" /></p>

<p>This probably looks like <em>a lot</em> of layers, which is going to be a heavy drain on your system resources.  Actually, it&rsquo;s not!</p>

<p>All of the layers under CoreOS are extremely thin and lightweight.  Docker&rsquo;s virtualization model is more like FreeBSD jails than VMWare.  Eg, the processes running inside a docker image are just processes inside the host OS (in this case, CoreOS).</p>

<p>(whereas the layer between OSX &ndash;> VirtualBox &ndash;> CoreOS is a more heavyweight virtualization model)</p>

<h2>Install Docker and dependencies</h2>

<p><a href="http://tleyden.github.io/blog/2013/11/12/docker-on-osx/">Install Docker on OSX</a></p>

<h2>Edit vagrant file to add port mappings</h2>

<p>In order to access all the nodes from the host, <em>which doesn&rsquo;t currently work</em>, you would need to add the following entries to your Vagrantfile:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>config.vm.network "forwarded_port", guest: 8091, host: 8091
</span><span class='line'>config.vm.network "forwarded_port", guest: 8092, host: 8092
</span><span class='line'>config.vm.network "forwarded_port", guest: 11210, host:   11210</span></code></pre></td></tr></table></div></figure>


<p>As mentioned, accessing all of the nodes from the host does not currently work.  However, I think at least some of these entries are needed, so to be on the safe side just add all of them.</p>

<h2>Start CoreOS and ssh in</h2>

<p>Execute the following commands in the directory where you have your CoreOS Vagrantfile.  In my case, I have it under <code>~/Tools/coreos-vagrant</code> and it contains a Vagrantfile, a README.md file, and a few others.</p>

<p>Start CoreOS</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant up</span></code></pre></td></tr></table></div></figure>


<p>SSH into CoreOS</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant ssh</span></code></pre></td></tr></table></div></figure>


<h2>Start docker image for a single node</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker run -i -t -d -p 11210:11210 -p 8091:7081 -p 8092:8092 dustin/latest</span></code></pre></td></tr></table></div></figure>


<p>and you should see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unable to find image 'dustin/couchbase:latest' (tag: latest) locally
</span><span class='line'>Pulling repository dustin/couchbase
</span><span class='line'>9e0279ab340d: Download complete
</span><span class='line'>...
</span><span class='line'>845987ce946b</span></code></pre></td></tr></table></div></figure>


<p>Find the name of the docker instance by running <code>$ docker ps</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>core@localhost ~ $ docker ps
</span><span class='line'>CONTAINER ID        IMAGE                     COMMAND                CREATED              STATUS              PORTS                                                                      NAMES
</span><span class='line'>845987ce946b        dustin/couchbase:latest   /bin/sh -c /usr/loca   About a minute ago   Up About a minute   0.0.0.0:11210-&gt;11210/tcp, 0.0.0.0:8091-&gt;7081/tcp, 0.0.0.0:8092-&gt;8092/tcp   purple_kangaroo</span></code></pre></td></tr></table></div></figure>


<p>In this case it&rsquo;s <em>purple_kangaroo</em>.</p>

<p>Now take a look at the logs for that docker instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>core@localhost ~ $ docker logs purple_kangaroo
</span><span class='line'>/opt/couchbase/etc/couchbase_init.d: 45: ulimit: error setting limit (Operation not permitted)
</span><span class='line'>/opt/couchbase/etc/couchbase_init.d: 47: ulimit: error setting limit (Operation not permitted)
</span><span class='line'> * Started couchbase-server
</span><span class='line'>Starting cluster
</span><span class='line'>SUCCESS: init 127.0.0.1
</span><span class='line'>SUCCESS: bucket-create</span></code></pre></td></tr></table></div></figure>


<p>If you only want to run one Couchbase Server node, you are pretty much done and you can skip to the section below to login to the Couchbase Server admin</p>

<p>If you want to run a cluster of Couchbase Server nodes, read on.</p>

<h2>Start docker images for other nodes</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run -i -t -d -link purple_kangaroo:alpha dustin/couchbase:latest</span></code></pre></td></tr></table></div></figure>


<p>This will start another node that is linked to the initial node, and will be in the same cluster.  There is some Weird Magic behind the scenes that makes that all work.</p>

<h1>Go to Couchbase Server admin</h1>

<p>Open <a href="http://localhost:8091/">http://localhost:8091/</a> in your browser, and you should see a login screen, where the default credentials are Administrator/password.</p>

<p>After you login, you should see the Admin UI with three nodes in your cluster:</p>

<p><img src="http://cl.ly/image/2K3i1v2w3H0E/Screen%20Shot%202013-11-14%20at%204.47.18%20PM.png" alt="Screenshot" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Investigating an Android SQLite threading deadlock]]></title>
    <link href="http://tleyden.github.io/blog/2013/11/14/investigating-an-android-sqlite-threading-deadlock/"/>
    <updated>2013-11-14T11:24:00-08:00</updated>
    <id>http://tleyden.github.io/blog/2013/11/14/investigating-an-android-sqlite-threading-deadlock</id>
    <content type="html"><![CDATA[<p>In an unreleased version of Couchbase Lite for Android, I was seeing the following error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>SQLiteConnectionPool The connection pool for database has been unable to grant a connection to thread
</span><span class='line'>SQLiteConnectionPool(14004): Connections: 0 active, 1 idle, 0 available.</span></code></pre></td></tr></table></div></figure>


<h2>Here&rsquo;s what turned out to be happening</h2>

<ul>
<li>Create a single SQLiteDatabase object that is shared among all threads</li>
<li>Thread1 spawned</li>
<li>Thread2 spawned</li>
<li>Thread1 opens a transaction and inserts some data</li>
<li>Thread1 calls .join() on Thread2 to wait for it to finish</li>
<li>Thread2 attempts to read some data</li>
<li>Deadlock!</li>
</ul>


<h2>Digging into the deadlock</h2>

<ul>
<li>Thread1 has an open transaction, and therefore is holding on to the one and only connection owned by the single SQLiteDatabase object</li>
<li>Thread2 is trying to get a new connection to execute its statement, but cannot because Thread1 is holding the only one available</li>
<li>Thread1 is waiting for Thread2 to finish so it can finish it&rsquo;s transaction and release the connection.</li>
<li>Deadlock!</li>
</ul>


<h2>Code to reproduce the issue</h2>

<p><a href="https://github.com/couchbaselabs/android-sqlite-experiments/blob/master/AndroidSQLiteExperiments/src/main/java/com/couchbaselabs/droidsqliteexprmnts/experiments/ThreadsSingleConnectionDeadlock.java">ThreadsSingleConnectionDeadlock.java</a></p>

<h2>Fix Idea #1 &ndash; Don&rsquo;t make Thread1 join Thread2</h2>

<p>This is the somewhat naive and obvious fix.</p>

<p>In the case of this particular bug, it looks like the code needs to be reworked anyway, which will make that fix in the process.</p>

<h2>(Bad) Fix Idea #2 &ndash; Each thread gets its own SQLiteDatabase object (for the same database)</h2>

<p>You would think this could solve the problem, and it probably would, but there are some major caveats here.</p>

<p>As explained in <a href="http://touchlabblog.tumblr.com/post/24474398246/android-sqlite-locking">Android Sqlite Locking</a>:</p>

<blockquote><p>If you try to write to the database from actual distinct connections at the same time, one will fail.  It will not wait till the first is done and then write.  It will simply not write your change.  Worse, if you don’t call the right version of insert/update on the SQLiteDatabase, you won’t get an exception.  You’ll just get a message in your LogCat, and that will be it.</p></blockquote>

<p>So to avoid this kind of hellish scenario, it&rsquo;s definitely safer to stick with a <a href="http://touchlabblog.tumblr.com/post/24474750219/single-sqlite-connection">Single SQLite connection</a></p>

<h2>Is there really a good fix?</h2>

<p>So what if you absolutely needed to have the ability to have Thread1 join Thread2, and you wanted to avoid giving each thread it&rsquo;s own SQLiteDatabase object, how could that be accomplished?</p>

<p>Or is that just a silly scenario and it&rsquo;s better to just not do that?  (it seems fairly easy to do it by accident in any scenarios where threads are waiting on another and both accessing the same database)</p>

<p>Actually, I don&rsquo;t know.. it&rsquo;s an open question.  Comments welcome.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Docker on OSX]]></title>
    <link href="http://tleyden.github.io/blog/2013/11/12/docker-on-osx/"/>
    <updated>2013-11-12T21:01:00-08:00</updated>
    <id>http://tleyden.github.io/blog/2013/11/12/docker-on-osx</id>
    <content type="html"><![CDATA[<p><img src="http://cl.ly/image/302X103n330L/docker.png" alt="Docker.png" /></p>

<h1>Goal</h1>

<p>Get Docker running under OSX.</p>

<h2>Environment</h2>

<ul>
<li><p>OSX Mavericks</p></li>
<li><p>Macbook Retina</p></li>
</ul>


<h2>Understanding the tools</h2>

<ul>
<li>Vagrant is a tool to provision VMs.</li>
<li>Virtualbox is VM software.</li>
<li>CoreOS is an operating system based on linux that&rsquo;s all about running docker.</li>
</ul>


<h2>Install VirtualBox + Vagrant</h2>

<ul>
<li><p>Install VirtualBox via <a href="http://download.virtualbox.org/virtualbox/4.3.2/VirtualBox-4.3.2-90405-OSX.dmg">VirtualBox OSX installer</a></p></li>
<li><p>Install Vagrant via <a href="http://files.vagrantup.com/packages/a40522f5fabccb9ddabad03d836e120ff5d14093/Vagrant-1.3.5.dmg">Vagrant OSX installer</a></p></li>
</ul>


<h2>Vagrant Smoke Test: run Ubuntu Precise</h2>

<p>To make sure Vagrant is installed correctly, run the following commands to see if Ubuntu Precise comes up and you are able to ssh into it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant init precise32 http://files.vagrantup.com/precise32.box
</span><span class='line'>vagrant up
</span><span class='line'>vagrant ssh</span></code></pre></td></tr></table></div></figure>


<p>If that doesn&rsquo;t work, you should probably fix it before moving on.  Otherwise, keep reading.</p>

<h2>Install/Run CoreOS</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/coreos/coreos-vagrant/
</span><span class='line'>cd coreos-vagrant
</span><span class='line'>vagrant up</span></code></pre></td></tr></table></div></figure>


<h2>SSH into CoreOS</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>vagrant ssh</span></code></pre></td></tr></table></div></figure>


<h2>Run stock ubuntu docker image</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker run -t -i ubuntu bash</span></code></pre></td></tr></table></div></figure>


<p>After running this, you should be ssh&rsquo;d inside of an Ubuntu shell, running under docker (running inside of VirtualBox .. etc, all the way up the onion)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deciphering some Go code]]></title>
    <link href="http://tleyden.github.io/blog/2013/09/20/deciphering-some-go-code/"/>
    <updated>2013-09-20T11:11:00-07:00</updated>
    <id>http://tleyden.github.io/blog/2013/09/20/deciphering-some-go-code</id>
    <content type="html"><![CDATA[<p>While trying to use <a href="http://godoc.org/code.google.com/p/dsallings-couch-go">couch-go</a> and looking at the source, I&rsquo;ve come across some things I don&rsquo;t understand.</p>

<h1>Is function wrapper needed?</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>resp, err := client.Get(full_url)
</span><span class='line'>log.Printf("resp: %v err: %v", resp, err)
</span><span class='line'>if err == nil {
</span><span class='line'>    func() {
</span><span class='line'>        defer resp.Body.Close()
</span><span class='line'>        defer conn.Close()
</span><span class='line'>
</span><span class='line'>        tc := timeoutClient{resp.Body, conn, timeout}
</span><span class='line'>        largest = handler(&tc)
</span><span class='line'>    }()
</span><span class='line'>} else {
</span><span class='line'>    log.Printf("Error in stream: %v", err)
</span><span class='line'>    time.Sleep(time.Second * 1)
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Why the separate function wrapper here?  Why not just call:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>defer resp.Body.Close()
</span><span class='line'>defer conn.Close()
</span><span class='line'>tc := timeoutClient{resp.Body, conn, timeout}
</span><span class='line'>largest = handler(&tc)</span></code></pre></td></tr></table></div></figure>


<p>directly?</p>

<h1>How to elegantly dump a request body?</h1>

<p>I was trying to debug something, and I wanted to print out the json string before it was being parsed, and here&rsquo;s what I ended up doing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>body, err0 := ioutil.ReadAll(r.Body)
</span><span class='line'>bodyStr := string(body)
</span><span class='line'>log.Printf("body: %v err: %v", bodyStr, err0)
</span><span class='line'>newBody := bytes.NewBuffer(body)
</span><span class='line'>d := json.NewDecoder(newBody)
</span><span class='line'>// d := json.NewDecoder(r.Body) &lt;-- orig code
</span><span class='line'>if err := d.Decode(results); err != nil {
</span><span class='line'>    log.Printf("Decode err: %v", err)
</span><span class='line'>    return err
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>it seems like there should be a slicker way, like maybe rewinding the r.Body Reader?</p>

<p><strong>Answer</strong>: yes, there is a <em>much</em> slicker way, <code>io.TeeReader</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>d := json.NewDecoder(io.TeeReader(r.Body, os.Stdout))</span></code></pre></td></tr></table></div></figure>


<h1>Using new() with a map &mdash; does this look right?</h1>

<p>According to &ldquo;The Way To Go&rdquo; (book), you are not supposed to be using new() with maps.  However I did this in one case:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>type Document map[string]interface{}
</span><span class='line'>
</span><span class='line'>func (game Game) fetchLatestGameDoc() (doc Document, err error) {
</span><span class='line'>        fetchedDoc := new(Document)
</span><span class='line'>        err = game.db.Retrieve(GAME_DOC_ID, fetchedDoc)
</span><span class='line'>        if err == nil {
</span><span class='line'>     doc = *fetchedDoc
</span><span class='line'>        }
</span><span class='line'>        return
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>is there a better way?  When I tried using make(), I got the error <code>err: json: Unmarshal(non-pointer checkerlution.Document)</code>.  Using make() followed by &amp; didn&rsquo;t work either.</p>

<h1>Type Assertion hell</h1>

<p>I&rsquo;m trying to get some data that&rsquo;s fairly deep in some json, and ended up doing a lot of awkward feeling type assertions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func (game Game) checkGameDocInChanges(changes Changes) bool {
</span><span class='line'>        foundGameDoc := false
</span><span class='line'>        changeResultsRaw := changes["results"]
</span><span class='line'>        changeResults := changeResultsRaw.([]interface{})
</span><span class='line'>        for _, changeResultRaw := range changeResults {
</span><span class='line'>                changeResult := changeResultRaw.(map[string]interface{})
</span><span class='line'>                docIdRaw := changeResult["id"]
</span><span class='line'>                docId := docIdRaw.(string)
</span><span class='line'>                if strings.Contains(docId, GAME_DOC_ID) {
</span><span class='line'>                        foundGameDoc = true
</span><span class='line'>              }
</span><span class='line'>        }
</span><span class='line'>        return foundGameDoc
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>there must be a better way?</p>

<p>Also I didn&rsquo;t get why this didn&rsquo;t work:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>type ChangeItem map[string]interface{}
</span><span class='line'>...
</span><span class='line'>changeResult := changeResultRaw.(ChangeItem)</span></code></pre></td></tr></table></div></figure>


<p>to make it work I had to change it to:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>changeResult := changeResultRaw.(map[string]interface{})</span></code></pre></td></tr></table></div></figure>


<h1>Getting unexpected float64 back from JSON, had to do awkward type conversions</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func (game Game) isOurTurn(gameDoc Document) bool {
</span><span class='line'>        activeTeamRaw := gameDoc["activeTeam"]
</span><span class='line'>        activeTeam := int(activeTeamRaw.(float64))
</span><span class='line'>        return activeTeam == game.ourTeamId
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Json snippet:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"_id":"game:checkers","activeTeam":0}</span></code></pre></td></tr></table></div></figure>


<h1>Can&rsquo;t check for nil</h1>

<p>I have these structs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>type Game struct {
</span><span class='line'>    gameState            GameState
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>type GameState struct {
</span><span class='line'>   ...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>and in a loop, I set the gameState field of the Game object to value.  I&rsquo;m trying to detect if it&rsquo;s the first pass through the loop with this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>isFirstGame := (game.gameState == nil)</span></code></pre></td></tr></table></div></figure>


<p>but I get the error <code>cannot convert nil to type GameState</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Java coding challenge]]></title>
    <link href="http://tleyden.github.io/blog/2013/09/19/java-coding-challenge/"/>
    <updated>2013-09-19T13:42:00-07:00</updated>
    <id>http://tleyden.github.io/blog/2013/09/19/java-coding-challenge</id>
    <content type="html"><![CDATA[<p>Write a server that uses tcp sockets which returns images to clients, and avoids duplicate work for concurrent requests for the same image.</p>

<h1>Description</h1>

<p>A server will listen for tcp client connections and generate PNG checkerboard images and return them to clients that request them.  Example checkerboard image:</p>

<p><img src="http://tleyden.github.io/images/checkerboard.png" width="295" height="105" title="image" alt="images"></p>

<p>The client will send a single parameter to the server after it opens the tcp socket connection to the server:</p>

<ul>
<li> The size of the &ldquo;checkboard image&rdquo;, which will be a single scalar value like 5, which will result in a 5x5 square, as shown above.</li>
</ul>


<p>The server will use the following default values when generating the checkerboard image:</p>

<ul>
<li> size: each square will be 60 x 60 pixels.</li>
<li> color: squares will be alternating black and white, with black for the square in the 0th row and 0th column, and white for the square in the 1st row and 0th column, etc.  Exactly as shown above.</li>
</ul>


<h1>Basic Requirements</h1>

<ul>
<li>Written in either Java or Scala</li>
<li>To generate the actual image, you can use anything you want.  The image format can be any popular image format (PNG, JPEG, GIF, etc..)</li>
<li>For the data structures required by the server, you can use any existing data structures within Java itself or a 3rd party, there is no requirement to develop your own.</li>
<li>The server will respond with the image data in PNG format, and then close the connection.</li>
</ul>


<h1>Advanced Requirements</h1>

<ul>
<li>In the method that generates the square, there must be a call to Thread.sleep(Y) before returning.  Y represents number of milliseconds to sleep, and will be a random number between 0 and 5000.</li>
<li>The server can handle multiple client requests in parallel (as opposed to handling them in serial).  In other words, if client1 contacts the server, and then client2 contacts the server a few milliseconds later, there is a chance that client2 will receive a response before client1, depending on the random sleep described above.</li>
<li>In order to avoid needlessly generating the same image twice, if the server is asked to generate a square of size X by client1, and then again asked to generate another square of size X by client2 before it has returned the square to client1, it will simply wait for the square for client1 is finished being generated and return that same square data to both client2 and client1.  Here is an example timeline to show how events would roughly be ordered:

<ul>
<li>At 12:00:00 Client1 asks for square of size 6</li>
<li>At 12:00:01 The server starts to generate the square for client1</li>
<li>At 12:00:01 Client2 asks for square of size 6 (the server does <em>not</em> try to generate a new square, since there is already a pending request for an identical square)</li>
<li>At 12:00:06 The server finishes generating the square of size 6, as originally requested by client1</li>
<li>At 12:00:07 The server returns the square to client1</li>
<li>At 12:00:07 The server returns the same square to client2</li>
</ul>
</li>
</ul>


<h1>Deliverables</h1>

<ul>
<li>server.sh &ndash; starts the server that listens on 8000</li>
<li>client.sh X &ndash; runs a client that:

<ul>
<li>connects to localhost:8000</li>
<li>passes the parameter X (the size of the checkboard image) to the server</li>
<li>reads the PNG into a file called X.png</li>
<li>prints a message to say its finished.</li>
</ul>
</li>
<li>A zip file that contains all jar file dependencies <em>or</em> a document that describes on how to download the required dependencies</li>
</ul>


<h1>Shortcuts</h1>

<p>If this feels like too much work, take the following shortcut:</p>

<ul>
<li>Rather than return an image, just create a string which would represent the image, where X represents black and O represents white.  Eg, if it was a 2x2 square, return &ldquo;X00X&rdquo;</li>
</ul>


<h1>Bonus points</h1>

<ul>
<li>Record your commits in a local git repository as you work, and submit a zip file of the repository along with the other deliverables</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Octopress Setup Part II]]></title>
    <link href="http://tleyden.github.io/blog/2013/09/07/octopress-setup-part-ii/"/>
    <updated>2013-09-07T11:46:00-07:00</updated>
    <id>http://tleyden.github.io/blog/2013/09/07/octopress-setup-part-ii</id>
    <content type="html"><![CDATA[<h1>Showing my tweets on my blog</h1>

<p>What&rsquo;s a blog without a few tweets to spice it up?</p>

<p>Here&rsquo;s my first attempt, which didn&rsquo;t work.  I modified my _config.yml file to have:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>twitter_user: tleydn</span></code></pre></td></tr></table></div></figure>


<p>After some desperate googling, I came across <a href="http://blog.jmac.org/blog/2013/03/30/putting-twitter-back-into-octopress/">this blog post</a> which seems to suggest that twitter support has been remoted from Octopress, with instructions on how to embed a twitter widget.</p>

<p>Here&rsquo;s a few tricks to make it looks slightly less butt-ugly:</p>

<ul>
<li>In the twitter widget generator, choose the &ldquo;dark&rdquo; theme.</li>
<li>Modify the widget class to have dimensions <code>width="300" height="350"</code> so that it is slightly less distracting when viewing content.</li>
</ul>


<h1>Adding an &ldquo;About&rdquo; page</h1>

<p>I followed the instructions on <a href="http://octopress.org/docs/theme/template/">Theming &amp; Customization</a>, which added an About section on the top of the sidebar on the right side.</p>

<h1>Enabling Disqus comments</h1>

<p>This was trivial:</p>

<ul>
<li>Go to <a href="http://disqus.com">Disqus</a> and register a new site</li>
<li>Add the &ldquo;shortname&rdquo; to the _config.yml file</li>
</ul>


<h1>Let&rsquo;s pimp this thing &mdash; Adding an image in the header</h1>

<ul>
<li>Open octopress/source/_includes/custom/header.html</li>
<li>Find an image graphic and save it into octopress/source/images (in my case, it was /images/rabbit_hole_graphic.png)</li>
<li>Add a new html table element, and in one cell add a link to the image with the appropriate size dimensions.</li>
</ul>


<p>Example header.html file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  &lt;table&gt;&lt;tr&gt;&lt;td&gt;
</span><span class='line'>  &lt;h1&gt;&lt;a href="{{ root_url }}/"&gt;{{ site.title }}&lt;/a&gt;&lt;/h1&gt;
</span><span class='line'>  {% if site.subtitle %}
</span><span class='line'>    &lt;h2&gt;{{ site.subtitle }}&lt;/h2&gt;
</span><span class='line'>  {% endif %}
</span><span class='line'>  &lt;/td&gt;&lt;td&gt;&nbsp;&nbsp;
</span><span class='line'>  {% img left /images/rabbit_hole_graphic.png 295 105 'image' 'images' %}
</span><span class='line'>  &lt;/td&gt;&lt;/tr&gt;
</span><span class='line'>  &lt;/table&gt;
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m not a hipster, it&rsquo;s just that my HTML coding skillz are stuck at about 1995.  If you are seething with the overwhelming urge to tell me how to do this in 2013 CSS style, go right ahead and add a comment.</p>

<p>Anyway, the end justifies the means:</p>

<p><img class="center" src="http://tleyden.github.io/images/ScreenShotBlogIIa.png" title="image" alt="images"></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Octopress Setup Part I]]></title>
    <link href="http://tleyden.github.io/blog/2013/09/07/octopress-setup-part-i/"/>
    <updated>2013-09-07T11:26:00-07:00</updated>
    <id>http://tleyden.github.io/blog/2013/09/07/octopress-setup-part-i</id>
    <content type="html"><![CDATA[<p>I&rsquo;m writing this blog entry as I&rsquo;m creating my blog.  I have decided to use <a href="http://octopress.org/">Octopress</a>, and I&rsquo;m initially going to host it on <a href="http://pages.github.com/">Github Pages</a>.</p>

<h2>Step 1: create a github pages repo</h2>

<p>In my case, I made a new repo called tleyden/tleyden.github.io.</p>

<h2>Step 2: push an index.html</h2>

<p>Clone the repo</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git clone git@github.com:tleyden/tleyden.github.io.git</span></code></pre></td></tr></table></div></figure>


<p>Add some content</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd tleyden.github.io
</span><span class='line'>$ echo "&lt;h1&gt;hello&lt;/h1&gt;" &gt; index.html</span></code></pre></td></tr></table></div></figure>


<p>Commit and push</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git add index.html
</span><span class='line'>$ git commit -m "empty blog"
</span><span class='line'>$ git push origin master</span></code></pre></td></tr></table></div></figure>


<h2>Step 3: see if it actually worked</h2>

<p>Go to <a href="http://tleyden.github.io/">http://tleyden.github.io/</a> to see if it works.</p>

<p><strong>It did not work.  WTH!?</strong></p>

<p>Oh wait, it says: <em>It may take up to ten minutes until your page is available.</em></p>

<p>Patiently hit reload 5 times / minute, and 7 minutes later .. <strong>IT WORKS!</strong></p>

<h2>Step 4: get rvm (octopress dependency)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ \curl -L https://get.rvm.io | bash
</span><span class='line'>$ source /Users/traun/.rvm/scripts/rvm
</span><span class='line'>$ rvm notes</span></code></pre></td></tr></table></div></figure>


<h2>Step 5: get ruby 1.9.3 (octopress dependency)</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm install 1.9.3
</span><span class='line'>Searching for binary rubies, this might take some time.
</span><span class='line'>No binary rubies available for: osx/10.8/x86_64/ruby-1.9.3-p448.
</span><span class='line'>Continuing with compilation. Please read 'rvm help mount' to get more information on binary rubies.
</span><span class='line'>Checking requirements for osx.
</span><span class='line'>Installing requirements for osx.
</span><span class='line'>Updating system......
</span><span class='line'>Error running 'requirements_osx_brew_update_system ruby-1.9.3-p448',
</span><span class='line'>please read /Users/traun/.rvm/log/1378534467_ruby-1.9.3-p448/update_system.log
</span><span class='line'>Requirements installation failed with status: 1.</span></code></pre></td></tr></table></div></figure>


<p>I managed to get past this error by following this <a href="http://stackoverflow.com/questions/14113427/brew-update-failed">stack overflow post</a></p>

<p>Let&rsquo;s try this again ..</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Installing required packages: gcc46, libyaml, libksba, openssl......................................................................................................</span></code></pre></td></tr></table></div></figure>


<p>45 minutes later, it finally worked.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rvm use 1.9.3
</span><span class='line'>$ rvm rubygems latest</span></code></pre></td></tr></table></div></figure>


<h2>Step 6: get octopress</h2>

<p>Follow the <a href="http://octopress.org/docs/setup/">Setup Ocotpress</a> instructions</p>

<h2>Step 7: recreate repo</h2>

<p>So this is a little <em>awkward</em>, and looking back I wish I hadn&rsquo;t pushed that index.html earlier, because it interferes with the github push in the next step.</p>

<ul>
<li>Delete your entire github repository: <code>username/username.github.io</code></li>
<li>Create a new empty github repository: <code>username/username.github.io</code></li>
</ul>


<h2>Step 8: deploy to github pages</h2>

<p>Follow the <a href="http://octopress.org/docs/deploying/github/">Deploy to Github pages</a> instructions.</p>

<p>There is one step that is crucial if you don&rsquo;t want to accidentally lose your blog content:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git add .
</span><span class='line'>git commit -m 'your message'
</span><span class='line'>git push origin source</span></code></pre></td></tr></table></div></figure>


<p>After doing that, your github repo should have two branches:</p>

<ul>
<li>Master: the &ldquo;published blog&rdquo; goes here, and will have a top-level index.html</li>
<li>Source: the entire octopress source tree, plus a &ldquo;source&rdquo; and &ldquo;sass&rdquo; directory.  The &ldquo;source&rdquo; directory is where your blog markdown content will actually live.</li>
</ul>


<h2>Step 9: write a blog entry</h2>

<p>Follow the <a href="http://octopress.org/docs/blogging/">New blog post</a> instructions.</p>

<h2>Step 10: re-deploy</h2>

<p>From the last step in the <a href="http://octopress.org/docs/deploying/github/">Deploy to Github pages</a> instructions, do the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rake generate
</span><span class='line'>$ rake deploy</span></code></pre></td></tr></table></div></figure>


<h2>Step 11: revel in it&rsquo;s beauty</h2>

<p><img src="http://cl.ly/image/1e2x3I293X3w/Screen%20Shot%202013-09-07%20at%2012.21.57%20AM.png" alt="screenshot" /></p>

<h2>Step 12: Oops, don&rsquo;t forget to push the source changes!</h2>

<p>Even though the blog content is deployed (eg, your master branch with your content has been pushed to github), the source is still sitting on your computer.  If your hard drive crashes, you&rsquo;ll lose your markdown, which is no fun.</p>

<p>Here&rsquo;s how to push the latest changes of your source files up to github:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git add .
</span><span class='line'>git commit -m 'I just added a new blog entry'
</span><span class='line'>git push origin source</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>

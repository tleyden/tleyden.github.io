
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Seven Story Rabbit Hole</title>
  <meta name="author" content="Traun Leyden">

  
  <meta name="description" content="Create a beautiful Grafana dashboard with realtime performance stats: Install InfluxDB and Grafana 1
2
3
4
brew install influxdb grafana telegraf &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tleyden.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Seven Story Rabbit Hole" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>

  <table><tr><td>
  <h1><a href="/">Seven Story Rabbit Hole</a></h1>
  
    <h2>Sometimes awesome things happen in deep rabbit holes.  Or not.</h2>
  
  </td><td>&nbsp;&nbsp;
  <img class="left" src="/images/rabbit_hole_graphic.png" width="132" height="105" title="image" alt="images">
  </td></tr>
  </table>

</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tleyden.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/12/configuring-influxdb-and-grafana-with-go-client-library/">Configuring InfluxDB and Grafana With Go Client Library</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-09-12T15:14:00-07:00" pubdate data-updated="true">Sep 12<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Create a beautiful Grafana dashboard with realtime performance stats:</p>

<p><img src="https://cloud.githubusercontent.com/assets/296876/18493836/730085b0-79c7-11e6-9236-50dd3d4c72d4.png" alt="screen shot 2016-09-13 at 3 33 20 pm" /></p>

<h2>Install InfluxDB and Grafana</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew install influxdb grafana telegraf
</span><span class='line'>brew services start influxdb
</span><span class='line'>brew services start grafana
</span><span class='line'>brew services start telegraf</span></code></pre></td></tr></table></div></figure>


<p>Versions at the time of this writing:</p>

<ul>
<li>InfluxDB: 1.0</li>
<li>Grafana: 3.1.1</li>
</ul>


<h2>Verify</h2>

<ul>
<li>The Grafana Web UI should be available at <a href="http://localhost:3000/">localhost:3000</a> &mdash; login with admin/admin</li>
<li>The InfluxDB Web UI should be available at <a href="http://localhost:8083/">localhost:8083</a></li>
</ul>


<h2>Create database on influx</h2>

<p>Create db named &ldquo;db&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ influx
</span><span class='line'>&gt; create database db</span></code></pre></td></tr></table></div></figure>


<h2>Edit telegraf conf</h2>

<p>Uncomment the entire statsd server section:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Statsd Server
</span><span class='line'>[[inputs.statsd]]
</span><span class='line'>  ## Address and port to host UDP listener on
</span><span class='line'>  service_address = ":8125"
</span><span class='line'>
</span><span class='line'>  .. etc .. </span></code></pre></td></tr></table></div></figure>


<p>Set the database to use the &ldquo;db&rdquo; database created earlier, under the <code>outputs.influxdb</code> section of the telegraf config</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[[outputs.influxdb]]
</span><span class='line'>  ## The full HTTP or UDP endpoint URL for your InfluxDB instance.
</span><span class='line'>  ## Multiple urls can be specified as part of the same cluster,
</span><span class='line'>  ## this means that only ONE of the urls will be written to each interval.
</span><span class='line'>  # urls = ["udp://localhost:8089"] # UDP endpoint example
</span><span class='line'>  urls = ["http://localhost:8086"] # required
</span><span class='line'>  ## The target database for metrics (telegraf will create it if not exists).
</span><span class='line'>  database = "db" # required</span></code></pre></td></tr></table></div></figure>


<h2>Restart telegraf</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>brew services restart telegraf</span></code></pre></td></tr></table></div></figure>


<h2>Create Grafana Data Source</h2>

<ul>
<li>Open the <a href="http://localhost:3000/">Grafana Web UI</a> in your browsers (login with admin/admin)</li>
<li>Use the following values:</li>
</ul>


<p><img src="https://cloud.githubusercontent.com/assets/296876/18494027/a87adcf8-79c8-11e6-912b-a5e5a82dad14.png" alt="screen shot 2016-09-13 at 3 39 43 pm" /></p>

<h2>Create Grafana Dashboard</h2>

<ul>
<li>Go to Dashboards / + New</li>
<li>Click the green thing on the left, and choose Add Panel / Graph</li>
</ul>


<p><img src="https://cloud.githubusercontent.com/assets/296876/18494074/f230784e-79c8-11e6-9ab0-bc284b9e01f5.png" alt="screen shot 2016-09-13 at 3 43 50 pm" /></p>

<ul>
<li>Delete the test metric, which is not needed, by clicking the trash can to the right of &ldquo;Test Metric&rdquo;</li>
</ul>


<p><img src="https://cloud.githubusercontent.com/assets/296876/18494109/1a927152-79c9-11e6-98f9-f338549ee3d9.png" alt="screen shot 2016-09-13 at 3 45 04 pm" /></p>

<ul>
<li>Under Panel / Datasource, choose <strong>db</strong>, and then hit <strong>+ Add Query</strong>, you will end up with this</li>
</ul>


<p><img src="https://cloud.githubusercontent.com/assets/296876/18494180/7b8f9570-79c9-11e6-93c0-3f721d93002a.png" alt="screen shot 2016-09-13 at 3 47 21 pm" /></p>

<h2>Push sample data point from command line</h2>

<p>In order for the field we want to show up on the grafana dashboard, we need to push some data points to the telegraf statds daemon.</p>

<p>Run this in a shell to push the <code>foo:1|c</code> data point, which is a counter with value increasing by 1 on the key named &ldquo;foo&rdquo;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>while true; do echo "foo:1|c" | nc -u -w0 127.0.0.1 8125; sleep 1; echo "pushed data point"; done</span></code></pre></td></tr></table></div></figure>


<h2>Create Grafana Dashboard, Part 2</h2>

<ul>
<li>Under <strong>select measurement</strong>, choose <strong>foo</strong> from the pulldown</li>
<li>On the top right of the screen near the clock icon, choose &ldquo;Last 5 minutes&rdquo; and set <strong>Refreshing every</strong> to 5 seconds</li>
<li>You should see your data point counter being increased!</li>
</ul>


<p><img src="https://cloud.githubusercontent.com/assets/296876/18494256/f45fe55e-79c9-11e6-9663-abf9db7e7299.png" alt="screen shot 2016-09-13 at 3 51 16 pm" /></p>

<h2>Add Go client library and push data points</h2>

<p>Here&rsquo;s how to update to your <code>golang</code> application to push new datapoints.</p>

<ul>
<li>Install the <a href="github.com/peterbourgon/g2s">g2s</a> client library via:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go get github.com/peterbourgon/g2s</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Here is some sample code to push data points to the <code>statds</code> telegraf process from your go program:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>statdsClient, err := g2s.Dial("udp", "http://localhost:8125")
</span><span class='line'>if err != nil {
</span><span class='line'>  panic("Couldn't connect to statsd!")
</span><span class='line'>}
</span><span class='line'>req, err := http.NewRequest("GET", "http://waynechain.com/")
</span><span class='line'>resp, err := http.DefaultClient.Do(req)
</span><span class='line'>if err != nil {
</span><span class='line'>  return err
</span><span class='line'>}
</span><span class='line'>s.StatsdClient.Timing(1.0, "get_google_homepage", time.Since(startTime))</span></code></pre></td></tr></table></div></figure>


<p>This will push statsd &ldquo;timing&rdquo; data points under the key &ldquo;get_google_homepage&rdquo;, with the normal sample rate (set to 0.1 to downsample and only take every 10th sample).  Run the code in a loop and it will start pushing stats to <code>statsd</code>.</p>

<p>Now, create a new Grafana dashboard with the steps above, but from the <strong>select measurement</strong> field choose <strong>get_google_homepage</strong>, and under <strong>SELECT</strong> choose <strong>field (mean)</strong> instead of <strong>field (value)</strong>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/05/19/go-race-detector-gotcha-with-value-receivers/">Go Race Detector Gotcha With Value Receivers</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-05-19T23:06:00-07:00" pubdate data-updated="true">May 19<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I ran into the following race detector error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>WARNING: DATA RACE
</span><span class='line'>Write by goroutine 44:
</span><span class='line'>  github.com/couchbaselabs/sg-replicate.stateFnActiveFetchCheckpoint()
</span><span class='line'>      /Users/tleyden/Development/gocode/src/github.com/couchbaselabs/sg-replicate/replication_state.go:53 +0xb1d
</span><span class='line'>  github.com/couchbaselabs/sg-replicate.(*Replication).processEvents()
</span><span class='line'>      /Users/tleyden/Development/gocode/src/github.com/couchbaselabs/sg-replicate/synctube.go:120 +0xa3
</span><span class='line'>
</span><span class='line'>Previous read by goroutine 27:
</span><span class='line'>  github.com/couchbaselabs/sg-replicate.(*Replication).GetStats()
</span><span class='line'>      &lt;autogenerated&gt;:24 +0xef
</span><span class='line'>  github.com/couchbase/sync_gateway/base.(*Replicator).populateActiveTaskFromReplication()
</span><span class='line'>      /Users/tleyden/Development/gocode/src/github.com/couchbase/sync_gateway/base/replicator.go:241 +0x145</span></code></pre></td></tr></table></div></figure>


<p>Goroutine 44 was running this code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func (r *Replication) shutdownEventChannel() {
</span><span class='line'>  r.EventChan = nil
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>and nil&#8217;ing out the r.EventChan field.</p>

<p>While goroutine 27 was calling this code on the same <code>*Replication</code> instance:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func (r Replication) GetStats() ReplicationStats {
</span><span class='line'>  return r.Stats
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>It didn&rsquo;t make sense, because they were accessing different fields of the <code>Replication</code> &mdash; one was writing to <code>r.EventChan</code> while the other was reading from <code>r.Stats</code>.</p>

<p>Then I changed the <code>GetStats()</code> method to this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func (r Replication) GetStats() ReplicationStats {
</span><span class='line'>  return ReplicationStats{}
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>and it still failed!</p>

<p>I started wandering around the Couchbase office looking for help, and got <a href="https://twitter.com/steveyentweets">Steve Yen</a> to help me.</p>

<p>He was asking me about using a pointer receiver vs a value receiver here, and then we realized that by using a value reciever it was <em>copying</em> all the fields, and therefore <strong>reading</strong> all of the fields, including the <code>r.EventChan</code> field that the other goroutine was concurrently writing to!  Hence, the data race that was subtly caused by using a value receiver..</p>

<p>The fix was to convert this over to a pointer reciever, and the data race disappeared!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func (r *Replication) GetStats() ReplicationStats {
</span><span class='line'>     return r.Stats
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/15/setting-up-a-self-hosted-drone-dot-io-ci-server/">Setting Up a Self-hosted drone.io CI Server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-15T19:37:00-08:00" pubdate data-updated="true">Feb 15<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Spin up AWS server</h2>

<ul>
<li>Ubuntu Server 14.04 LTS (HVM), SSD Volume Type &ndash; ami-fce3c696</li>
<li>m3.medium</li>
<li>250MB magnetic storage</li>
</ul>


<h2>Install docker</h2>

<p><code>ssh ubuntu@&lt;aws-instance&gt;</code> and <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/">install docker</a></p>

<h2>Register github application</h2>

<p>Go to github and <a href="https://github.com/settings/applications/new">register</a> a new OAuth application using the following values:</p>

<ul>
<li><strong>Application name</strong> Couchbase Mobile Drone CI</li>
<li><strong>Homepage URL</strong> <a href="http://ec2-54-163-185-45.compute-1.amazonaws.com">http://ec2-54-163-185-45.compute-1.amazonaws.com</a></li>
<li><strong>Application description</strong> Couchbase Mobile Drone CI</li>
<li><strong>Authorization callback URL</strong> <a href="http://ec2-54-163-185-45.compute-1.amazonaws.com/authorize">http://ec2-54-163-185-45.compute-1.amazonaws.com/authorize</a></li>
</ul>


<p>It will give you a <strong>Client ID</strong> and <strong>Client Secret</strong></p>

<h2>Create <code>/etc/drone/dronerc</code> config file</h2>

<p>On the ubuntu host:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir /etc/drone
</span><span class='line'>$ emacs /etc/drone/dronerc</span></code></pre></td></tr></table></div></figure>


<p><strong>Configure Remote Driver</strong></p>

<p>Add these values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>REMOTE_DRIVER=github
</span><span class='line'>REMOTE_CONFIG=https://github.com?client_id=${client_id}&client_secret=${client_secret}</span></code></pre></td></tr></table></div></figure>


<p>and replace <code>client_id</code> and <code>client_secret</code> with the values returned from github.</p>

<p><strong>Configure Database</strong></p>

<p>Add these values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>DATABASE_DRIVER=sqlite3
</span><span class='line'>DATABASE_CONFIG=/var/lib/drone/drone.sqlite</span></code></pre></td></tr></table></div></figure>


<h2>Run Docker container</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo docker run \
</span><span class='line'>  --volume /var/lib/drone:/var/lib/drone \
</span><span class='line'>  --volume /var/run/docker.sock:/var/run/docker.sock \
</span><span class='line'>  --env-file /etc/drone/dronerc \
</span><span class='line'>  --restart=always \
</span><span class='line'>  --publish=80:8000 \
</span><span class='line'>  --detach=true \
</span><span class='line'>  --name=drone \
</span><span class='line'>  drone/drone:0.4</span></code></pre></td></tr></table></div></figure>


<p>Check the logs via <code>docker logs &lt;container-id&gt;</code> and they should look something like <a href="https://gist.github.com/tleyden/db0a894c30b4811a5deb">this</a></p>

<h2>Edit AWS security group</h2>

<p>With your instance selected, look for the security groups in the instance details:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_setup_security_group.png" alt="screenshot" /></p>

<p>Add a new inbound port with the following settings:</p>

<ul>
<li><strong>Protocol</strong> TCP</li>
<li><strong>Port Range</strong> 80</li>
<li><strong>Source</strong> 0.0.0.0</li>
</ul>


<p>It should look like this when you&rsquo;re done:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_setup_security_group2.png" alt="screenshot" /></p>

<h2>Verify it&rsquo;s running</h2>

<p>Paste the hostname of your aws instance into your browser (eg, <code>http://ec2-54-163-185-45.compute-1.amazonaws.com</code>), and you should see a page like this:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_login_screen.png" alt="screenshot" /></p>

<h2>Login</h2>

<p>If you click the login button, you should see:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_github_authorize.png" alt="screenshot" /></p>

<p>And then:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_post_github_login.png" alt="screenshot" /></p>

<h2>Activate a repository</h2>

<p>Click one of the repositories you have access to, and you should get an &ldquo;activate now&rdquo; option:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_activate_now.png" alt="screenshot" /></p>

<p>which will take you to your project home screen:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_project_home.png" alt="screenshot" /></p>

<h2>Add a <code>.drone.yml</code> file to the root of the repository</h2>

<p>In the repository you have chosen (in my case I&rsquo;m using <code>tleyden/sync_gateway</code>, which is a golang project, and may refer to it later), add a <code>.drone.yml</code> file to the root of the repository with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>build:
</span><span class='line'>  image: golang
</span><span class='line'>  commands:
</span><span class='line'>    - go get
</span><span class='line'>    - go build
</span><span class='line'>    - go test</span></code></pre></td></tr></table></div></figure>


<p>Commit your change, but do not push to github yet, that will be in the next step.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git add .drone.yml
</span><span class='line'>$ git commit -m "Add drone.yml"</span></code></pre></td></tr></table></div></figure>


<h2>Kickoff a build</h2>

<p>Now push your change up to github.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git push origin master</span></code></pre></td></tr></table></div></figure>


<p>and in your drone UI you should see a build in progress:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_build_running.png" alt="screenshot" /></p>

<p>when it finishes, you&rsquo;ll see either a pass or a failure.  If you get a failure (which I did), it will look like this:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_build_failure.png" alt="screenshot" /></p>

<h2>Manually triggering another build</h2>

<p>In my case, the above failure was due to a dependency not building.  Since nothing else needs to be pushed to the repo to fix the build, I&rsquo;m just going to manually trigger a build.</p>

<p>On the build failure screen above, there is a <strong>Restart</strong> button, which triggers a new build.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/drone_build_success.png" alt="screenshot" /></p>

<p>Now it works!</p>

<h2>Setup the Drone CLI</h2>

<p>I could run this on my OSX workstation, but I decided to run this on a linux docker container.  The rest of the steps assume you have spun up and are inside a linux docker container.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://downloads.drone.io/drone-cli/drone_linux_amd64.tar.gz | tar zx
</span><span class='line'>$ install -t /usr/local/bin drone</span></code></pre></td></tr></table></div></figure>


<p>Go to your Profile page in the drone UI, and click <strong>Show Token</strong>.</p>

<p>Now set these environment variables</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export DRONE_SERVER=http://ec2-54-163-185-45.compute-1.amazonaws.com
</span><span class='line'>$ export DRONE_TOKEN=eyJhbGci...</span></code></pre></td></tr></table></div></figure>


<p><strong>Query repos</strong></p>

<p>To test the CLI tool works, try the following commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># drone repo ls
</span><span class='line'>couchbase/sync_gateway
</span><span class='line'>tleyden/sync_gateway
</span><span class='line'># drone repo info tleyden/sync_gateway
</span><span class='line'>tleyden/sync_gateway</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/08/adding-vendoring-to-a-go-project/">Adding Vendoring to a Go Project</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-08T22:49:00-08:00" pubdate data-updated="true">Feb 8<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Install gvt</h2>

<p>After doing some research, I decided to try <code>gvt</code> since it seemed simple and well documented, and integrated well with exiting tools like <code>go get</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export GO15VENDOREXPERIMENT=1
</span><span class='line'>$ go get -u github.com/FiloSottile/gvt</span></code></pre></td></tr></table></div></figure>


<h2>Go get target project to be updated</h2>

<p>I&rsquo;m going to update <a href="https://github.com/tleyden/todolite-appserver">todolite-appserver</a> to use vendored dependencies for <em>some</em> of it&rsquo;s dependencies, just to see how things go.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go get -u github.com/tleyden/todolite-appserver</span></code></pre></td></tr></table></div></figure>


<h2>Vendor dependencies</h2>

<p>I&rsquo;m going to vendor the dependency on <a href="github.com/alecthomas/kingpin">kingpin</a> since it has transitive dependencies of it&rsquo;s own (github.com/alecthomas/units, etc).  <code>gvt</code> handles this by automatically pulling all of the transitive dependencies.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gvt fetch github.com/alecthomas/kingpin</span></code></pre></td></tr></table></div></figure>


<p>Now my directory structure looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>├── main.go
</span><span class='line'>└── vendor
</span><span class='line'>    ├── github.com
</span><span class='line'>    │   └── alecthomas
</span><span class='line'>    ├── gopkg.in
</span><span class='line'>    │   └── alecthomas
</span><span class='line'>    └── manifest</span></code></pre></td></tr></table></div></figure>


<p>Here is the <a href="https://gist.github.com/tleyden/60328c7e0fd778970314">manifest</a></p>

<p><code>gvt list</code> shows the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$  gvt list
</span><span class='line'>github.com/alecthomas/kingpin  https://github.com/alecthomas/kingpin  master 46aba6af542541c54c5b7a71a9dfe8f2ab95b93a
</span><span class='line'>github.com/alecthomas/template https://github.com/alecthomas/template master 14fd436dd20c3cc65242a9f396b61bfc8a3926fc
</span><span class='line'>github.com/alecthomas/units    https://github.com/alecthomas/units    master 2efee857e7cfd4f3d0138cc3cbb1b4966962b93a
</span><span class='line'>gopkg.in/alecthomas/kingpin.v2 https://gopkg.in/alecthomas/kingpin.v2 master 24b74030480f0aa98802b51ff4622a7eb09dfddd</span></code></pre></td></tr></table></div></figure>


<h2>Verify it&rsquo;s using the vendor folder</h2>

<p>I opened up the <code>vendor/github.com/alecthomas/kingpin/global.go</code> and made the following change:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// Errorf prints an error message to stderr.
</span><span class='line'>func Errorf(format string, args ...interface{}) {
</span><span class='line'>  fmt.Println("CALLED IT!!")
</span><span class='line'>  CommandLine.Errorf(format, args...)
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Now verify that code is getting compiled and run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ go run main.go changesfollower
</span><span class='line'>CALLED IT!!
</span><span class='line'>main: error: URL is empty</span></code></pre></td></tr></table></div></figure>


<p>(note: <code>export GO15VENDOREXPERIMENT=1</code> is still in effect in my shell)</p>

<h2>Restore the dependency</h2>

<p>Before I check in the <code>vendor</code> directory to git, I want to reset it to it&rsquo;s previous state before I made the above change to the <code>global.go</code> source file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gvt restore</span></code></pre></td></tr></table></div></figure>


<p>Now if I open <code>global.go</code> again, it&rsquo;s back to it&rsquo;s original state.  Nice!</p>

<h2>Add the vendor folder and push</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ git add vendor
</span><span class='line'>$ git commit -m "..."
</span><span class='line'>$ git push origin master</span></code></pre></td></tr></table></div></figure>


<p>Also, I updated the README to tell users to set the <code>GO15VENDOREXPERIMENT=1</code> variable:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export GO15VENDOREXPERIMENT=1
</span><span class='line'>$ go get -u github.com/tleyden/todolite-appserver
</span><span class='line'>$ todolite-appserver --help</span></code></pre></td></tr></table></div></figure>


<p>but the instructions otherwise remained the same.  If someone tries to use this but forgets to set <code>GO15VENDOREXPERIMENT=1</code> in Go 1.5, it will still work, it will just use the kingpin dependency in the <code>$GOPATH</code> rather than the <code>vendor/</code> directory.  Ditto for someone using go 1.4 or earlier.</p>

<h2>Removing a vendored dependency</h2>

<p>As it turns out, I don&rsquo;t even need kingpin in this project, since I&rsquo;m using <a href="https://github.com/spf13/cobra">cobra</a>.  The kingpin dependency was caused by some leftover code I forgot to cleanup.</p>

<p>To remove it, I ran:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gvt delete github.com/alecthomas/kingpin
</span><span class='line'>$ gvt delete github.com/alecthomas/template
</span><span class='line'>$ gvt delete github.com/alecthomas/units
</span><span class='line'>$ gvt delete gopkg.in/alecthomas/kingpin.v2</span></code></pre></td></tr></table></div></figure>


<p>In this case, since it was my only dependency, it was easy to identify the transitive dependencies.  In general though it looks like it&rsquo;s up to you as a user to track down which ones to remove.  I filed <a href="https://github.com/FiloSottile/gvt/issues/16">gvt issue 16</a> to hopefully address that.</p>

<h2>Editor annoyances</h2>

<p>I have emacs setup using the <a href="http://tleyden.github.io/blog/2014/05/22/configure-emacs-as-a-go-editor-from-scratch/">steps in this blog post</a>, and I&rsquo;m running into the following annoyances:</p>

<ul>
<li>When I use <code>godef</code> to jump into the code of vendored dependency, it takes me to source code that lives in the <code>GOPATH</code>, which might be <em>different</em> than what&rsquo;s under <code>vendor/</code>.  Also, if I edit it there, my changes won&rsquo;t be reflected when I rebuild.</li>
<li>I usually search for things in the project via <code>M-x rgrep</code>, but now it&rsquo;s searching through every repo under <code>vendor/</code> and returning things I&rsquo;m not interested in .. since most of the time I only want to search within my project.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/07/configure-emacs-as-a-go-editor-from-scratch-part-3/">Configure Emacs as a Go Editor From Scratch Part 3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-07T04:25:00-08:00" pubdate data-updated="true">Feb 7<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a continuation from <a href="http://tleyden.github.io/blog/2014/05/27/configure-emacs-as-a-go-editor-from-scratch-part-2/">a previous blog post</a>.  In this post I&rsquo;m going to focus on making emacs look a bit better.</p>

<p>Currently:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/emacs_ugly.png" alt="screenshot" /></p>

<h2>Install a nicer theme</h2>

<p>I like the <code>taming-mr-arneson-theme</code>, so let&rsquo;s install that one.  Feel free to browse the emacs themes and find one that you like more.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ `mkdir ~/.emacs.d/color-themes`
</span><span class='line'>$ `wget https://raw.githubusercontent.com/emacs-jp/replace-colorthemes/d23b086141019c76ea81881bda00fb385f795048/taming-mr-arneson-theme.el`</span></code></pre></td></tr></table></div></figure>


<p>Update your <code>~/emacs.d/init.el</code> to add the following lines to the top of the file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(add-to-list 'custom-theme-load-path "/Users/tleyden/.emacs.d/color-themes/")
</span><span class='line'>(load-theme 'taming-mr-arneson t)</span></code></pre></td></tr></table></div></figure>


<p>Now when you restart emacs it should look like this:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/emacs_taming_mr_arneson.png" alt="screenshot" /></p>

<p> ## Directory Tree</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd ~/DevLibraries
</span><span class='line'>$ git clone https://github.com/jaypei/emacs-neotree.git neotree</span></code></pre></td></tr></table></div></figure>


<p>Update your <code>~/emacs.d/init.el</code> to add the following lines:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(add-to-list 'load-path "/some/path/neotree")
</span><span class='line'>(require 'neotree)</span></code></pre></td></tr></table></div></figure>


<p>Open a <code>.go</code> file and the enter <code>M-x neotree-dir</code> to show a directory browser:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/emacs-neotree.png" alt="screnshot" /></p>

<p>Ref: <a href="http://www.emacswiki.org/emacs/NeoTree">NeoTree</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/06/octopress-under-docker/">Octopress Under Docker</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-06T05:38:00-08:00" pubdate data-updated="true">Feb 6<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m setting up a clean install of El Capitan, and want to get my Octopress blog going.  However, I don&rsquo;t want to install it <em>directly</em> on my OSX workstation &mdash; I want to have it <em>contained</em> in a docker container.</p>

<h2>Install Docker</h2>

<p>That&rsquo;s beyond the scope of this blog post, but what I ended up doing on my new OSX installation was to:</p>

<ul>
<li>Install VirtualBox 5.0.14</li>
<li>Install <a href="https://www.docker.com/products/docker-toolbox">docker toolbox</a></li>
</ul>


<h2>Run tleyden5iwx/octopress</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run -itd -v ~/Documents/blog/:/blog tleyden5iwx/octopress /bin/bash</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s in <code>~/Documents/blog/</code>?  Basically, the octopress instance I&rsquo;d setup as described in <a href="http://tleyden.github.io/blog/2013/09/07/octopress-setup-part-i/">Octopress Setup Part I</a>.</p>

<h2>Bundle install</h2>

<p>From inside the docker container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cd /blog/octopress
</span><span class='line'># bundle install</span></code></pre></td></tr></table></div></figure>


<h2>Edit a blog post</h2>

<p>On OSX, open up <code>~/Documents/blog/source/_posts/path-to-post</code> and make some minor edits</p>

<h2>Push source</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># git push origin source
</span><span class='line'>Username for 'https://github.com': [enter your username]
</span><span class='line'>Password for 'https://username@github.com': [enter your password]</span></code></pre></td></tr></table></div></figure>


<h2>Generate and push to master</h2>

<p><strong>Attempt 1</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># rake generate
</span><span class='line'>rake aborted!
</span><span class='line'>Gem::LoadError: You have already activated rake 10.4.2, but your Gemfile requires rake 0.9.6. Using bundle exec may solve this.
</span><span class='line'>/blog/octopress/Rakefile:2:in `&lt;top (required)&gt;'
</span><span class='line'>(See full trace by running task with --trace) </span></code></pre></td></tr></table></div></figure>


<p>I have no idea why this is happening, but I just conceded defeat against these ruby weirdisms, wished I was using Go (and thought about converting my blog to Hugo), and took their advice and prefixed every command thereafter with <code>bundle exec</code>.</p>

<p><strong>Attempt 2</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># bundle exec rake generate && bundle exec rake deploy
</span><span class='line'>Username for 'https://github.com': [enter your username]
</span><span class='line'>Password for 'https://username@github.com': [enter your password]</span></code></pre></td></tr></table></div></figure>


<p>Success!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/03/setting-up-uniqush-with-apns/">Setting Up Uniqush With APNS</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-03T08:47:00-08:00" pubdate data-updated="true">Feb 3<span>rd</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This walks you through running <a href="http://uniqush.org/index.html">Uniqush</a> in the cloud (under Docker) and setting up an iOS app to receive messages via APNS (Apple Push Notification Service).</p>

<h2>Run Uniqush under Docker</h2>

<h3>Install Docker components</h3>

<ul>
<li><a href="https://docs.docker.com/v1.8/installation/mac/">Install docker</a></li>
<li><a href="https://docs.docker.com/compose/install/">Install docker-compose</a></li>
</ul>


<h3>Config</h3>

<ul>
<li><code>mkdir -p volumes/uniqush</code></li>
<li><code>wget https://git.io/vgSYM -O volumes/uniqush/uniqush-push.conf</code></li>
</ul>


<p>Security note: the above config has Uniqush listening on all interfaces, but depending on your setup you probably want to change that to <code>localhost</code> or something more restrictive.</p>

<h3>Docker compose file</h3>

<p>Copy and paste this content into <code>docker-compose.yml</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>version: '2'
</span><span class='line'>
</span><span class='line'>services:
</span><span class='line'>  uniqush:
</span><span class='line'>    container_name: uniqush
</span><span class='line'>    ports:
</span><span class='line'>      - "9898:9898"
</span><span class='line'>    image: tleyden5iwx/uniqush
</span><span class='line'>    entrypoint: uniqush-push
</span><span class='line'>    links:
</span><span class='line'>      - redis
</span><span class='line'>    volumes:
</span><span class='line'>      - ~/docker/volumes/uniqush/uniqush-push.conf:/etc/uniqush/uniqush-push.conf
</span><span class='line'>  redis:
</span><span class='line'>    container_name: redis
</span><span class='line'>    image: redis
</span></code></pre></td></tr></table></div></figure>


<h3>Start docker containers</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker compose up -d</span></code></pre></td></tr></table></div></figure>


<h3>Verify Uniqush is running</h3>

<p>Run this <code>curl</code> command outside of the docker container to verify that Uniqush is responding to HTTP requests:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl localhost:9898/version
</span><span class='line'>uniqush-push 1.5.2</span></code></pre></td></tr></table></div></figure>


<h2>Create APNS certificate</h2>

<p>In my case, I already had an app id for my app (<code>com.couchbase.todolite</code>), but push notifications are not enabled, so I needed to enable them:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/todolite_app_settings.png" alt="screenshot" /></p>

<p>Create a new push cert:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/create_new_push_cert.png" alt="screenshot" /></p>

<p>Choose the correct app id:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/choose_app_id.png" alt="screenshot" /></p>

<p>Generate CSR according to instructions in keychain:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/create_csr.png" alt="screenshot" /></p>

<p>This will save a CSR on your file system, and the next wizard step will ask you to upload this CSSR and generate the certificate.  Now you can download it:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/download_cert.png" alt="screenshot" /></p>

<p>Double click the downloaded cert and it will be added to your keychain.</p>

<p>This is where I got a bit confused, since I had to <em>also</em> download the cert from the app id section &mdash; go to the app id and hit &ldquo;Edit&rdquo;, then download the cert and double click it to add to your keychain.  (I&rsquo;m confused because I thought these were the same certs and this second step felt redundant)</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/download_app_id_cert.png" alt="screenshot" /></p>

<h2>Create and use provisioning profile</h2>

<p>Go to the <strong>Provisioning Profiles / Development</strong> section and hit the &ldquo;+&rdquo; button:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/create_provisioning_profile.png" alt="screenshot" /></p>

<p>Choose all certs and all devices, and then give your provisioning profile an easy to remember name.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/create_provisioning_profile_2.png" alt="screenshot" /></p>

<p>Download this provisioning profile and double click it to install it.</p>

<p>In xcode under <strong>Build Settings</strong>, choose this provisioning profile:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/xcode_choose_provisioning_profile.png" alt="screenshot" /></p>

<h2>Register for push notifications in your app</h2>

<p>Add the following code to your <code>didFinishLaunchingWithOptions:</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
</span><span class='line'>    
</span><span class='line'>    // Register for push notifications
</span><span class='line'>    if ([application respondsToSelector:@selector(isRegisteredForRemoteNotifications)])
</span><span class='line'>    {
</span><span class='line'>        // iOS 8 Notifications
</span><span class='line'>        [application registerUserNotificationSettings:[UIUserNotificationSettings settingsForTypes:(UIUserNotificationTypeSound | UIUserNotificationTypeAlert | UIUserNotificationTypeBadge) categories:nil]];
</span><span class='line'>        
</span><span class='line'>        [application registerForRemoteNotifications];
</span><span class='line'>    }
</span><span class='line'>    else
</span><span class='line'>    {
</span><span class='line'>        // iOS &lt; 8 Notifications
</span><span class='line'>        [application registerForRemoteNotificationTypes:
</span><span class='line'>         (UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeSound)];
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // rest of your code goes here ...
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>And the following callback methods which will be called if remote notification is successful:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)application:(UIApplication *)app didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken
</span><span class='line'>{
</span><span class='line'>    
</span><span class='line'>    NSString *deviceTokenStr = [NSString stringWithFormat:@"%@",deviceToken];
</span><span class='line'>    NSLog(@"didRegisterForRemoteNotificationsWithDeviceToken, Device token: %@", deviceTokenStr);
</span><span class='line'>    
</span><span class='line'>    NSString* deviceTokenCleaned = [[[[deviceToken description]
</span><span class='line'>                                      stringByReplacingOccurrencesOfString: @"&lt;" withString: @""]
</span><span class='line'>                                     stringByReplacingOccurrencesOfString: @"&gt;" withString: @""]
</span><span class='line'>                                    stringByReplacingOccurrencesOfString: @" " withString: @""];
</span><span class='line'>    
</span><span class='line'>     NSLog(@"didRegisterForRemoteNotificationsWithDeviceToken, Cleaned device token token: %@", deviceTokenCleaned);
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>and this callback which will be called if it&rsquo;s not unsuccessful:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (void)application:(UIApplication *)app didFailToRegisterForRemoteNotificationsWithError:(NSError *)err
</span><span class='line'>{
</span><span class='line'>    NSString *str = [NSString stringWithFormat: @"Error: %@", err];
</span><span class='line'>    NSLog(@"Error registering device token.  Push notifications will not work%@", str);
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>If you now run this app on a simulator, you can expect an error like <code>Error registering device token.  Push notifications will not workError</code>.</p>

<p>Run the app on a device you should see a popup dialog in the app asking if it&rsquo;s OK to receive push notifications, and the following log messages in the xcode console:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>didRegisterForRemoteNotificationsWithDeviceToken, Device token: &lt;281c8710 1b029fdb 16c8e134 39436336 116001ce bf6519e6 8edefab5 23dab4e9&gt;
</span><span class='line'>didRegisterForRemoteNotificationsWithDeviceToken, Cleaned device token token: 281c87101b029fdb16c8e13439436336116001cebf6519e68edefab523dab4e9</span></code></pre></td></tr></table></div></figure>


<h2>Export APNS keys to .PEM format</h2>

<p>Open keychain, select the <code>login</code> keychain and the <code>My Certificates</code> category:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/export_cert_keychain.png" alt="screenshot" /></p>

<ul>
<li>Right click on the certificate (not the private key) “Apple Development Push Services: (your app id)”</li>
<li>Choose Export “Apple Development Push Services: (your app id)″.</li>
<li>Save this as <code>apns-prod-cert.p12</code> file somewhere you can access it.</li>
<li>When it prompts you for a password, leave it blank (or add one if you want, but this tutorial will assume it was left blank)</li>
<li>Repeat with the private key (in this case, TodoLite Push Notification Cert) and save it as <code>apns-prod-key.p12</code>.</li>
</ul>


<p>Now they need to be converted from <code>.p12</code> to <code>.pem</code> format.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl pkcs12 -clcerts -nokeys -out apns-prod-cert.pem -in apns-prod-cert.p12
</span><span class='line'>Enter Import Password: &lt;return&gt;
</span><span class='line'>MAC verified OK</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl pkcs12 -nocerts -out apns-prod-key.pem -in apns-prod-key.p12
</span><span class='line'>Enter Import Password:
</span><span class='line'>MAC verified OK
</span><span class='line'>Enter PEM pass phrase: hello &lt;return&gt;</span></code></pre></td></tr></table></div></figure>


<p>Remove the PEM passphrase:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ openssl rsa -in apns-prod-key.pem -out apns-prod-key-noenc.pem
</span><span class='line'>Enter pass phrase for apns-prod-key.pem: hello
</span><span class='line'>writing RSA key</span></code></pre></td></tr></table></div></figure>


<h2>Add PEM files to Uniqush docker container</h2>

<p>When you call the Uniqush REST API to add a Push Service Provider, it expects to find the PEM files on it&rsquo;s local file system.  Use the following commands to get these files into the running container in the <code>/tmp</code> directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ `container=$(docker ps | grep -i uniqush-push | awk '{print $1}')`
</span><span class='line'>$ docker cp /tmp/apns-prod-cert.pem $container:/tmp/apns-prod-cert.pem
</span><span class='line'>$ docker cp /tmp/apns-prod-key-noenc.pem $container:/tmp/apns-prod-key-noenc.pem</span></code></pre></td></tr></table></div></figure>


<h2>Create APNS provider in Uniqush via REST API</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:9898/addpsp -d service=myservice \
</span><span class='line'>                             -d pushservicetype=apns \
</span><span class='line'>                     -d cert=/tmp/apns-prod-cert.pem \
</span><span class='line'>                     -d key=/tmp/apns-prod-key-noenc.pem \
</span><span class='line'>                     -d sandbox=true</span></code></pre></td></tr></table></div></figure>


<p>(Note: I&rsquo;m using a development cert, but if this was a distribution cert you&rsquo;d want to use <code>sandbox=false</code>)</p>

<p>You should get a <code>200 OK</code> response with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[AddPushServiceProvider][Info] 2016/02/03 20:35:29 From=24.23.246.59:59447 Service=myservice PushServiceProvider=apns:9f49c9c618c97bebe21bea159d3c7a8577934bdf00 Success!</span></code></pre></td></tr></table></div></figure>


<h2>Add Uniqush subscriber</h2>

<p>Using the cleaned up device token from the previous step <code>281c87101b029fdb16c8e13439436336116001cebf6519e68edefab523dab1e9</code>, create a subscriber with the name <code>mytestsubscriber</code> via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:9898/subscribe -d service=myservice \
</span><span class='line'>                                             -d subscriber=mytestsubscriber \
</span><span class='line'>                       -d pushservicetype=apns \
</span><span class='line'>                       -d devtoken=281c87101b029fdb16c8e13439436336116001cebf6519e68edefab523dab1e9 </span></code></pre></td></tr></table></div></figure>


<p>You should receive a <code>200 OK</code> response with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Subscribe][Info] 2016/02/03 20:43:21 From=24.23.246.59:60299 Service=myservice Subscriber=mytestsubscriber PushServiceProvider=apns:9f49c9c618c97bebe21bea159d3c7a8577934bdf00 DeliveryPoint=apns:2cbecd0798cc6731d96d5b0fb01d813c7c9a83af00 Success!</span></code></pre></td></tr></table></div></figure>


<h2>Push a test message</h2>

<p>The moment of truth!</p>

<p>First, you need to either <strong>background your app</strong> by pressing the home button, or add <a href="https://gist.github.com/tleyden/97434117ad53757106ad">some code like this</a> so that an alert will be shown if the app is foregrounded.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -v http://localhost:9898/push -d service=myservice \
</span><span class='line'>                                        -d subscriber=mytestsubscriber \
</span><span class='line'>                  -d msg=HelloWorld</span></code></pre></td></tr></table></div></figure>


<p>You should get a <code>200 OK</code> response with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[Push][Info] 2016/02/03 20:46:08 RequestId=56b26710-INbW8UWMUONtH8Ttddd2Qg== From=24.23.246.59:60634 Service=myservice NrSubscribers=1 Subscribers="[mytestsubscriber]"
</span><span class='line'>[Push][Info] 2016/02/03 20:46:09 RequestID=56b26710-INbW8UWMUONtH8Ttddd2Qg== Service=myservice Subscriber=mytestsubscriber PushServiceProvider=apns:9f49c9c618c97bebe21bea159d3c7a8577934bdf00 DeliveryPoint=apns:2cbecd0798cc6731d96d5b0fb01d813c7c9a83af MsgId=apns:apns:9f49c9c618c97bebe21bea159d3c7a8577934bdf-1 Success!</span></code></pre></td></tr></table></div></figure>


<p>And a push notification on the device!</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/push_notification_device.png" alt="screenshot" /></p>

<h2>References</h2>

<ul>
<li><a href="http://uniqush.org/documentation/usage.html">Uniqush docs</a></li>
<li><a href="http://quickblox.com/developers/How_to_create_APNS_certificates">How to create APNS certificates</a></li>
<li><a href="https://blog.serverdensity.com/how-to-renew-your-apple-push-notification-push-ssl-certificate/">How to renew your Apple Push Notification Push SSL Certificate</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/22/cuda-7-dot-5-on-aws-gpu-instance-running-ubuntu-14-dot-04/">CUDA 7.5 on AWS GPU Instance Running Ubuntu 14.04</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-22T17:32:00-08:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Launch stock Ubuntu AMI</h2>

<ul>
<li>Launch <strong>ami-d05e75b8</strong></li>
<li>Choose a GPU instance type: <strong>g2.2xlarge</strong> or <strong>g2.8xlarge</strong></li>
<li>Increase the size of the storage (this depends on what else you plan to install, I&rsquo;d suggest at least 20 GB)</li>
</ul>


<h2>SSH in</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh ubuntu@&lt;instance ip&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Install CUDA repository</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1404/x86_64/cuda-repo-ubuntu1404_7.5-18_amd64.deb
</span><span class='line'>$ sudo dpkg -i cuda-repo-ubuntu1404_7.5-18_amd64.deb</span></code></pre></td></tr></table></div></figure>


<h2>Update APT</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get update
</span><span class='line'>$ sudo apt-get upgrade -y
</span><span class='line'>$ sudo apt-get install -y opencl-headers build-essential protobuf-compiler \
</span><span class='line'>    libprotoc-dev libboost-all-dev libleveldb-dev hdf5-tools libhdf5-serial-dev \
</span><span class='line'>    libopencv-core-dev  libopencv-highgui-dev libsnappy-dev libsnappy1 \
</span><span class='line'>    libatlas-base-dev cmake libstdc++6-4.8-dbg libgoogle-glog0 libgoogle-glog-dev \
</span><span class='line'>    libgflags-dev liblmdb-dev git python-pip gfortran</span></code></pre></td></tr></table></div></figure>


<p>You will get a dialog regarding the <code>menu.lst</code> file, just choose the default option it gives you.</p>

<p>Do some cleanup:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get clean</span></code></pre></td></tr></table></div></figure>


<h2>DRM module workaround</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install -y linux-image-extra-`uname -r` linux-headers-`uname -r` linux-image-`uname -r`</span></code></pre></td></tr></table></div></figure>


<p>For an explanation of why this is needed, see <a href="https://github.com/BVLC/caffe/wiki/Caffe-on-EC2-Ubuntu-14.04-Cuda-7">Caffe on EC2 Ubuntu 14.04 Cuda 7</a> and search for this command.</p>

<h2>Install CUDA</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install -y cuda
</span><span class='line'>$ sudo apt-get clean</span></code></pre></td></tr></table></div></figure>


<h2>Verify CUDA</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nvidia-smi</span></code></pre></td></tr></table></div></figure>


<p>You should see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 352.63     Driver Version: 352.63         |
</span><span class='line'>|-------------------------------+----------------------+----------------------+
</span><span class='line'>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span class='line'>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
</span><span class='line'>|===============================+======================+======================|
</span><span class='line'>|   0  GRID K520           Off  | 0000:00:03.0     Off |                  N/A |
</span><span class='line'>| N/A   30C    P0    36W / 125W |     11MiB /  4095MiB |      0%      Default |
</span><span class='line'>+-------------------------------+----------------------+----------------------+
</span><span class='line'>
</span><span class='line'>+-----------------------------------------------------------------------------+
</span><span class='line'>| Processes:                                                       GPU Memory |
</span><span class='line'>|  GPU       PID  Type  Process name                               Usage      |
</span><span class='line'>|=============================================================================|
</span><span class='line'>|  No running processes found                                                 |
</span><span class='line'>+-----------------------------------------------------------------------------+</span></code></pre></td></tr></table></div></figure>


<p>Make sure kernel module and devices are present:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ubuntu@ip-10-33-135-228:~$ lsmod | grep -i nvidia
</span><span class='line'>nvidia               8642880  0
</span><span class='line'>drm                   303102  1 nvidia
</span><span class='line'>ubuntu@ip-10-33-135-228:~$ ls -alh /dev | grep -i nvidia
</span><span class='line'>crw-rw-rw-  1 root root    195,   0 Nov 23 01:59 nvidia0
</span><span class='line'>crw-rw-rw-  1 root root    195, 255 Nov 23 01:58 nvidiactl</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<ul>
<li><a href="https://github.com/BVLC/caffe/wiki/Caffe-on-EC2-Ubuntu-14.04-Cuda-7">Caffe on EC2 Ubuntu 14.04 Cuda 7</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/22/running-neural-style-on-an-aws-gpu-instance/">Running Neural Style on an AWS GPU Instance</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-22T11:02:00-08:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>These instructions will walk you through getting <a href="https://github.com/jcjohnson/neural-style">neural-style</a> up and running on an AWS GPU instance.</p>

<h2>Spin up CUDA-enabled AWS instance</h2>

<p>Follow these instructions to <a href="http://tleyden.github.io/blog/2015/11/22/cuda-7-dot-5-on-aws-gpu-instance-running-ubuntu-14-dot-04/">install CUDA 7.5 on AWS GPU Instance Running Ubuntu 14.04</a>.</p>

<h2>SSH into AWS instance</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ssh ubuntu@&lt;instance-ip&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Install Docker</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get update && sudo apt-get install curl
</span><span class='line'>$ curl -sSL https://get.docker.com/ | sh</span></code></pre></td></tr></table></div></figure>


<p>As the post-install message suggests, enable docker for non-root users:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo usermod -aG docker ubuntu</span></code></pre></td></tr></table></div></figure>


<p>Verify correct install via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo docker run hello-world</span></code></pre></td></tr></table></div></figure>


<h2>Mount GPU devices</h2>

<p><strong>Mount</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /usr/local/cuda/samples/1_Utilities/deviceQuery
</span><span class='line'>$ sudo make
</span><span class='line'>$ sudo ./deviceQuery</span></code></pre></td></tr></table></div></figure>


<p>You should see something <a href="https://gist.github.com/tleyden/58ab2eedebc9529edb76">like this</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./deviceQuery Starting...
</span><span class='line'>
</span><span class='line'> CUDA Device Query (Runtime API) version (CUDART static linking)
</span><span class='line'>
</span><span class='line'>Detected 1 CUDA Capable device(s)
</span><span class='line'>
</span><span class='line'>Device 0: "GRID K520"
</span><span class='line'>  CUDA Driver Version / Runtime Version          6.5 / 6.5
</span><span class='line'>  ... snip ...
</span><span class='line'>
</span><span class='line'>deviceQuery, CUDA Driver = CUDART, CUDA Driver Version = 6.5, CUDA Runtime Version = 6.5, NumDevs = 1, Device0 = GRID K520
</span><span class='line'>Result = PASS</span></code></pre></td></tr></table></div></figure>


<p><strong>Verify: Find all your nvidia devices</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls -la /dev | grep nvidia</span></code></pre></td></tr></table></div></figure>


<p>You should see:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>crw-rw-rw-  1 root root    195,   0 Oct 25 19:37 nvidia0
</span><span class='line'>crw-rw-rw-  1 root root    195, 255 Oct 25 19:37 nvidiactl
</span><span class='line'>crw-rw-rw-  1 root root    251,   0 Oct 25 19:37 nvidia-uvm</span></code></pre></td></tr></table></div></figure>


<h2>Start Docker container</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ export DOCKER_NVIDIA_DEVICES="--device /dev/nvidia0:/dev/nvidia0 --device /dev/nvidiactl:/dev/nvidiactl --device /dev/nvidia-uvm:/dev/nvidia-uvm"
</span><span class='line'>$ sudo docker run -ti $DOCKER_NVIDIA_DEVICES kaixhin/cuda-torch /bin/bash</span></code></pre></td></tr></table></div></figure>


<h2>Re-install CUDA 7.5 in the Docker container</h2>

<p>As <a href="https://groups.google.com/d/msg/torch7/yCSNIzW590M/Af7CHXEdDQAJ">reported in the Torch7 Google Group</a> and in <a href="https://github.com/Kaixhin/dockerfiles/issues/6">Kaixhin/dockerfiles</a>, there is an API version mismatch with the docker container and the host&rsquo;s version of CUDA.</p>

<p>The workaround is to re-install CUDA 7.5 via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wget http://developer.download.nvidia.com/compute/cuda/repos/ubuntu1404/x86_64/cuda-repo-ubuntu1404_7.5-18_amd64.deb
</span><span class='line'>$ sudo dpkg -i cuda-repo-ubuntu1404_7.5-18_amd64.
</span><span class='line'>deb
</span><span class='line'>$ sudo apt-get update
</span><span class='line'>$ sudo apt-get upgrade -y
</span><span class='line'>$ sudo apt-get install -y opencl-headers build-essential protobuf-compiler \
</span><span class='line'>    libprotoc-dev libboost-all-dev libleveldb-dev hdf5-tools libhdf5-serial-dev \
</span><span class='line'>    libopencv-core-dev  libopencv-highgui-dev libsnappy-dev libsnappy1 \
</span><span class='line'>    libatlas-base-dev cmake libstdc++6-4.8-dbg libgoogle-glog0 libgoogle-glog-dev \
</span><span class='line'>    libgflags-dev liblmdb-dev git python-pip gfortran
</span><span class='line'>$ sudo apt-get clean
</span><span class='line'>$ sudo apt-get install -y linux-image-extra-`uname -r` linux-headers-`uname -r` linux-image-`uname -r`
</span><span class='line'>$ sudo apt-get install -y cuda</span></code></pre></td></tr></table></div></figure>


<h2>Verify CUDA inside docker container</h2>

<p>Running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nvidia-smi </span></code></pre></td></tr></table></div></figure>


<p>Should show info about the GPU driver and not return any errors.</p>

<p>Running this torch command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ th -e "require 'cutorch'; require 'cunn'; print(cutorch)"</span></code></pre></td></tr></table></div></figure>


<p>Should produce this output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>  getStream : function: 0x4054b760
</span><span class='line'>  getDeviceCount : function: 0x408bca58
</span><span class='line'>  .. etc
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Install neural-style</h2>

<p>The following should be run <strong>inside</strong> the docker container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt-get install -y wget libpng-dev libprotobuf-dev protobuf-compiler
</span><span class='line'>$ git clone --depth 1 https://github.com/jcjohnson/neural-style.git
</span><span class='line'>$ /root/torch/install/bin/luarocks install loadcaffe</span></code></pre></td></tr></table></div></figure>


<p><strong>Download models</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd neural-style
</span><span class='line'>$ sh models/download_models.sh</span></code></pre></td></tr></table></div></figure>


<h2>Run neural style</h2>

<p>First, grab a few images to test with</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir images
</span><span class='line'>$ wget https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg/1280px-Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg -O images/vangogh.jpg
</span><span class='line'>$ wget http://exp.cdn-hotels.com/hotels/1000000/10000/7500/7496/7496_42_z.jpg -O images/hotel_del_coronado.jpg</span></code></pre></td></tr></table></div></figure>


<p>Run it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ th neural_style.lua -style_image images/vangogh.jpg -content_image images/hotel_del_coronado.jpg</span></code></pre></td></tr></table></div></figure>


<h2>CuDNN (optional)</h2>

<p>CuDNN can potentially speed things up.</p>

<p><a href="https://developer.nvidia.com/cudnn">download cuDNN</a></p>

<p>Install via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tar -xzvf cudnn-7.0-linux-x64-v3.0-prod.tgz
</span><span class='line'>cd cuda/
</span><span class='line'>sudo cp lib64/libcudnn* /usr/local/cuda-7.5/lib64/
</span><span class='line'>sudo cp include/cudnn.h /usr/local/cuda-7.5/include
</span><span class='line'>export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda-7.5/lib64/</span></code></pre></td></tr></table></div></figure>


<p>Install the torch bindings for cuDNN:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>luarocks install cudnn</span></code></pre></td></tr></table></div></figure>


<h2>References</h2>

<ul>
<li><a href="https://github.com/jcjohnson/neural-style/blob/master/INSTALL.md">Neural-Style INSTALL.md</a></li>
<li>ami-84c787ee &mdash; this AMI has everything pre-installed, however it is installed on the host rather than under docker, which was due to time constraints.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/03/running-the-sync-gateway-amazon-ami/">Running the Sync Gateway Amazon AMI</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-03T11:11:00-08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How to run the Couchbase Sync Gateway AWS AMI</p>

<h2>Kick off AWS instance</h2>

<ul>
<li>Browse to the <a href="https://aws.amazon.com/marketplace/pp/B013XDO1B4">Sync Gateway AMI</a> in the AWS Marketplace</li>
<li>Click Continue</li>
<li>Change all ports to &ldquo;MY IP&rdquo; except for port 4984</li>
<li>Make sure you choose a key that you have locally</li>
</ul>


<h2>SSH in and start Sync Gateway</h2>

<ul>
<li>Go to the AWS console, find the EC2 instance, and find the instance public ip address.  It should look like this: <code>ec2-54-161-201-224.compute-1.amazonaws.com</code>.  The rest of the instructions will refer to this as <instance public ip></li>
<li><code>ssh ec2-user@&lt;instance public ip&gt;</code> (this should let you in without prompting you for a password.  if not, you chose a key when you launched that you don&rsquo;t have locally)</li>
<li>Start the Sync Gateway with this command:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/opt/couchbase-sync-gateway/bin/sync_gateway -interface=0.0.0.0:4984 -url=http://localhost:8091 -bucket=sync_gateway -dbname=sync_gateway</span></code></pre></td></tr></table></div></figure>


<ul>
<li>You should see output like this:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2015-11-03T19:37:05.384Z ==== Couchbase Sync Gateway/1.1.0(28;86f028c) ====
</span><span class='line'>2015-11-03T19:37:05.384Z Opening db /sync_gateway as bucket "sync_gateway", pool "default", server &lt;http://localhost:8091&gt;
</span><span class='line'>2015-11-03T19:37:05.384Z Opening Couchbase database sync_gateway on &lt;http://localhost:8091&gt;
</span><span class='line'>2015/11/03 19:37:05  Trying with selected node 0
</span><span class='line'>2015/11/03 19:37:05  Trying with selected node 0
</span><span class='line'>2015-11-03T19:37:05.536Z Using default sync function 'channel(doc.channels)' for database "sync_gateway"
</span><span class='line'>2015-11-03T19:37:05.536Z     Reset guest user to config
</span><span class='line'>2015-11-03T19:37:05.536Z Starting profile server on
</span><span class='line'>2015-11-03T19:37:05.536Z Starting admin server on 127.0.0.1:4985
</span><span class='line'>2015-11-03T19:37:05.550Z Starting server on localhost:4984 ...</span></code></pre></td></tr></table></div></figure>


<h2>Verify via curl</h2>

<p>From your workstation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl http://&lt;instance public ip&gt;:4984/sync_gateway/</span></code></pre></td></tr></table></div></figure>


<p>You should get a response like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{"committed_update_seq":1,"compact_running":false,"db_name":"sync_gateway","disk_format_version":0,"instance_start_time":1446579479331843,"purge_seq":0,"update_seq":1}</span></code></pre></td></tr></table></div></figure>


<h2>Customize configuration</h2>

<p>For more advanced Sync Gateway configuration, you will want to create a JSON config file on the EC2 instance itself and pass that to Sync Gateway when you launch it, or host your config JSON on the internet somewhere and pass Sync Gateway the URL to the file.</p>

<h2>View Couchbase Server UI</h2>

<p>In order to login to the Couchbase Server UI, go to <instance public ip>:8091 and use:</p>

<ul>
<li><strong>Username:</strong> Administrator</li>
<li><strong>Password:</strong> <code>&lt;aws instance id, eg: i-8a9f8335&gt;</code></li>
</ul>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>
  I&#8217;m a software engineer at Couchbase, working on <a href="https://github.com/couchbase/couchbase-lite-ios">Couchbase Mobile</a> &#8211; an open source mobile NoSQL database with built-in sync capabilities.
  </p>

  <p>
  In my spare time I am working on <a href="https://github.com/tleyden/elastic-thought">ElasticThought</a> &#8211; a scalable containerized REST API wrapper for the Caffe Deep Learning toolkit.
  </p>

  <p>
  Follow me on twitter: <a href="https://twitter.com/tleydn">@tleydn</a>
  </p>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/09/12/configuring-influxdb-and-grafana-with-go-client-library/">Configuring InfluxDB and Grafana With Go Client Library</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/05/19/go-race-detector-gotcha-with-value-receivers/">Go Race Detector Gotcha With Value Receivers</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/15/setting-up-a-self-hosted-drone-dot-io-ci-server/">Setting Up a Self-hosted drone.io CI Server</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/08/adding-vendoring-to-a-go-project/">Adding Vendoring to a Go Project</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/02/07/configure-emacs-as-a-go-editor-from-scratch-part-3/">Configure Emacs as a Go Editor From Scratch Part 3</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/tleyden">@tleyden</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tleyden',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Traun Leyden -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sevenstoryrabbithole';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

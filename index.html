
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Seven Story Rabbit Hole</title>
  <meta name="author" content="Traun Leyden">

  
  <meta name="description" content="Octopress has treated me well over the years, but with the advent of more modern blogging platforms like Ghost I decided it was time to switch. Check &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://tleyden.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Seven Story Rabbit Hole" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>

  <table><tr><td>
  <h1><a href="/">Seven Story Rabbit Hole</a></h1>
  
    <h2>Sometimes awesome things happen in deep rabbit holes.  Or not.</h2>
  
  </td><td>&nbsp;&nbsp;
  <img class="left" src="/images/rabbit_hole_graphic.png" width="132" height="105" title="image" alt="images">
  </td></tr>
  </table>

</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:tleyden.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/10/28/moving-to-a-new-blogging-platform/">Moving to a New Blogging Platform</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-10-28T13:03:00-07:00" pubdate data-updated="true">Oct 28<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Octopress has treated me well over the years, but with the advent of more modern blogging platforms like <a href="https://ghost.org/">Ghost</a> I decided it was time to switch.  Check out my new <a href="https://blog.tleyden.net">ghost blog</a>!</p>

<h2>Ghost advantages</h2>

<ol>
<li>Open source for hackability.</li>
<li>Hosted and self-hosted offerings, with easy migration either direction.</li>
<li>Very clean interface like Medium.</li>
<li>You own all your content, unlike Medium.</li>
<li>Extensible with plugins and themes.</li>
<li>Easy to inject markdown snippets or embed many types of content.</li>
<li>WYSIWIG editing straight from the browser is really nice and feels like a faster workflow.</li>
<li>There are options to create a paid newsletter (a la substack).</li>
</ol>


<h2>Ghost disadvantages</h2>

<ol>
<li>Since it&rsquo;s not a static blog, you can&rsquo;t just push to github pages and be done with it.</li>
<li>Self-hosting is a bit of a pain. My server ran out of memory and I ended up throwing in the towel and going with the Ghost Pro hosted version for now.  (though I can always easily go back later, which is nice)</li>
<li>Ghost Pro costs money.</li>
</ol>


<h2>Octopress advantages</h2>

<ol>
<li>When published to github pages, you get an amazing lightning-fast hosting service completely free.</li>
<li>Markdown-centric means the content is very portable to other places that natively support markdown.</li>
</ol>


<h2>Octopress disadvantages</h2>

<ol>
<li>Maintaining the ruby tooling can be a bit of a pain.  Upgrading is scary, so I got stuck at an old version.</li>
<li>Extensibility seemed like a pain so I personally didn&rsquo;t bother.</li>
<li>Feels a bit archaic at this point.</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2022/10/19/installing-autoware/">Installing Autoware on Ubuntu 20.04</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2022-10-19T14:10:00-07:00" pubdate data-updated="true">Oct 19<span>th</span>, 2022</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a log of my experience installing Autoware on my bare metal laptop running Ubuntu 20.04.  I had a ton of stumbling blocks but stuck with it and eventually got it working.  I documented it along the way, so if you hit any of those same issues this might be useful to you.</p>

<p>As a warning, this blog post is pretty messy because of all those stumbling blocks, so you&rsquo;re probably better off just following the <a href="https://autowarefoundation.github.io/autoware-documentation/main/installation/">official autoware installation docs</a> and referring to this in case you run into the same problems.</p>

<p>Good luck!!</p>

<!-- TOC start -->


<ul>
<li><a href="#my-system">My system</a></li>
<li><a href="#pre-install-steps">Pre-install steps</a>

<ul>
<li><a href="#choose-ubuntu-linux-version">Choose Ubuntu Linux version</a></li>
<li><a href="#docker-vs-source-install">Docker vs source install</a></li>
<li><a href="#clean-out-old-ros-installs">Clean out old ros installs</a></li>
</ul>
</li>
<li><a href="#installation-docker-based">Installation (docker-based)</a>

<ul>
<li><a href="#install-docker-engine">Install docker engine</a></li>
<li><a href="#nvidia-container-toolkit">Nvidia container toolkit</a></li>
<li><a href="#rocker">Rocker</a></li>
<li><a href="#start-autoware-docker-container">Start autoware docker container</a>

<ul>
<li><a href="#error-workaround">Error workaround</a></li>
</ul>
</li>
<li><a href="#install-vcstool">Install vcstool</a></li>
<li><a href="#setup-workspace-from-within-container">Setup workspace (from within container)</a></li>
</ul>
</li>
<li><a href="#run-a-planning-simulation">Run a planning simulation</a>

<ul>
<li><a href="#install-the-gdown-utility">Install the gdown utility</a></li>
<li><a href="#download-maps">Download maps</a></li>
<li><a href="#launch-autoware-take-1">Launch autoware &ndash; take 1</a></li>
<li><a href="#upgrade-to-cuda-116">Upgrade to CUDA 11.6</a></li>
<li><a href="#upgrade-to-cuda-116-take-2">Upgrade to CUDA 11.6 &ndash; take 2</a>

<ul>
<li><a href="#fixing-nvidia-smi-error">Fixing nvidia-smi error</a></li>
</ul>
</li>
<li><a href="#start-autoware-docker-container-take-2">Start autoware docker container take 2</a></li>
<li><a href="#install-nvidia-container-toolkit">Install Nvidia container toolkit</a></li>
<li><a href="#install-cudnn">Install cuDNN</a></li>
<li><a href="#install-tensorrt">Install TensorRT</a></li>
<li><a href="#start-autoware-docker-container-take-3">Start autoware docker container take 3</a></li>
<li><a href="#launch-autoware-take-2">Launch autoware take 2</a>

<ul>
<li><a href="#workaround-rviz2-errors-by-passing-in-devdri-device">Workaround rviz2 errors by passing in /dev/dri device</a></li>
</ul>
</li>
<li><a href="#start-autoware-docker-container-take-4">Start autoware docker container take 4</a></li>
<li><a href="#launch-autoware-take-3">Launch autoware take 3</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>


<!-- TOC end -->


<!-- TOC -->


<p><a name="my-system"></a></p>

<h2>My system</h2>

<ul>
<li>Ubuntu 20.04</li>
<li>System76 Oryx Pro laptop, 2017</li>
<li>Nvidia GeForce GTX 1070</li>
<li>Nvidia Driver Version: 470.141.03   CUDA Version: 11.4  (upgraded during this blog post to Driver Version: 510.73.05    CUDA Version: 11.6)</li>
</ul>


<!-- TOC -->


<p><a name="pre-install-steps"></a></p>

<h1>Pre-install steps</h1>

<!-- TOC -->


<p><a name="choose-ubuntu-linux-version"></a></p>

<h2>Choose Ubuntu Linux version</h2>

<p>Autoware currently supports both 20.04 and 22.04 (but not 18.04), and I decided to go with 20.04 since it was the next LTS version after the version I had installed (18.04).</p>

<p>I noticed that autoware recommended cuda version of 11.6, which only has official downloads for 20.04 and not 22.04, so that made me think that Ubuntu 20.04 was the better choice.</p>

<p>Here are the steps to upgrade to Ubuntu 20.04: <a href="https://ubuntu.com/blog/how-to-upgrade-from-ubuntu-18-04-lts-to-20-04-lts-today">official instructions</a>.</p>

<!-- TOC -->


<p><a name="docker-vs-source-install"></a></p>

<h2>Docker vs source install</h2>

<p>I decided to go with the easier docker install until I had a need to use the source install.</p>

<!-- TOC -->


<p><a name="clean-out-old-ros-installs"></a></p>

<h2>Clean out old ros installs</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt-get remove ros-dashing-*
</span><span class='line'>$ apt-get remove ros-melodic-*
</span><span class='line'>$ apt-get autoremove</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="installation-docker-based"></a></p>

<h1>Installation (docker-based)</h1>

<!-- TOC -->


<p><a name="install-docker-engine"></a></p>

<h2>Install docker engine</h2>

<p>Install docker engine based on <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/docker_engine#manual-installation">these instructions</a>.  This links to the snapshot of the instructions that I used (as do below links).  If you want to use the latest instructions, change the <code>0423b84ee8d763879bbbf910d249728410b16943</code> commit hash in the URL to <code>main</code>.</p>

<!-- TOC -->


<p><a name="nvidia-container-toolkit"></a></p>

<h2>Nvidia container toolkit</h2>

<p>Install the nvidia container toolkit based on <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/nvidia_docker#manual-installation">these instructions</a>.</p>

<p>After this step I was able to run <code>nvidia-smi</code> within the container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@apollo:/home/tleyden/Development# docker run --rm --gpus all nvidia/cuda:11.0.3-base-ubuntu20.04 nvidia-smi
</span><span class='line'>Thu Oct 20 05:28:27 2022       
</span><span class='line'>+-----------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 470.141.03   Driver Version: 470.141.03   CUDA Version: 11.4     |
</span><span class='line'>|-------------------------------+----------------------+----------------------+
</span><span class='line'>| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
</span><span class='line'>| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
</span><span class='line'>|                               |                      |               MIG M. |
</span><span class='line'>|===============================+======================+======================|
</span><span class='line'>|   0  NVIDIA GeForce ...  Off  | 00000000:01:00.0  On |                  N/A |
</span><span class='line'>| N/A   39C    P8     6W /  N/A |    116MiB /  8119MiB |     14%      Default |
</span><span class='line'>|                               |                      |                  N/A |
</span><span class='line'>+-------------------------------+----------------------+----------------------+
</span><span class='line'>                                                                               
</span><span class='line'>+-----------------------------------------------------------------------------+
</span><span class='line'>| Processes:                                                                  |
</span><span class='line'>|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
</span><span class='line'>|        ID   ID                                                   Usage      |
</span><span class='line'>|=============================================================================|
</span><span class='line'>+-----------------------------------------------------------------------------+
</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="rocker"></a></p>

<h2>Rocker</h2>

<p>Rocker is an alternative to Docker compose used by Autoware.</p>

<p>Installed rocker based on <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/rocker#manual-installation">these instructions</a>.</p>

<p>After this step, running <code>rocker</code> shows the rocker help.</p>

<!-- TOC -->


<p><a name="start-autoware-docker-container"></a></p>

<h2>Start autoware docker container</h2>

<p>I ran:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rocker --nvidia --x11 --user --volume $HOME/Development/autoware --volume $HOME/Development/autoware_map -- ghcr.io/autowarefoundation/autoware-universe:latest-cuda</span></code></pre></td></tr></table></div></figure>


<p>but got this error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Executing command: 
</span><span class='line'>docker run --rm -it  --gpus all -v /home/tleyden/Development/autoware:/home/tleyden/Development/autoware -v /home/tleyden/Development/autoware_map:/home/tleyden/Development/autoware_map  -e DISPLAY -e TERM   -e QT_X11_NO_MITSHM=1   -e XAUTHORITY=/tmp/.docker_555jyzo.xauth -v /tmp/.docker_555jyzo.xauth:/tmp/.docker_555jyzo.xauth   -v /tmp/.X11-unix:/tmp/.X11-unix   -v /etc/localtime:/etc/localtime:ro  d0c01d5fe6d7 
</span><span class='line'>docker: Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error running hook #0: error running hook: exit status 1, stdout: , stderr: Auto-detected mode as 'legacy'
</span><span class='line'>nvidia-container-cli: requirement error: unsatisfied condition: cuda&gt;=11.6, please update your driver to a newer version, or use an earlier cuda container: unknown.
</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="error-workaround"></a></p>

<h3>Error workaround</h3>

<p>Using the approach suggested in <a href="https://github.com/NVIDIA/nvidia-docker/issues/1409#issuecomment-1154910556">this github post</a> to add <code>-e NVIDIA_DISABLE_REQUIRE=true</code>, I ran the new command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rocker -e NVIDIA_DISABLE_REQUIRE=true --nvidia --x11 --user --volume $HOME/Development/autoware --volume $HOME/Development/autoware_map -- ghcr.io/autowarefoundation/autoware-universe:latest-cuda
</span></code></pre></td></tr></table></div></figure>


<p>which seemed to work, as it dropped me into a container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tleyden@86a918b83192:~/Development/autoware$ docker ps
</span><span class='line'>bash: docker: command not found</span></code></pre></td></tr></table></div></figure>


<p>Based on the response from the super helpful folks at Autoware in <a href="https://github.com/autowarefoundation/autoware/discussions/2961">this discussion</a> I determined I needed to upgrade my Cuda version based on <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/cuda#manual-installation">these instructions</a>.  (see later step below)</p>

<!-- TOC -->


<p><a name="install-vcstool"></a></p>

<h2>Install vcstool</h2>

<p>In the source instructions, it mentions that autoware depends on vcstool, which is a tool that makes it easy to manage code from multiple repos.</p>

<p>Install with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -s https://packagecloud.io/install/repositories/dirk-thomas/vcstool/script.deb.sh | sudo bash
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install python3-vcstool</span></code></pre></td></tr></table></div></figure>


<!-- TOC -->


<p><a name="setup-workspace-from-within-container"></a></p>

<h2>Setup workspace (from within container)</h2>

<p>In the container shell (started above):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd autoware
</span><span class='line'>mkdir src
</span><span class='line'>vcs import src &lt; autoware.repos
</span><span class='line'>sudo apt update
</span><span class='line'>rosdep update
</span><span class='line'>rosdep install --from-paths . --ignore-src --rosdistro $ROS_DISTRO
</span><span class='line'>colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release</span></code></pre></td></tr></table></div></figure>


<p>it took about 40 mins to build:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Summary: 238 packages finished [39min 59s]
</span><span class='line'>  17 packages had stderr output: bag_time_manager_rviz_plugin elevation_map_loader grid_map_pcl image_projection_based_fusion lidar_apollo_instance_segmentation lidar_apollo_segmentation_tvm lidar_apollo_segmentation_tvm_nodes lidar_centerpoint livox_tag_filter map_loader map_tf_generator ndt_omp simulator_compatibility_test tier4_traffic_light_rviz_plugin trtexec_vendor tvm_utility velodyne_pointcloud
</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="run-a-planning-simulation"></a></p>

<h1>Run a planning simulation</h1>

<p>According to the docs: &ldquo;Ad hoc simulation is a flexible method for running basic simulations on your local machine, and is the recommended method for anyone new to Autoware.&rdquo;, but there are no docs on how to do run an ad hoc simulation, so I am going to try a planning simulation based on the <a href="https://autowarefoundation.github.io/autoware-documentation/main/tutorials/ad-hoc-simulation/planning-simulation/">planning simulation docs</a></p>

<!-- TOC -->


<p><a name="install-the-gdown-utility"></a></p>

<h2>Install the gdown utility</h2>

<p>This tool is needed to download the map data.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pip3 install gdown</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="download-maps"></a></p>

<h2>Download maps</h2>

<p>In the container started above:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>gdown -O ~/autoware_map/ 'https://docs.google.com/uc?export=download&id=1499_nsbUbIeturZaDj7jhUownh5fvXHd'
</span><span class='line'>unzip -d ~/autoware_map ~/autoware_map/sample-map-planning.zip</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="launch-autoware-take-1"></a></p>

<h2>Launch autoware &ndash; take 1</h2>

<p>From inside the container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source ~/autoware/install/setup.bash
</span><span class='line'>ros2 launch autoware_launch planning_simulator.launch.xml map_path:=$HOME/autoware_map/sample-map-planning vehicle_model:=sample_vehicle sensor_model:=sample_sensor_kit
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m seeing a ton of errors like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[rviz2-33] [ERROR] [1666308693.487516652] [rviz2]: rviz::RenderSystem: error creating render window: InvalidParametersException: Window with name 'OgreWindow(0)' already exists in GLRenderSystem::_createRenderWindow at /tmp/binarydeb/ros-galactic-rviz-ogre-vendor-8.5.1/.obj-x86_64-linux-gnu/ogre-v1.12.1-prefix/src/ogre-v1.12.1/RenderSystems/GL/src/OgreGLRenderSystem.cpp (line 1061)</span></code></pre></td></tr></table></div></figure>


<p>and red-herring error</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[component_container_mt-2] [ERROR] [1666308803.727411757] [system.system_monitor.hdd_monitor]: Failed to execute findmnt. /dev/sda3</span></code></pre></td></tr></table></div></figure>


<p>and possible red herring error</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[system_error_monitor-5] [ERROR] [1666308988.596834579] [system_error_monitor system_error_monitor/input_data_timeout]: [Single Point Fault]: </span></code></pre></td></tr></table></div></figure>


<p>These issues seem related:</p>

<ol>
<li><a href="https://github.com/autowarefoundation/autoware.universe/issues/630">https://github.com/autowarefoundation/autoware.universe/issues/630</a></li>
<li><a href="https://github.com/autowarefoundation/autoware.universe/issues/641">https://github.com/autowarefoundation/autoware.universe/issues/641</a></li>
<li><a href="https://github.com/autowarefoundation/autoware.universe/issues/643">https://github.com/autowarefoundation/autoware.universe/issues/643</a></li>
</ol>


<p>I think this error matters the most, since I get it if I try to launch rviz directly:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[rviz2]: InvalidParametersException: Window with name 'OgreWindow(0)' already exists in GLRenderSystem::_createRenderWindow</span></code></pre></td></tr></table></div></figure>


<p>The same error was reported in <a href="https://github.com/ros2/rviz/issues/753">https://github.com/ros2/rviz/issues/753</a> and <a href="https://github.com/NVIDIA/nvidia-docker/issues/1438.">https://github.com/NVIDIA/nvidia-docker/issues/1438.</a></p>

<p>I will update my nvidia driver as alluded to above, remove the <code>-e NVIDIA_DISABLE_REQUIRE=true</code> workaround, and retry.</p>

<!-- TOC -->


<p><a name="upgrade-to-cuda-116"></a></p>

<h2>Upgrade to CUDA 11.6</h2>

<p>I erroneously used the <a href="https://developer.nvidia.com/cuda-11-6-0-download-archive?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_local">official nvidia instructions</a> for installing cuda, so instead use the official <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/cuda">autoware instructions</a> to install cuda rather than the steps below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
</span><span class='line'>sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
</span><span class='line'>wget https://developer.download.nvidia.com/compute/cuda/11.6.0/local_installers/cuda-repo-ubuntu2004-11-6-local_11.6.0-510.39.01-1_amd64.deb
</span><span class='line'>sudo dpkg -i cuda-repo-ubuntu2004-11-6-local_11.6.0-510.39.01-1_amd64.deb
</span><span class='line'>sudo apt-key add /var/cuda-repo-ubuntu2004-11-6-local/7fa2af80.pub
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get -y install cuda</span></code></pre></td></tr></table></div></figure>


<p>It failed on the last step:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get -y install cuda
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>Some packages could not be installed. This may mean that you have
</span><span class='line'>requested an impossible situation or if you are using the unstable
</span><span class='line'>distribution that some required packages have not yet been created
</span><span class='line'>or been moved out of Incoming.
</span><span class='line'>The following information may help to resolve the situation:
</span><span class='line'>
</span><span class='line'>The following packages have unmet dependencies:
</span><span class='line'> cuda : Depends: cuda-11-6 (&gt;= 11.6.0) but it is not going to be installed
</span><span class='line'>E: Unable to correct problems, you have held broken packages.
</span></code></pre></td></tr></table></div></figure>


<p>Based on <a href="https://github.com/autowarefoundation/autoware/discussions/2961#discussioncomment-3929511">this advice</a>, I&rsquo;m going to re-install.  First I am purging:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get purge "cuda*" "libcudnn*" "tensorrt*"  "nvidia*"
</span></code></pre></td></tr></table></div></figure>


<p>Reboot.</p>

<p>I still had some libnvidia packages, so I purged them with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get purge ~nnvidia</span></code></pre></td></tr></table></div></figure>


<p>Since I&rsquo;m running a system76 laptop, I went to them for support in order to upgrade the nvidia drivers.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt install system76-driver-nvidia</span></code></pre></td></tr></table></div></figure>


<p>and now I&rsquo;m running nvidia 515.65.01:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># nvidia-smi
</span><span class='line'>+-----------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 515.65.01    Driver Version: 515.65.01    CUDA Version: 11.7     |
</span><span class='line'>|-------------------------------+----------------------+----------------------+
</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="upgrade-to-cuda-116-take-2"></a></p>

<h2>Upgrade to CUDA 11.6 &ndash; take 2</h2>

<p>Again for this step I erroneously used the <a href="https://developer.nvidia.com/cuda-11-6-0-download-archive?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=Ubuntu&amp;target_version=20.04&amp;target_type=deb_local">official nvidia instructions</a> for installing cuda, so instead use the official <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/cuda">autoware instructions</a> to install cuda rather than the steps below.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo dpkg -i cuda-repo-ubuntu2004-11-6-local_11.6.0-510.39.01-1_amd64.deb
</span><span class='line'>sudo apt-key add /var/cuda-repo-ubuntu2004-11-6-local/7fa2af80.pub
</span><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get -y install cuda</span></code></pre></td></tr></table></div></figure>


<p>This succeeded, but now <code>nvidia-smi</code> does not work:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nvidia-smi
</span><span class='line'>Failed to initialize NVML: Driver/library version mismatch</span></code></pre></td></tr></table></div></figure>


<p>I later realized that I diverged from the autoware instructions in two ways:</p>

<ol>
<li>I should have run <code>cuda_version=11-4 apt install cuda-${cuda_version} --no-install-recommends</code></li>
<li>There are a few post-installation actions that need to be run</li>
</ol>


<p>Post-installation actions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Taken from: https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#post-installation-actions
</span><span class='line'>echo 'export PATH=/usr/local/cuda/bin${PATH:+:${PATH}}' &gt;&gt; ~/.bashrc
</span><span class='line'>echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}}' &gt;&gt; ~/.bashrc</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="fixing-nvidia-smi-error"></a></p>

<h3>Fixing nvidia-smi error</h3>

<p>I simply rebooted, and now nvidia-smi works.  Note that the cuda version went from 11.7 to 11.6.  The strange thing is that previously I idn&rsquo;t have the cuda packages installed.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ nvidia-smi
</span><span class='line'>Fri Oct 21 13:56:48 2022       
</span><span class='line'>+-----------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 510.73.05    Driver Version: 510.73.05    CUDA Version: 11.6     |
</span><span class='line'>|-------------------------------+----------------------+----------------------+
</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="start-autoware-docker-container-take-2"></a></p>

<h2>Start autoware docker container take 2</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rocker --nvidia --x11 --user --volume $HOME/Development/autoware --volume $HOME/Development/autoware_map -- ghcr.io/autowarefoundation/autoware-universe:latest-cuda</span></code></pre></td></tr></table></div></figure>


<p>but got error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker run --rm -it  --gpus all -v /home/tleyden/Development/autoware:/home/tleyden/Development/autoware -v /home/tleyden/Development/autoware_map:/home/tleyden/Development/autoware_map  -e DISPLAY -e TERM   -e QT_X11_NO_MITSHM=1   -e XAUTHORITY=/tmp/.dockerome5n2bc.xauth -v /tmp/.dockerome5n2bc.xauth:/tmp/.dockerome5n2bc.xauth   -v /tmp/.X11-unix:/tmp/.X11-unix   -v /etc/localtime:/etc/localtime:ro  d0c01d5fe6d7 
</span><span class='line'>docker: Error response from daemon: could not select device driver "" with capabilities: [[gpu]].
</span></code></pre></td></tr></table></div></figure>


<p>I realized I&rsquo;m still missing several requirements:</p>

<ol>
<li><a href="https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/nvidia_docker#manual-installation">Nvidia container toolkit</a> &ndash; I had this previously, but it was uninstalled.</li>
<li><a href="https://github.com/autowarefoundation/autoware/tree/main/ansible/roles/tensorrt#manual-installation">TensorRT and cuDNN</a> &ndash; ditto</li>
</ol>


<!-- TOC -->


<p><a name="install-nvidia-container-toolkit"></a></p>

<h2>Install Nvidia container toolkit</h2>

<p>I installed nvidia container toolkit based on these <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/nvidia_docker#manual-installation">autoware instructions</a></p>

<p>And now it&rsquo;s able to start a container and run <code>nvidia-smi</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># docker run --rm --gpus all nvidia/cuda:11.0.3-base-ubuntu20.04 nvidia-smi
</span><span class='line'>Fri Oct 21 21:08:28 2022       
</span><span class='line'>+-----------------------------------------------------------------------------+
</span><span class='line'>| NVIDIA-SMI 510.73.05    Driver Version: 510.73.05    CUDA Version: 11.6     |
</span><span class='line'>|-------------------------------+----------------------+----------------------+
</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="install-cudnn"></a></p>

<h2>Install cuDNN</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># apt-get install libcudnn8=${cudnn_version} libcudnn8-dev=${cudnn_version}
</span><span class='line'>Reading package lists... Done
</span><span class='line'>Building dependency tree       
</span><span class='line'>Reading state information... Done
</span><span class='line'>E: Unable to locate package libcudnn8
</span><span class='line'>E: Unable to locate package libcudnn8-dev</span></code></pre></td></tr></table></div></figure>


<p>This error was caused by another divergence from the autoware instructions, where I didn&rsquo;t run <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/cuda#manual-installation">this step</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/ /"</span></code></pre></td></tr></table></div></figure>


<p>I re-ran all of <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/tensorrt">these steps from the autoware docs</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
</span><span class='line'>sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
</span><span class='line'>sudo apt-key adv --fetch-keys https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/3bf863cc.pub
</span><span class='line'>sudo add-apt-repository "deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/ /"
</span><span class='line'>sudo apt-get update</span></code></pre></td></tr></table></div></figure>


<p>and now this step worked:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get install libcudnn8=${cudnn_version} libcudnn8-dev=${cudnn_version}</span></code></pre></td></tr></table></div></figure>


<p>Pin the libraries at those versions with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-mark hold libcudnn8 libcudnn8-dev</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="install-tensorrt"></a></p>

<h2>Install TensorRT</h2>

<p>Using <a href="https://github.com/autowarefoundation/autoware/tree/0423b84ee8d763879bbbf910d249728410b16943/ansible/roles/tensorrt">these instructions</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>tensorrt_version=8.4.2-1+cuda11.6
</span><span class='line'>sudo apt-get install libnvinfer8=${tensorrt_version} libnvonnxparsers8=${tensorrt_version} libnvparsers8=${tensorrt_version} libnvinfer-plugin8=${tensorrt_version} libnvinfer-dev=${tensorrt_version} libnvonnxparsers-dev=${tensorrt_version} libnvparsers-dev=${tensorrt_version} libnvinfer-plugin-dev=${tensorrt_version}
</span><span class='line'>sudo apt-mark hold libnvinfer8 libnvonnxparsers8 libnvparsers8 libnvinfer-plugin8 libnvinfer-dev libnvonnxparsers-dev libnvparsers-dev libnvinfer-plugin-dev</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="start-autoware-docker-container-take-3"></a></p>

<h2>Start autoware docker container take 3</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rocker --nvidia --x11 --user --volume $HOME/Development/autoware --volume $HOME/Development/autoware_map -- ghcr.io/autowarefoundation/autoware-universe:latest-cuda
</span><span class='line'>tleyden@apollo:~$ rocker --nvidia --x11 --user --volume $HOME/Development/autoware --volume $HOME/Development/autoware_map -- ghcr.io/autowarefoundation/autoware-universe:latest-cuda
</span><span class='line'>Extension volume doesn't support default arguments. Please extend it.
</span><span class='line'>Active extensions ['nvidia', 'volume', 'x11', 'user']
</span><span class='line'>Step 1/12 : FROM python:3-slim-stretch as detector
</span><span class='line'>...
</span><span class='line'>Executing command:
</span><span class='line'>docker run --rm -it  --gpus all -v /home/tleyden/Development/autoware:/home/tleyden/Development/autoware -v /home/tleyden/Development/autoware_map:/home/tleyden/Development/autoware_map  -e DISPLAY -e TERM   -e QT_X11_NO_MITSHM=1   -e XAUTHORITY=/tmp/.docker77n9jx85.xauth -v /tmp/.docker77n9jx85.xauth:/tmp/.docker77n9jx85.xauth   -v /tmp/.X11-unix:/tmp/.X11-unix   -v /etc/localtime:/etc/localtime:ro  d0c01d5fe6d7
</span><span class='line'>tleyden@0b1ce9ed54bd:~$</span></code></pre></td></tr></table></div></figure>


<p>This worked, but at first I was very confused that it actually worked.</p>

<p>It drops you back at the prompt with no meaningful output, but if you look closely, <strong>it&rsquo;s a different prompt</strong>.  The hostname changes from your actual hostname (apollo in my case), to this cryptic container name (<code>0b1ce9ed54bd</code>).</p>

<p>Note that if you run this in the container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ros2 topic list
</span><span class='line'>/parameter_events
</span><span class='line'>/rosout</span></code></pre></td></tr></table></div></figure>


<p>you will see meaningful output, whereas if you run that on your host, you will most likely see <code>ros2: command not found</code>, unless you had installed <code>ros2</code> on your host previously.</p>

<!-- TOC -->


<p><a name="launch-autoware-take-2"></a></p>

<h2>Launch autoware take 2</h2>

<p>(also requires maps download, see above)</p>

<p>From inside the container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source ~/autoware/install/setup.bash
</span><span class='line'>ros2 launch autoware_launch planning_simulator.launch.xml map_path:=$HOME/autoware_map/sample-map-planning vehicle_model:=sample_vehicle sensor_model:=sample_sensor_kit
</span></code></pre></td></tr></table></div></figure>


<p>But the same errors are showing up:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[rviz2-33] libGL error: MESA-LOADER: failed to retrieve device information
</span><span class='line'>[rviz2-33] libGL error: MESA-LOADER: failed to retrieve device information
</span><span class='line'>[rviz2-33] [ERROR] [1666388259.903611735] [rviz2]: RenderingAPIException: OpenGL 1.5 is not supported in GLRenderSystem::initialiseContext at /tmp/binarydeb/ros-galactic-rviz-ogre-vendor-8.5.1/.obj-x86_64-linux-gnu/ogre-v1.12.1-prefix/src/ogre-v1.12.1/RenderSystems/GL/src/OgreGLRenderSystem.cpp (line 1201)
</span><span class='line'>[rviz2-33] [ERROR] [1666388259.905397712] [rviz2]: rviz::RenderSystem: error creating render window: RenderingAPIException: OpenGL 1.5 is not supported in GLRenderSystem::initialiseContext at /tmp/binarydeb/ros-galactic-rviz-ogre-vendor-8.5.1/.obj-x86_64-linux-gnu/ogre-v1.12.1-prefix/src/ogre-v1.12.1/RenderSystems/GL/src/OgreGLRenderSystem.cpp (line 1201)
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://gist.github.com/tleyden/64a84ca4316c95ca9daa0c8d73728ac1">Full output log</a></p>

<p>Note that these errors are also shown if I run <code>rviz2</code> from within the container.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rviz2
</span><span class='line'>QStandardPaths: XDG_RUNTIME_DIR not set, defaulting to '/tmp/runtime-tleyden'
</span><span class='line'>libGL error: MESA-LOADER: failed to retrieve device information
</span><span class='line'>libGL error: MESA-LOADER: failed to retrieve device information
</span><span class='line'>[ERROR] [1666389050.804997231] [rviz2]: RenderingAPIException: OpenGL 1.5 is not supported in GLRenderSystem::initialiseContext at /tmp/binarydeb/ros-galactic-rviz-ogre-vendor-8.5.1/.obj-x86_64-linux-gnu/ogre-v1.12.1-prefix/src/ogre-v1.12.1/RenderSystems/GL/src/OgreGLRenderSystem.cpp (line 1201)
</span><span class='line'>[ERROR] [1666389050.805238544] [rviz2]: rviz::RenderSystem: error creating render window: RenderingAPIException: OpenGL 1.5 is not supported in GLRenderSystem::initialiseContext at /tmp/binarydeb/ros-galactic-rviz-ogre-vendor-8.5.1/.obj-x86_64-linux-gnu/ogre-v1.12.1-prefix/src/ogre-v1.12.1/RenderSystems/GL/src/OgreGLRenderSystem.cpp (line 1201)
</span><span class='line'>[ERROR] [1666389050.805275164] [rviz2]: InvalidParametersException: Window with name 'OgreWindow(0)' already exists in GLRenderSystem::_createRenderWindow at /tmp/binarydeb/ros-galactic-rviz-ogre-vendor-8.5.1/.obj-x86_64-linux-gnu/ogre-v1.12.1-prefix/src/ogre-v1.12.1/RenderSystems/GL/src/OgreGLRenderSystem.cpp (line 1061)</span></code></pre></td></tr></table></div></figure>




<!-- TOC -->


<p><a name="workaround-rviz2-errors-by-passing-in-devdri-device"></a></p>

<h3>Workaround rviz2 errors by passing in /dev/dri device</h3>

<p>Relevant github issues:</p>

<ol>
<li><a href="https://github.com/ros2/rviz/issues/672">https://github.com/ros2/rviz/issues/672</a></li>
<li><a href="https://github.com/openai/gym/issues/509">https://github.com/openai/gym/issues/509</a></li>
</ol>


<p>The recommended fix is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get install -y mesa-utils libgl1-mesa-glx</span></code></pre></td></tr></table></div></figure>


<p>I don&rsquo;t currently have either of those libraries installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dpkg -l | grep -i "mesa-utils"
</span><span class='line'>dpkg -l | grep -i "libgl1-mesa-glx"
</span></code></pre></td></tr></table></div></figure>


<p>I installed these packages on the host (outside the container), but that didn&rsquo;t fix the issue.</p>

<p>I tried installing the packages in the container, but that didn&rsquo;t work either.</p>

<p>There is a discrepancy between <code>glxinfo</code> on the host vs container.</p>

<p>In this container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rocker --nvidia --x11 --user nvidia/cuda:11.0.3-base-ubuntu20.04</span></code></pre></td></tr></table></div></figure>


<p>It is returning an error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ apt update && apt install -y mesa-utils
</span><span class='line'>$ glxinfo -B
</span><span class='line'>name of display: :1
</span><span class='line'>libGL error: MESA-LOADER: failed to retrieve device information
</span><span class='line'>display: :1  screen: 0
</span><span class='line'>direct rendering: Yes
</span><span class='line'>Extended renderer info (GLX_MESA_query_renderer):
</span><span class='line'>    Vendor: Intel Open Source Technology Center (0x8086)
</span><span class='line'>    Device: Mesa DRI Unknown Intel Chipset  (0x3e9b)
</span><span class='line'>    Version: 21.2.6
</span><span class='line'>    Accelerated: yes
</span><span class='line'>    Video memory: 3072MB
</span><span class='line'>    Unified memory: yes
</span><span class='line'>    Preferred profile: compat (0x2)
</span><span class='line'>    Max core profile version: 0.0
</span><span class='line'>    Max compat profile version: 1.3
</span><span class='line'>    Max GLES1 profile version: 1.1
</span><span class='line'>    Max GLES[23] profile version: 0.0
</span><span class='line'>OpenGL vendor string: Intel Open Source Technology Center
</span><span class='line'>OpenGL renderer string: Mesa DRI Unknown Intel Chipset 
</span><span class='line'>OpenGL version string: 1.3 Mesa 21.2.6
</span></code></pre></td></tr></table></div></figure>


<p>Whereas on the host:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ glxinfo -B
</span><span class='line'>name of display: :1
</span><span class='line'>display: :1  screen: 0
</span><span class='line'>direct rendering: Yes
</span><span class='line'>Extended renderer info (GLX_MESA_query_renderer):
</span><span class='line'>    Vendor: Intel (0x8086)
</span><span class='line'>    Device: Mesa Intel(R) UHD Graphics 630 (CFL GT2) (0x3e9b)
</span><span class='line'>    Version: 21.2.2
</span><span class='line'>    Accelerated: yes
</span><span class='line'>    Video memory: 3072MB
</span><span class='line'>    Unified memory: yes
</span><span class='line'>    Preferred profile: core (0x1)
</span><span class='line'>    Max core profile version: 4.6
</span><span class='line'>    Max compat profile version: 4.6
</span><span class='line'>    Max GLES1 profile version: 1.1
</span><span class='line'>    Max GLES[23] profile version: 3.2
</span><span class='line'>OpenGL vendor string: Intel
</span><span class='line'>OpenGL renderer string: Mesa Intel(R) UHD Graphics 630 (CFL GT2)
</span><span class='line'>OpenGL core profile version string: 4.6 (Core Profile) Mesa 21.2.2
</span><span class='line'>OpenGL core profile shading language version string: 4.60
</span><span class='line'>OpenGL core profile context flags: (none)
</span><span class='line'>OpenGL core profile profile mask: core profile
</span><span class='line'>
</span><span class='line'>OpenGL version string: 4.6 (Compatibility Profile) Mesa 21.2.2
</span><span class='line'>OpenGL shading language version string: 4.60
</span><span class='line'>OpenGL context flags: (none)
</span><span class='line'>OpenGL profile mask: compatibility profile
</span><span class='line'>
</span><span class='line'>OpenGL ES profile version string: OpenGL ES 3.2 Mesa 21.2.2
</span><span class='line'>OpenGL ES profile shading language version string: OpenGL ES GLSL ES 3.20
</span></code></pre></td></tr></table></div></figure>


<p>This <a href="https://stackoverflow.com/questions/45136499/how-do-i-pass-data-info-about-the-gpu-versions-of-opengl-opencl-mesa-etc">stack overflow post</a> suggested a workaround, and according to the <a href="https://github.com/osrf/rocker">rocker docs</a></p>

<p>&ldquo;For Intel integrated graphics support you will need to mount the /dev/dri directory as follows:&rdquo;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>--devices /dev/dri</span></code></pre></td></tr></table></div></figure>


<p>After restarting a container with that flag, it no longer shows the <code>libGL error: MESA-LOADER: failed to retrieve device information</code> error.</p>

<p>I <a href="https://github.com/autowarefoundation/autoware/discussions/2965">posted a question</a> on the autoware forum to find out why this workaround was needed.  Apparently there is another way to solve this problem by forcing the use of the nvidia gpu rather than the intel graphics card:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>prime-select query
</span><span class='line'># It should show on-demand by default
</span><span class='line'>sudo prime-select nvidia
</span><span class='line'># Force to use NVIDIA GPU</span></code></pre></td></tr></table></div></figure>


<p>but I haven&rsquo;t verified this yet.</p>

<!-- TOC -->


<p><a name="start-autoware-docker-container-take-4"></a></p>

<h2>Start autoware docker container take 4</h2>

<p>Add the <code>--devices /dev/dri</code> flag:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ rocker --nvidia --x11 --devices /dev/dri --user --volume $HOME/Development/autoware --volume $HOME/Development/autoware_map -- ghcr.io/autowarefoundation/autoware-universe:latest-cuda</span></code></pre></td></tr></table></div></figure>


<p>And now it finally works!! Running <code>rviz2</code> from within the container shows the rviz window:</p>

<p><img src="https://user-images.githubusercontent.com/296876/197299394-a1dcd275-4115-418c-9641-a4de762cf826.png" alt="Screenshot from 2022-10-21 15-44-48" /></p>

<!-- TOC -->


<p><a name="launch-autoware-take-3"></a></p>

<h2>Launch autoware take 3</h2>

<p>(also requires maps download, see above)</p>

<p>From inside the container:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>source ~/autoware/install/setup.bash
</span><span class='line'>ros2 launch autoware_launch planning_simulator.launch.xml map_path:=$HOME/autoware_map/sample-map-planning vehicle_model:=sample_vehicle sensor_model:=sample_sensor_kit
</span></code></pre></td></tr></table></div></figure>


<p>and rviz launched with autoware configured:</p>

<p><img src="https://user-images.githubusercontent.com/296876/197301286-7e8b257e-0587-4fa1-ab54-ed5be4f0cfcd.png" alt="Screenshot from 2022-10-21 15-51-01" /></p>

<p>Phew!  That was a lot harder than I thought it was going to be!  It would have gone smoother if:</p>

<ul>
<li>My nvidia/cuda drivers were up-to-date with Cuda 11.6 and a suitable nvidia driver version.</li>
<li>I&rsquo;d followed the autoware docs rather than using the nvidia docs &ndash; the small divergences mattered a lot. (:facepalm)</li>
<li>I had known about the <code>--devices /dev/dri</code> or nvidia &ldquo;prime-select&rdquo; workarounds.</li>
</ul>


<!-- TOC -->


<p><a name="references"></a></p>

<h1>References</h1>

<ul>
<li><a href="https://autowarefoundation.github.io/autoware-documentation/main/installation/">Official autoware installation guide</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/06/27/installing-ghost-on-aws-lightsail-with-sqlite/">Installing Ghost on AWS Lightsail With SQLite</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-06-27T09:59:00-07:00" pubdate data-updated="true">Jun 27<span>th</span>, 2020</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here are my requirements for a Ghost blogging platform backend:</p>

<ul>
<li>Cheap &ndash; ideally under $5 / month</li>
<li>Ability to setup multiple blogs if I later want to add a new blog hosted on a different domain: so blog1.domainA.com + and blog2.domainB.com, without increasing cost.</li>
<li>Easy to manage and backup</li>
</ul>


<p>Non-requirements:</p>

<ul>
<li>High traffic</li>
<li>Avoiding CLI or some server management (would be nice, but does that exist for &lt; $5 month?)</li>
</ul>


<p>And here is the tech stack:</p>

<ul>
<li>AWS Lightsail instance running Ubuntu 18</li>
<li>SQLite</li>
<li>Nginx</li>
<li>Node.js</li>
<li>Ghost Node.js module(s)</li>
</ul>


<p>SQLite was chosen over MySQL since this is one less &ldquo;moving part&rdquo; and slightly easier to manage.  See <a href="https://stanislas.blog/2018/03/migrating-ghost-from-mysql-to-sqlite/">this blog post</a> for the rationale.</p>

<h3>Launch a Lightsail instance</h3>

<p>Lightsail seems like a good value since you can get a decent sized instance and a static IP for $5.</p>

<p>Login to the AWS console and create a Lightsail instance with the following specs:</p>

<ul>
<li>Blueprint: OS Only Ubuntu 18.04 LTS</li>
<li>SSH key: upload your <code>~/.ssh/id_rsa.pub</code> (maybe make a copy and rename it with a better name to easily find it in the AWS console later)</li>
<li>Instance Plan: $5/mo with 1GB or RAM, 1 vCPU, 40 GB SSD and 2 TB of transfer.  Ghost recommends at least 1 GB of RAM, so it&rsquo;s probably better to use this instance size or greater.</li>
<li>Identify your instance: rabbit (or whatever you wanna call it!)</li>
</ul>


<p>You should see the following:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/LightSail_Instance.png" alt="LightSailInstance.png" /></p>

<h3>Create a static ip</h3>

<p>Go to the Lightsail <strong>Networking</strong> section, and choose &ldquo;Attach static ip&rdquo;.  Associate the static ip with the lightsail instance, and make a note of it as you will need in the next step.</p>

<h3>Add DNS A record</h3>

<p>Go to your DNS register where you registered your blog domain name (eg, Namecheap), and add a new A record as follows:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/AddDNSARecord.png" alt="DNSARecord.png" /></p>

<ul>
<li>Use &ldquo;blog&rdquo; for the host if you want the blog named &ldquo;blog.yourdomain.com&rdquo;, but you could also name it something else.</li>
<li>Use the public static ip address created in the previous step.</li>
</ul>


<h3>Install Ghost dependencies</h3>

<p>ssh in via <code>ssh ubuntu@&lt;your ligthsail instance ip&gt;</code></p>

<p>Update the apt package list:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get update</span></code></pre></td></tr></table></div></figure>


<p>Install nginx:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo apt-get install -y nginx
</span><span class='line'>$ sudo ufw allow 'Nginx Full'</span></code></pre></td></tr></table></div></figure>


<p>Install nodejs:</p>

<p>Add the NodeSource APT repository for Node 12, then install nodejs</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash
</span><span class='line'>$ sudo apt-get install -y nodejs</span></code></pre></td></tr></table></div></figure>


<p>Install Ghost-CLI</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo npm install ghost-cli@latest -g</span></code></pre></td></tr></table></div></figure>


<h3>Create ghost blog</h3>

<p>Create a directory to hold the blog:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir -p /var/www/ghost/blog1
</span><span class='line'>$ sudo chown ubuntu:ubuntu /var/www/ghost/blog1
</span><span class='line'>$ sudo chmod 775 /var/www/ghost/blog1/
</span><span class='line'>$ cd /var/www/ghost/blog1/</span></code></pre></td></tr></table></div></figure>


<p>Install Ghost:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ghost install --db sqlite3</span></code></pre></td></tr></table></div></figure>


<p>If you get an error about the node.js version being out of date, see the &ldquo;Error installing ghost due to node.js being out of date&rdquo; section below.</p>

<p>Here is how I answered the setup questions, but you can customize to your needs:</p>

<ul>
<li><strong>Enter your blog URL:</strong> <a href="http://blog1.domainA.com">http://blog1.domainA.com</a></li>
<li><strong>Do you wish to setup Nginx?:</strong> Yes</li>
<li><strong>Do you wish to setup SSL?:</strong> No</li>
<li><strong>Do you wish to setup Systemd?:</strong> Yes</li>
<li><strong>Do you want to start Ghost?:</strong> Yes</li>
</ul>


<p>I decided to setup SSL in a separate step rather than initially, but the more secure approach would be to use <strong>https</strong> instead, eg <a href="https://blog1.domainA.com">https://blog1.domainA.com</a> for the blog URL and answer Yes to the setup SSL question, which will trigger SSL setup initially.</p>

<p>If you do setup SSL, you will need to open port 443 in the Lightsail console, otherwise it won&rsquo;t work.  See the &ldquo;Setup SSL&rdquo; section below for instructions.</p>

<h3>Create Ghost admin user</h3>

<p>This part is a little scary, (and ghosts are scary), but Ghost basically puts your blog unprotected to the world without an admin user.  The first person that stumbles across it gets to become the admin user.  You want that to be you!</p>

<p>Quickly go to <a href="http://blog1.domainA.com">http://blog1.domainA.com</a> and create the Ghost admin user.</p>

<h3>Configure blog2 and map it&rsquo;s DNS</h3>

<p>Go to your DNS register where you registered your blog domain name (eg, Namecheap), and add a new A record as follows:</p>

<ul>
<li>Use &ldquo;blog&rdquo; for the host if you want the blog named &ldquo;blog.domainB.com&rdquo;, but you could also name it something else.</li>
<li>Use the public static ip address from the Lightsail AWS console.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ sudo mkdir -p /var/www/ghost/blog2
</span><span class='line'>$ sudo chown ubuntu:ubuntu /var/www/ghost/blog2
</span><span class='line'>$ sudo chmod 775 /var/www/ghost/blog2/
</span><span class='line'>$ cd /var/www/ghost/blog2/</span></code></pre></td></tr></table></div></figure>


<p>Install Ghost:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ghost install --db sqlite3</span></code></pre></td></tr></table></div></figure>


<p>Use the same steps above, except for the blog URL use: <a href="http://blog.domainB.com">http://blog.domainB.com</a></p>

<h3>Congrats!</h3>

<p>You now have two separate Ghost blogging sites setup on a single $5 / mo AWS Lightsail instance.</p>

<h3>Appendix</h3>

<h4>Error installing ghost due to node.js being out of date</h4>

<p>If you see this error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ghost install --db sqlite3
</span><span class='line'>You are running an outdated version of Ghost-CLI.
</span><span class='line'>It is recommended that you upgrade before continuing.
</span><span class='line'>Run `npm install -g ghost-cli@latest` to upgrade.
</span><span class='line'>
</span><span class='line'>✔ Checking system Node.js version - found v12.22.10
</span><span class='line'>✔ Checking logged in user
</span><span class='line'>✔ Checking current folder permissions
</span><span class='line'>✔ Checking system compatibility
</span><span class='line'>✔ Checking memory availability
</span><span class='line'>✔ Checking free space
</span><span class='line'>✔ Checking for latest Ghost version
</span><span class='line'>✔ Setting up install directory
</span><span class='line'>✖ Downloading and installing Ghost v5.20.0
</span><span class='line'>A SystemError occurred.
</span><span class='line'>
</span><span class='line'>Message: Ghost v5.20.0 is not compatible with the current Node version. Your node version is 12.22.10, but Ghost v5.20.0 requires ^14.17.0 || ^16.13.0
</span><span class='line'>
</span><span class='line'>Debug Information:
</span><span class='line'>    OS: Ubuntu, v18.04.1 LTS
</span><span class='line'>    Node Version: v12.22.10
</span><span class='line'>    Ghost-CLI Version: 1.18.1
</span><span class='line'>    Environment: production
</span><span class='line'>    Command: 'ghost install --db sqlite3'
</span><span class='line'>
</span><span class='line'>Try running ghost doctor to check your system for known issues.
</span><span class='line'>
</span><span class='line'>You can always refer to https://ghost.org/docs/ghost-cli/ for troubleshooting.</span></code></pre></td></tr></table></div></figure>


<h5>Fix option #1 &ndash; specify an older version of ghost</h5>

<p>Find an older version of ghost that is compatible with the node.js you have installed, then specify that version of ghost when installing it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ghost install 4.34.3 --db sqlite3</span></code></pre></td></tr></table></div></figure>


<p>How do you find that version?  I happened to have another blog folder that I had previously installed, so I just used that.  Maybe on the ghost website they have a compatibility chart.</p>

<p>The downside of this approach is that you won&rsquo;t have the latest and greatest version of ghost, including <a href="https://github.com/TryGhost/Ghost/security/advisories/GHSA-7v28-g2pq-ggg8">security updates</a>.  The upside though is that you won&rsquo;t break any existing ghost blogs on the same machine by upgrading node.js.</p>

<h5>Fix option #2 &ndash; upgrade to a later node.js and retry</h5>

<p>In the error above, it mentions that ghost requires node.js 14.17.0 or above.</p>

<p>The downside is that this could potentially break other existing ghost blogs on the same machine that are not compatible with the later version of node.js.  Using containers to isolate dependencies would be beneficial here.</p>

<p>Upgrade to that version of node.js based on <a href="https://ghost.org/docs/reinstall/">these instructions</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -fsSL https://deb.nodesource.com/setup_14.x | sudo -E bash -
</span><span class='line'>sudo apt-get install -y nodejs</span></code></pre></td></tr></table></div></figure>


<p>Run <code>node -v</code> to verify that you&rsquo;re running a recent enough version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ node -v
</span><span class='line'>v14.20.1</span></code></pre></td></tr></table></div></figure>


<p>Update the ghost cli version:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo npm install -g ghost-cli@latest</span></code></pre></td></tr></table></div></figure>


<p>Retry the ghost install command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ghost install --db sqlite3</span></code></pre></td></tr></table></div></figure>


<p>and this time it should not complain about the node.js version.</p>

<h4>Setup SSL</h4>

<p>During installation, you can answer &ldquo;Yes&rdquo; to setup SSL, and it will ask you for your email and use <a href="http://letsencrypt.org">letsencrypt</a> to generate a certificate for you.  See <a href="https://ghost.org/integrations/lets-encrypt/">this page</a> for more details.</p>

<p>But you must also open port 443 in your Lightsail firewall, otherwise it won&rsquo;t work.</p>

<p><img src="https://user-images.githubusercontent.com/296876/197869779-dd7f5ce8-8815-4895-9f87-0837c435a0e4.png" alt="Screen Shot 2022-10-25 at 12 53 32 PM" /></p>

<h4>Auto-renew SSL cert every 90 days</h4>

<p>Lets Encrypt certificates expire after 90 days.  To avoid downtime on your site, you should auto-renew the certificates.  See this <a href="https://blog.tekspace.io/how-to-renew-ghost-blog-lets-encrypt-certificate/">blog post</a> for details.</p>

<p>I tried to follow the <a href="https://blog.tekspace.io/how-to-renew-ghost-blog-lets-encrypt-certificate/">blog post</a>, and ran <code>ghost setup ssl-renew</code> in my blog folder, but after switching to root with <code>sudo su</code>, I noticed this existing cron entry:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># crontab -l
</span><span class='line'>32 0 * * * "/etc/letsencrypt"/acme.sh --cron --home "/etc/letsencrypt" &gt; /dev/null</span></code></pre></td></tr></table></div></figure>


<p>So it looks like it is already setup to renew the certs every day.</p>

<h3>References</h3>

<ul>
<li><a href="https://ghost.org/docs/install/ubuntu/">https://ghost.org/docs/install/ubuntu/</a></li>
<li><a href="https://forum.ghost.org/t/cannot-run-ghost-install-on-ubuntu-using-sqlite3/10129">https://forum.ghost.org/t/cannot-run-ghost-install-on-ubuntu-using-sqlite3/10129</a></li>
<li><a href="https://stanislas.blog/2018/03/migrating-ghost-from-mysql-to-sqlite/">https://stanislas.blog/2018/03/migrating-ghost-from-mysql-to-sqlite/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/07/02/openwhisk-action-sequences/">OpenWhisk Action Sequences</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-07-02T11:30:00-07:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This will walk you through getting up and running from scratch with Apache OpenWhisk on OSX, and setting up an Action Sequence where the output of one OpenWhisk Action is fed into the input of the next Action.</p>

<h2>Install OpenWhisk via Vagrant</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Clone openwhisk
</span><span class='line'>git clone --depth=1 https://github.com/apache/incubator-openwhisk.git openwhisk
</span><span class='line'>
</span><span class='line'># Change directory to tools/vagrant
</span><span class='line'>cd openwhisk/tools/vagrant
</span><span class='line'>
</span><span class='line'># Run script to create vm and run hello action
</span><span class='line'>./hello</span></code></pre></td></tr></table></div></figure>


<p>You should see reams of output, followed by:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>==&gt; default: ++ wsk action invoke /whisk.system/utils/echo -p message hello --result
</span><span class='line'>==&gt; default: {
</span><span class='line'>==&gt; default:     "message": "hello"
</span><span class='line'>==&gt; default: }</span></code></pre></td></tr></table></div></figure>


<h2>SSH into Vagrant machine and run OpenWhisk CLI</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ vagrant ssh</span></code></pre></td></tr></table></div></figure>


<p>Now you can access the OpenWhisk CLI:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk
</span><span class='line'>
</span><span class='line'>        ____      ___                   _    _ _     _     _
</span><span class='line'>       /\   \    / _ \ _ __   ___ _ __ | |  | | |__ (_)___| | __
</span><span class='line'>  /\  /__\   \  | | | | '_ \ / _ \ '_ \| |  | | '_ \| / __| |/ /
</span><span class='line'> /  \____ \  /  | |_| | |_) |  __/ | | | |/\| | | | | \__ \   &lt;
</span><span class='line'> \   \  /  \/    \___/| .__/ \___|_| |_|__/\__|_| |_|_|___/_|\_\
</span><span class='line'>  \___\/ tm           |_|
</span><span class='line'>
</span><span class='line'>Usage:
</span><span class='line'>  wsk [command]</span></code></pre></td></tr></table></div></figure>


<p>Re-run the &ldquo;Hello world&rdquo; via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke /whisk.system/utils/echo -p message hello --result
</span><span class='line'>{
</span><span class='line'>    "message": "hello"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Hello Go/Docker</h2>

<p>I tried following the <a href="http://jamesthom.as/blog/2017/01/17/openwhisk-and-go/">instructions on James Thomas&#8217; blog</a> for running Go within Docker, but ran into an error (see Disqus comment), and so here&rsquo;s how I worked around it.</p>

<p>First create a simple Go program and cross compile it.  Save the following to <code>exec.go</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main
</span><span class='line'>
</span><span class='line'>import "encoding/json"
</span><span class='line'>import "fmt"
</span><span class='line'>import "os"
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>  // native actions receive one argument, the JSON object as a string
</span><span class='line'>  arg := os.Args[1]
</span><span class='line'>
</span><span class='line'>  // unmarshal the string to a JSON object
</span><span class='line'>  var obj map[string]interface{}
</span><span class='line'>  json.Unmarshal([]byte(arg), &obj)
</span><span class='line'>  name, ok := obj["name"].(string)
</span><span class='line'>  if !ok {
</span><span class='line'>      name = "Stranger"
</span><span class='line'>  }
</span><span class='line'>  msg := map[string]string{"msg": ("Hello, " + name + "!")}
</span><span class='line'>  res, _ := json.Marshal(msg)
</span><span class='line'>  fmt.Println(string(res))
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Cross compile it for Linux:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>env GOOS=linux GOARCH=amd64 go build exec.go</span></code></pre></td></tr></table></div></figure>


<p>Pull the upstream Docker image:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker pull openwhisk/dockerskeleton</span></code></pre></td></tr></table></div></figure>


<p>Create a custom docker image based on <code>openwhisk/dockerskeleton</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>FROM openwhisk/dockerskeleton
</span><span class='line'>
</span><span class='line'>COPY exec /action/exec</span></code></pre></td></tr></table></div></figure>


<p>Build and test:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker build -t you/openwhisk-exec-test .
</span><span class='line'>$ docker run you/openwhisk-exec-test /action/exec '{"name": "James"}'
</span><span class='line'>{"msg":"Hello, James!"}</span></code></pre></td></tr></table></div></figure>


<h2>OpenWhisk Hello Go/Docker</h2>

<p>Push up the docker image to dockerhub:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>docker push you/openwhisk-exec-test</span></code></pre></td></tr></table></div></figure>


<p>Create the OpenWhisk action:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action create go_test --docker you/openwhisk-exec-test</span></code></pre></td></tr></table></div></figure>


<p>Invoke the action to verify it works:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke go_test --blocking --result
</span><span class='line'>{
</span><span class='line'>    "msg": "Hello, Stranger!"
</span><span class='line'>}
</span><span class='line'>$ wsk action invoke go_test --blocking --result --param name James
</span><span class='line'>{
</span><span class='line'>    "msg": "Hello, James!"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Define custom actions</h2>

<h3>Get a list of AWS users using aws-go-sdk</h3>

<p>Save this to <code>main.go</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main
</span><span class='line'>
</span><span class='line'>import (
</span><span class='line'>  "github.com/aws/aws-sdk-go/service/iam"
</span><span class='line'>  "github.com/aws/aws-sdk-go/aws/session"
</span><span class='line'>  "fmt"
</span><span class='line'>  "encoding/json"
</span><span class='line'>  "os"
</span><span class='line'>  "github.com/aws/aws-sdk-go/aws"
</span><span class='line'>  "github.com/aws/aws-sdk-go/aws/credentials"
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>type Params struct {
</span><span class='line'>  AwsAccessKeyId string
</span><span class='line'>  AwsSecretAccessKey string
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>type Result struct {
</span><span class='line'>  Doc interface{} `json:"doc"`
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  // native actions receive one argument, the JSON object as a string
</span><span class='line'>  arg := os.Args[1]
</span><span class='line'>
</span><span class='line'>  // unmarshal the string to a JSON object
</span><span class='line'>  var params Params
</span><span class='line'>  json.Unmarshal([]byte(arg), &params)
</span><span class='line'>
</span><span class='line'>  sess, err := session.NewSession(&aws.Config{
</span><span class='line'>      Credentials: credentials.NewCredentials(
</span><span class='line'>          &credentials.StaticProvider{Value: credentials.Value{
</span><span class='line'>              AccessKeyID:     params.AwsAccessKeyId,
</span><span class='line'>              SecretAccessKey: params.AwsSecretAccessKey,
</span><span class='line'>          }},
</span><span class='line'>      ),
</span><span class='line'>  })
</span><span class='line'>
</span><span class='line'>  // Create the service's client with the session.
</span><span class='line'>  svc := iam.New(sess)
</span><span class='line'>
</span><span class='line'>  listUsersInput := &iam.ListUsersInput{}
</span><span class='line'>
</span><span class='line'>  listUsersOutput, err := svc.ListUsers(listUsersInput)
</span><span class='line'>  if err != nil {
</span><span class='line'>      panic(fmt.Sprintf("Error listing users: %v", err))
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  result := Result{
</span><span class='line'>      Doc: listUsersOutput,
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  outputBytes, err := json.Marshal(result)
</span><span class='line'>  if err != nil {
</span><span class='line'>      panic(fmt.Sprintf("Error marshalling outputBytes: %v", err))
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  fmt.Printf("%s", string(outputBytes))
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Build and package into docker image, and push up to docker hub</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ env GOOS=linux GOARCH=amd64 go build -o exec main.go
</span><span class='line'>$ docker build -t you/fetch-aws-keys .
</span><span class='line'>$ docker push you/fetch-aws-keys</span></code></pre></td></tr></table></div></figure>


<p>Create an OpenWhisk action:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action create fetch_aws_keys --docker you/fetch-aws-keys --param AwsAccessKeyId "YOURKEY" --param AwsSecretAccessKey "YOURSECRET"</span></code></pre></td></tr></table></div></figure>


<p>Invoke it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke fetch_aws_keys --blocking --result
</span><span class='line'>{
</span><span class='line'>    "doc": {
</span><span class='line'>        "IsTruncated": false,
</span><span class='line'>        "Marker": null,
</span><span class='line'>        "Users": [
</span><span class='line'>            {
</span><span class='line'>                "Arn": "arn:aws:iam::9798798:user/some.user@yourcompany.co",
</span><span class='line'>                "CreateDate": "2016-01-11T23:49:40Z",
</span><span class='line'>                "PasswordLastUsed": "2017-06-07T17:41:08Z",
</span><span class='line'>                "Path": "/",
</span><span class='line'>                "UserId": "AIDAHGJJK87878KKW",
</span><span class='line'>                "UserName": "some.user@yourcompany.co"
</span><span class='line'>            },
</span><span class='line'>        ...
</span><span class='line'>    ]
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>Write to a CloudantDB</h3>

<h4>Cloudant Setup</h4>

<p>Create a Cloudant database via the Bluemix web admin.</p>

<p>Under the <strong>Permissions</strong> control panel section for the database, choose <strong>Generate a new API key</strong>.</p>

<p>Check the <strong>_writer</strong> permission and make a note of the <strong>Key</strong> and <strong>Password</strong></p>

<p>Verify connectivity by making a curl request:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -u "yourkey:yourpassword" http://67687-818ca382-081d--bluemix.cloudant.com/yourdb/_all_docs
</span><span class='line'>{"total_rows":0,"offset":0,"rows":[
</span><span class='line'>
</span><span class='line'>]}</span></code></pre></td></tr></table></div></figure>


<h4>OpenWhisk + Cloudant</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk package bind /whisk.system/cloudant myCloudant -p username MYUSERNAME -p password MYPASSWORD -p host MYCLOUDANTACCOUNT.cloudant.com</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m currently getting this error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>error: Binding creation failed: The supplied authentication is not authorized to access this resource. (code 751)</span></code></pre></td></tr></table></div></figure>


<h3>Switch to BlueMix</h3>

<p>At this point I swiched to the OpenWhisk on Bluemix, and downloaded the <code>wsk</code> cli from the Bluemix website, and configure it with my api key per the instructions.  Then I re-installed the action via:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action create fetch_aws_keys --docker you/fetch-aws-keys --param AwsAccessKeyId "YOURKEY" --param AwsSecretAccessKey "YOURSECRET"</span></code></pre></td></tr></table></div></figure>


<p>and made sure it worked by running:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke fetch_aws_keys --blocking --result</span></code></pre></td></tr></table></div></figure>


<h4>Cloudant Setup</h4>

<p>Following <a href="https://github.com/apache/incubator-openwhisk-package-cloudant/blob/master/README.md#setting-up-a-cloudant-database-in-bluemix">these instructions</a>:</p>

<p>You can get your Bluemix Org name (maybe the first part of your email address by default) and BlueMix space (dev by default) from the Bluemix web admin.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk property set --namespace myBluemixOrg_myBluemixSpace
</span><span class='line'>ok: whisk namespace set to myBluemixOrg_myBluemixSpace</span></code></pre></td></tr></table></div></figure>


<p>Refresh packages:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk package refresh
</span><span class='line'>myBluemixOrg_myBluemixSpace refreshed successfully
</span><span class='line'>created bindings:
</span><span class='line'>updated bindings:
</span><span class='line'>deleted bindings:</span></code></pre></td></tr></table></div></figure>


<p>It didn&rsquo;t work according to the docs, and no bindings were created even though I had created a Cloudant database in the Bluemix admin earlier.</p>

<p>I retried the <code>package bind</code> command that had failed earlier:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk package bind /whisk.system/cloudant myCloudant -p username MYUSERNAME -p password MYPASSWORD -p host MYCLOUDANTACCOUNT.cloudant.com</span></code></pre></td></tr></table></div></figure>


<p>and this time success!!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ok: created binding myCloudant</span></code></pre></td></tr></table></div></figure>


<p>Try writing to the db with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke /yournamespace/myCloudant/write --blocking --result --param dbname yourdb --param doc "{\"_id\":\"heisenberg\",\"name\":\"Walter White\"}"</span></code></pre></td></tr></table></div></figure>


<p>and you should get a response like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>    "id": "heisenberg",
</span><span class='line'>    "ok": true,
</span><span class='line'>    "rev": "1-f413f4b74a724e391fa5dd2e9c8e9d3f"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Connect them in a sequence</h2>

<h3>Create a new package binding pinned to a particular db</h3>

<p>The <code>/yournamespace/myCloudant/write</code> action expects a <code>dbname</code> parameter, but the upstream <code>fetch_aws_keys</code> doesn&rsquo;t contain that parameter.  (and it&rsquo;s better that it doesn&rsquo;t, to reduce decoupling).  So if you try to connect the two actions in a sequence at this point, it will fail.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk package bind /whisk.system/cloudant myCloudantTestDb -p username MYUSERNAME -p password MYPASSWORD -p host MYCLOUDANTACCOUNT.cloudant.com -p dbname testdb</span></code></pre></td></tr></table></div></figure>


<h3>Create sequence action</h3>

<p>Create a sequence that will invoke these actions in sequence:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action create fetch_and_write_aws_keys --sequence fetch_aws_keys,/namespace/myCloudantTestDb/write</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Fetch the AWS keys</li>
<li>Write the doc containing the AWS keys to the <code>testdb</code> database bound to the myCloudantTestDb package</li>
</ol>


<p>Try it out:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk action invoke fetch_and_write_aws_keys --blocking --result
</span><span class='line'>{
</span><span class='line'>    "id": "d80f24dc270208191c07c802bee4e58d",
</span><span class='line'>    "ok": true,
</span><span class='line'>    "rev": "1-ff66b6a20f50ea36d9019481276aa0bb"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>To view the resulting document:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wsk action invoke /traun.leyden_dev/cloudantKeynuker/read --blocking --result --param id d80f24dc270208191c07c802bee4e58d
</span><span class='line'>{
</span><span class='line'>    "IsTruncated": false,
</span><span class='line'>    "Marker": null,
</span><span class='line'>    "Users": [
</span><span class='line'>        {
</span><span class='line'>            "Arn": "arn:aws:iam::9798798:user/some.user@yourcompany.co",
</span><span class='line'>            "CreateDate": "2016-01-11T23:49:40Z",
</span><span class='line'>            "PasswordLastUsed": "2017-06-07T17:41:08Z",
</span><span class='line'>            "Path": "/",
</span><span class='line'>            "UserId": "AIDAHGJJK87878KKW",
</span><span class='line'>            "UserName": "ome.user@yourcompany.co"
</span><span class='line'>        },</span></code></pre></td></tr></table></div></figure>


<h2>Drive with a scheduler</h2>

<p>Let&rsquo;s say we wanted this to run every minute.</p>

<p>First create an alarm trigger that will fire every minute:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk trigger create everyMinute --feed /whisk.system/alarms/alarm -p cron '* * * * *'</span></code></pre></td></tr></table></div></figure>


<p>Now create a rule that will invoke the <code>fetch_and_write_aws_keys</code> action (which is a sequence action) whenever the <code>everyMinute</code> feed is triggered:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk rule create fetch_and_write_aws_keys_every_minute everyMinute fetch_and_write_aws_keys</span></code></pre></td></tr></table></div></figure>


<p>To verify that it is working, check your cloudant database to look for new docs:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -u "yourkey:yourpassword" http://67687-818ca382-081d--bluemix.cloudant.com/yourdb/_all_docs</span></code></pre></td></tr></table></div></figure>


<p>Or you can also monitor the activations:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ wsk activation poll
</span><span class='line'>Activation: everyMinute (f454e74ae4254657b0c920d14ea0d078)
</span><span class='line'>[]
</span><span class='line'>
</span><span class='line'>Activation: write (5d0e5c2a5af449efa1063b8dab71ba40)
</span><span class='line'>[
</span><span class='line'>    "2017-07-04T18:49:01.820736174Z stdout: success { ok: true,",
</span><span class='line'>    "2017-07-04T18:49:01.820773215Z stdout: id: '6a3e007478278726c5ecd7c85a9fe845',",
</span><span class='line'>    "2017-07-04T18:49:01.820781052Z stdout: rev: '1-25dae194be45260756aa43454fa28e60' }"
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>Activation: fetch_aws_keys (5d3a343b5a224130b4ea4bcb82517dc3)
</span><span class='line'>[
</span><span class='line'>    "2017-07-04T18:49:01.748729114Z stdout: XXX_THE_END_OF_A_WHISK_ACTIVATION_XXX",
</span><span class='line'>    "2017-07-04T18:49:01.748801169Z stderr: XXX_THE_END_OF_A_WHISK_ACTIVATION_XXX"
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>Activation: fetch_and_write_aws_keys (14619d5125a247f983a6d1e840820bb4)
</span><span class='line'>[
</span><span class='line'>    "5d3a343b5a224130b4ea4bcb82517dc3",
</span><span class='line'>    "5d0e5c2a5af449efa1063b8dab71ba40"
</span><span class='line'>]
</span><span class='line'>
</span><span class='line'>Activation: fetch_and_write_aws_keys_every_minute (de37f6b2bbaa407eb343b3859d9b3f74)
</span><span class='line'>[]
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/06/14/running-postgresql-in-docker/">Running PostgreSQL in Docker</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-06-14T08:01:00-07:00" pubdate data-updated="true">Jun 14<span>th</span>, 2017</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This walks you through:</p>

<ol>
<li>Running Postgres locally in a docker container using docker networking (rather than the deprecated container links functionality that is mentioned in the <a href="https://hub.docker.com/_/postgres/">Postgres Docker instructions</a>.</li>
<li>Deploying to Docker Cloud</li>
</ol>


<h1>Basic Postgres container with docker networking</h1>

<h2>Create a user defined network</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker network create --driver bridge postgres-network</span></code></pre></td></tr></table></div></figure>


<h2>Launch Postgres in that network</h2>

<p>The main parameter you will need to provide to postgres is a root db password.  Replace <code>*********</code> with a good password and run this command:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run --name postgres1 --network postgres-network -e POSTGRES_PASSWORD=********* -d postgres</span></code></pre></td></tr></table></div></figure>


<h2>Launch psql and connect to Postgres</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run -it --rm --network postgres-network postgres psql -h postgres1 -U postgres
</span><span class='line'>Password for user postgres: &lt;enter password used earlier&gt;
</span><span class='line'>psql (9.6.3)
</span><span class='line'>Type "help" for help.
</span><span class='line'>
</span><span class='line'>postgres=#</span></code></pre></td></tr></table></div></figure>


<p>You now have a working postgres database server.</p>

<h1>Using a mounted volume for persistence</h1>

<p>When running postgres under docker, most likely want to persist the database files on the host, rather than having them in the container.</p>

<p>First, remove the previous container with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker stop postgres1 && docker rm postgres1</span></code></pre></td></tr></table></div></figure>


<p>Go into the <code>/tmp</code> directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd /tmp</span></code></pre></td></tr></table></div></figure>


<p>Launch a container and use <code>/tmp/pgdata</code> as the host directory to mount as a volume mount, which will be mounted in the container in <code>/var/lib/postgresql/data</code>, which is the default location where Postgres stores it&rsquo;s data.  The <code>/tmp/pgdata</code> directory will be created on the host if it doesn&rsquo;t already exist.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run --name postgres1 --network postgres-network -v /tmp/pgdata:/var/lib/postgresql/data -e POSTGRES_PASSWORD=*************** -d postgres</span></code></pre></td></tr></table></div></figure>


<p>List the contents of <code>/tmp/pgdata</code> and you should see several Postgres files:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ls pgdata/
</span><span class='line'>PG_VERSION        pg_hba.conf     pg_serial       pg_twophase ...</span></code></pre></td></tr></table></div></figure>


<h1>Launch phppgadmin Container</h1>

<h2>First create a user</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run -it --rm --network postgres-network postgres /bin/bash</span></code></pre></td></tr></table></div></figure>


<p>Now you will be in a shell inside the docker container</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># createuser testuser -P --createdb -h postgres1 -U postgres
</span><span class='line'>Enter password for new role: *******
</span><span class='line'>Enter it again: ******
</span><span class='line'>Password: &lt;enter postgres password from earlier&gt;</span></code></pre></td></tr></table></div></figure>


<h2>Launch pgpadmin</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> $ docker run --name phppgadmin --network postgres-network -ti -d -p 8080:80 -e DB_HOST=postgres1 keepitcool/phppgadmin</span></code></pre></td></tr></table></div></figure>


<h2>Login</h2>

<p>In your browser, open <a href="http://localhost:8080/">http://localhost:8080/</a> and you should see the phpadmin login screen:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/phppgadmin.png" alt="loginscreen" /></p>

<p>Login with user/pass credentials created earlier:</p>

<ul>
<li><strong>username</strong>: <code>testuser</code></li>
<li><strong>password</strong>: <code>**********</code></li>
</ul>


<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/phpadmin_post_login.png" alt="postlogin" /></p>

<h1>Deploying to Docker Cloud</h1>

<p>Security warning!  This is not a secure deployment and it&rsquo;s not recommended to run this in production without a thorough audit by a security specialist.</p>

<h2>Deploy Stack</h2>

<p>Create a new stack and paste it into the box</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>postgres-server:
</span><span class='line'>  autoredeploy: true
</span><span class='line'>  environment:
</span><span class='line'>    - POSTGRES_PASSWORD=***************
</span><span class='line'>  image: 'postgres:latest'
</span><span class='line'>  volumes:
</span><span class='line'>    - '/var/lib/postgresql/data:/var/lib/postgresql/data'
</span><span class='line'>phppgadmin:
</span><span class='line'>  autoredeploy: true
</span><span class='line'>  environment:
</span><span class='line'>    - DB_HOST=postgres-server
</span><span class='line'>  image: 'keepitcool/phppgadmin:latest'
</span><span class='line'>  ports:
</span><span class='line'>    - '8085:80'</span></code></pre></td></tr></table></div></figure>


<p>For example:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_create_stack.png" alt="Docker Cloud" /></p>

<h2>Create user</h2>

<p>Find the postgres-server container and hit the <strong>Terminal</strong> menu to get a shell on that container.</p>

<p>Enter:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># createuser testuser -P --createdb -h localhost -U postgres 
</span><span class='line'>Enter password for new role: *******
</span><span class='line'>Enter it again: *********</span></code></pre></td></tr></table></div></figure>


<h2>Login to Web UI</h2>

<p>Find the phppgadmin service in the Docker Cloud Web UI, and look for the service endpoint, which should look something like this:</p>

<p><a href="http://phppgadmin.postgres.071a32d40.svc.dockerapp.io:8085/">http://phppgadmin.postgres.071a32d40.svc.dockerapp.io:8085/</a></p>

<p>Login with user/pass credentials created earlier:</p>

<ul>
<li><strong>username</strong>: <code>testuser</code></li>
<li><strong>password</strong>: <code>**********</code></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/20/understanding-function-closures-in-go/">Understanding Function Closures in Go</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-20T18:10:00-08:00" pubdate data-updated="true">Dec 20<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Function closures are <em>really powerful</em>.</p>

<p>Essentially you can think of them like <em>stateful functions</em>, in the sense that they encapsulate state.  The state that they happen to capture (or &ldquo;close over&rdquo; &mdash; hence the name &ldquo;closure&rdquo;) is everything that&rsquo;s in scope when they are defined.</p>

<p>First some very basic higher order functions.</p>

<h2>Higher order functions</h2>

<p>Functions that take other functions and call them are called higher order functions.  Here&rsquo;s a trivial example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func sendLoop(sender func()) {
</span><span class='line'>  sender()
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  mySender := func() {
</span><span class='line'>      fmt.Printf("I should send something\n")
</span><span class='line'>  }
</span><span class='line'>  sendLoop(mySender)
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In the <code>main()</code> function, we define a function called <code>mySender</code> and pass it to the <code>sendLoop()</code> function.  <code>sendLoop()</code> takes a confusing looking argument called <code>sender func()</code> &mdash; the parameter name is <code>sender</code>, and the parameter type is <code>func()</code>, which is a function that takes no arguments and returns no values.</p>

<p>To make this slightly less confusing, we can define a named <code>SenderFunc</code> function type and use that:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// A SenderFunc is a function that takes no arguments, returns nothing
</span><span class='line'>// and presumably sends something
</span><span class='line'>type SenderFunc func()
</span><span class='line'>
</span><span class='line'>func sendLoop(sender SenderFunc) {
</span><span class='line'>  sender()
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  mySender := func() {
</span><span class='line'>      fmt.Printf("I should send something\n")
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  sendLoop(mySender)
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><code>sendLoop()</code> has been updated to take <code>SenderFunc</code> as an argument, which is easier to read than taking a <code>func()</code> as an argument (which looks a bit like a function call!)  If the <code>SenderFunc</code> type took more parameters and/or returned more values, having this in a defined type would be crucial for readability.</p>

<h2>Adding a return value</h2>

<p>Let&rsquo;s make it slightly more realistic &mdash; let&rsquo;s say that the <code>sendLoop()</code> might need to retry calling the <code>SenderFunc</code> passed to it a few times until it actually works.  So the <code>SenderFunc</code> definition will need to be updated so that it returns a boolean that indicates whether a retry is necessary.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// A SenderFunc is a function that takes no arguments and returns a boolean
</span><span class='line'>// that indicates whether or not the send needs to be retried (in the case of failure)
</span><span class='line'>type SenderFunc func() bool
</span><span class='line'>
</span><span class='line'>func sendLoop(sender SenderFunc) {
</span><span class='line'>  for {
</span><span class='line'>      retry := sender()
</span><span class='line'>      if !retry {
</span><span class='line'>          return
</span><span class='line'>      }
</span><span class='line'>      time.Sleep(time.Second)
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  mySender := func() bool {
</span><span class='line'>      fmt.Printf("I should send something and return a real retry value\n")
</span><span class='line'>      return false
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  sendLoop(mySender)
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>One thing to note here is the clean separation of concerns &mdash; all <code>sendLoop()</code> knows is that it gets a <code>SenderFunc</code> which it should call and it will return a boolean indicator of whether or not it worked or not.  It knows absolutely nothing about the inner workings of the <code>SenderFunc</code>, nor does it care.</p>

<h2>A stateful sender &mdash; the wrong way</h2>

<p>You have a new requirement that you need to only retry the <code>SenderFunc</code> 10 times, and then you should give up.</p>

<p>Your first inclination might be to take this approach:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// A SenderFunc is a function that takes no arguments and returns a boolean
</span><span class='line'>// that indicates whether or not the send needs to be retried (in the case of failure)
</span><span class='line'>type SenderFunc func() bool
</span><span class='line'>
</span><span class='line'>func sendLoop(sender SenderFunc) {
</span><span class='line'>  counter := 0
</span><span class='line'>  for {
</span><span class='line'>      retry := sender()
</span><span class='line'>      if !retry {
</span><span class='line'>          return
</span><span class='line'>      }
</span><span class='line'>      counter += 1
</span><span class='line'>      if counter &gt;= 10 {
</span><span class='line'>          return
</span><span class='line'>      }
</span><span class='line'>      time.Sleep(time.Second)
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  mySender := func() bool {
</span><span class='line'>      fmt.Printf("I should send something and return a real retry value\n")
</span><span class='line'>      return false
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  sendLoop(mySender)
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This will work, but it makes the <code>sendLoop()</code> less generally useful.  What happens when your co-worker hears about this nifty <code>sendLoop()</code> you wrote, and wants to use it with their own <code>SenderFunc</code> but wants it to retry 100 times?  (side note: your <code>SenderFunc</code> implementation simply prints to the console, whereas theirs might write to a Slack channel, yet the <code>sendLoop()</code> will still work!)</p>

<p>To make it more generic, you could take this approach:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func sendLoop(sender SenderFunc, maxNumAttempts int) {
</span><span class='line'>  counter := 0
</span><span class='line'>  for {
</span><span class='line'>      retry := sender()
</span><span class='line'>      if !retry {
</span><span class='line'>          return
</span><span class='line'>      }
</span><span class='line'>      counter += 1
</span><span class='line'>      if counter &gt;= maxNumAttempts {
</span><span class='line'>          return
</span><span class='line'>      }
</span><span class='line'>      time.Sleep(time.Second)
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  mySender := func() bool {
</span><span class='line'>      fmt.Printf("I should send something and return a real retry value\n")
</span><span class='line'>      return false
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  sendLoop(mySender, 10)
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>Which will work &mdash; but there&rsquo;s a catch.  Now that you&rsquo;ve changed the method function signature of <code>sendLoop()</code> to take a second argument, all of the code that consumes <code>sendLoop()</code> will now be broken.  If this were an exported function, it would be an even worse problem.</p>

<p>Luckily there is a much better way.</p>

<h2>A stateful sender &mdash; the right way using function closures</h2>

<p>Rather than making <code>sendLoop()</code> do the retry-related accounting and passing it parameters for that accounting, you can make the <code>SenderFunc</code> handle this and encapsulate the state via a function closure.  In this case, the state is the number of retries that have been attempted, which will start at 0 and then increase on every call to the <code>SenderFunc</code></p>

<p>How can <code>SenderFunc</code> keep internal state?  It can &ldquo;close over&rdquo; any values that are in scope, which become associated with the function instance (I&rsquo;m calling it an &ldquo;instance&rdquo; because it has state, as we shall see) and will be bound to the function instance as long as the function instance is around.</p>

<p>Here&rsquo;s what the final code looks like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>// A SenderFunc is a function that takes no arguments and returns a boolean
</span><span class='line'>// that indicates whether or not the send needs to be retried (in the case of failure)
</span><span class='line'>type SenderFunc func() bool
</span><span class='line'>
</span><span class='line'>func sendLoop(sender SenderFunc) {
</span><span class='line'>  for {
</span><span class='line'>      retry := sender()
</span><span class='line'>      if !retry {
</span><span class='line'>          return
</span><span class='line'>      }
</span><span class='line'>      time.Sleep(time.Second)
</span><span class='line'>  }
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  counter := 0              // internal state closed over and mutated by mySender function
</span><span class='line'>  maxNumAttempts := 10      // internal state closed over and read by mySender function
</span><span class='line'>
</span><span class='line'>  mySender := func() bool {
</span><span class='line'>      sentSuccessfully := rand.Intn(5)
</span><span class='line'>      if sentSuccessfully {
</span><span class='line'>          return false // it worked, we're done!
</span><span class='line'>      }
</span><span class='line'>
</span><span class='line'>      // didn't work, any retries left?
</span><span class='line'>      // only retry if we haven't exhausted attempts
</span><span class='line'>      counter += 1
</span><span class='line'>      return counter &lt; maxNumAttempts
</span><span class='line'>
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  sendLoop(mySender)
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>The <code>counter</code> state variable is <em>bound</em> to the <code>mySender</code> function instance, which is able to update <code>counter</code> on every failed send attempt since the function &ldquo;closes over&rdquo; the <code>counter</code> variable that is in scope when the function instance is created.  This is the heart of the idea of a function closure.</p>

<p>The <code>sendLoop()</code> doesn&rsquo;t know anything about the internals of the <code>SenderFunc</code> in terms of how it tracks whether or not it should retry or not, it just treats it as a black box.  Different <code>SenderFunc</code> implementations could use vastly different rules and/or states for deciding whether the <code>sendLoop()</code> should retry a failed send.</p>

<p>If you wanted to make it even more flexible, you could update the <code>SenderFunc</code> to return a <code>time.Duration</code> in addition to a <code>bool</code> to indicate retry, which would allow you to implement &ldquo;backoff retry&rdquo; strategies and so forth.</p>

<h2>What about thread/goroutine safety?</h2>

<p>If you&rsquo;re passing the same function instances that have internal state (aka function closures) to multiple goroutines that are calling it, you&rsquo;re going to end up causing data races.  There&rsquo;s nothing special about function closures that protect you from this.</p>

<p>The simplest way to deal with is to make a new function instance for each goroutine you are sending the function instance to, which is probably what you want.  In theory though, you could also wrap the state update in a mutex, which is probably <em>not</em> what you want since that will cause goroutines to block eachother trying to grab the mutex.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/11/21/tuning-the-go-http-client-library-for-load-testing/">Tuning the Go HTTP Client Settings for Load Testing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-11-21T10:37:00-08:00" pubdate data-updated="true">Nov 21<span>st</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>While working on a load testing tool in Go, I ran into a situation where I was seeing tens of thousands of sockets in the <code>TIME_WAIT</code> state.</p>

<p>Here are a few ways to get into this situation and how to fix each one.</p>

<h2>Repro #1: Create excessive TIME_WAIT connections by forgetting to read the response body</h2>

<p>Run the following code on a linux machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>package main
</span><span class='line'>
</span><span class='line'>import (
</span><span class='line'>  "fmt"
</span><span class='line'>  "html"
</span><span class='line'>  "log"
</span><span class='line'>  "net"
</span><span class='line'>  "net/http"
</span><span class='line'>  "time"
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>func startWebserver() {
</span><span class='line'>
</span><span class='line'>  http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
</span><span class='line'>      fmt.Fprintf(w, "Hello, %q", html.EscapeString(r.URL.Path))
</span><span class='line'>  })
</span><span class='line'>
</span><span class='line'>  go http.ListenAndServe(":8080", nil)
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func startLoadTest() {
</span><span class='line'>  count := 0
</span><span class='line'>  for {
</span><span class='line'>      resp, err := http.Get("http://localhost:8080/")
</span><span class='line'>      if err != nil {
</span><span class='line'>          panic(fmt.Sprintf("Got error: %v", err))
</span><span class='line'>      }
</span><span class='line'>      resp.Body.Close()
</span><span class='line'>      log.Printf("Finished GET request #%v", count)
</span><span class='line'>      count += 1
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  // start a webserver in a goroutine
</span><span class='line'>  startWebserver()
</span><span class='line'>
</span><span class='line'>  startLoadTest()
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>and in a separate terminal while the program is running, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>netstat -n | grep -i 8080 | grep -i time_wait | wc -l</span></code></pre></td></tr></table></div></figure>


<p>and you will see this number constantly growing:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>166
</span><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>231
</span><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>293
</span><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>349
</span><span class='line'>... </span></code></pre></td></tr></table></div></figure>


<h2>Fix: Read Response Body</h2>

<p>Update the <code>startLoadTest()</code> method to add the following line of code (and related imports):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>func startLoadTest() {
</span><span class='line'>  for {
</span><span class='line'>          ...
</span><span class='line'>      if err != nil {
</span><span class='line'>          panic(fmt.Sprintf("Got error: %v", err))
</span><span class='line'>      }
</span><span class='line'>      io.Copy(ioutil.Discard, resp.Body)  // &lt;-- add this line
</span><span class='line'>      resp.Body.Close()
</span><span class='line'>                ...
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Now when you re-run it, calling <code>netstat -n | grep -i 8080 | grep -i time_wait | wc -l</code> while it&rsquo;s running will return 0.</p>

<h2>Repro #2: Create excessive TIME_WAIT connections by exceeding connection pool</h2>

<p>Another way to end up with excessive connections in the <code>TIME_WAIT</code> state is to consistently exceed the connnection pool and cause many short-lived connections to be opened.</p>

<p>Here&rsquo;s some code which starts up 100 goroutines which are all trying to make requests concurrently, and each request has a 50 ms delay:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>package main
</span><span class='line'>
</span><span class='line'>import (
</span><span class='line'>  "fmt"
</span><span class='line'>  "html"
</span><span class='line'>  "io"
</span><span class='line'>  "io/ioutil"
</span><span class='line'>  "log"
</span><span class='line'>  "net/http"
</span><span class='line'>  "time"
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>func startWebserver() {
</span><span class='line'>
</span><span class='line'>  http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
</span><span class='line'>
</span><span class='line'>      time.Sleep(time.Millisecond * 50)
</span><span class='line'>
</span><span class='line'>      fmt.Fprintf(w, "Hello, %q", html.EscapeString(r.URL.Path))
</span><span class='line'>  })
</span><span class='line'>
</span><span class='line'>  go http.ListenAndServe(":8080", nil)
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func startLoadTest() {
</span><span class='line'>  count := 0
</span><span class='line'>  for {
</span><span class='line'>      resp, err := http.Get("http://localhost:8080/")
</span><span class='line'>      if err != nil {
</span><span class='line'>          panic(fmt.Sprintf("Got error: %v", err))
</span><span class='line'>      }
</span><span class='line'>      io.Copy(ioutil.Discard, resp.Body)
</span><span class='line'>      resp.Body.Close()
</span><span class='line'>      log.Printf("Finished GET request #%v", count)
</span><span class='line'>      count += 1
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  // start a webserver in a goroutine
</span><span class='line'>  startWebserver()
</span><span class='line'>
</span><span class='line'>  for i := 0; i &lt; 100; i++ {
</span><span class='line'>      go startLoadTest()
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  time.Sleep(time.Second * 2400)
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>In another shell run <code>netstat</code>, note that the number of connections in the <code>TIME_WAIT</code> state is growing again, <em>even though the response is being read</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>166
</span><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>231
</span><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>293
</span><span class='line'>root@14952c2356a7:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>349
</span><span class='line'>... </span></code></pre></td></tr></table></div></figure>


<p>To understand what&rsquo;s going on, we&rsquo;ll need to dig in a little deeper into the <code>TIME_WAIT</code> state.</p>

<h2>What is the socket <code>TIME_WAIT</code> state anyway?</h2>

<p>So what&rsquo;s going on here?</p>

<p>What&rsquo;s happening is that we are creating lots of short lived TCP connections, and the Linux kernel networking stack is keeping tabs on the closed connections to prevent certain problems.</p>

<p>From <a href="http://www.isi.edu/touch/pubs/infocomm99/infocomm99-web/">The TIME-WAIT state in TCP and Its Effect on Busy Servers</a>:</p>

<blockquote><p>The purpose of TIME-WAIT is to prevent delayed packets from one connection being accepted by a later connection. Concurrent connections are isolated by other mechanisms, primarily by addresses, ports, and sequence numbers[1].</p></blockquote>

<h2>Why so many TIME_WAIT sockets?  What about connection re-use?</h2>

<p>By default, the Golang HTTP client will do connection pooling.  Rather than closing a socket connection after an HTTP request, it will add it to an idle connection pool, and if you try to make another HTTP request before the idle connection timeout (90 seconds by default), then it will re-use that existing connection rather than creating a new one.</p>

<p>This will keep the number of total socket connections low, as long as the pool doesn&rsquo;t fill up.  If the pool is full of established socket connections, then it will just create a new socket connection for the HTTP request and use that.</p>

<p>So how big is the connection pool?  A quick look into <a href="https://golang.org/src/net/http/transport.go">transport.go</a> tells us:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>var DefaultTransport RoundTripper = &Transport{
</span><span class='line'>        ... 
</span><span class='line'>  MaxIdleConns:          100,
</span><span class='line'>  IdleConnTimeout:       90 * time.Second,
</span><span class='line'>        ... 
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// DefaultMaxIdleConnsPerHost is the default value of Transport's
</span><span class='line'>// MaxIdleConnsPerHost.
</span><span class='line'>const DefaultMaxIdleConnsPerHost = 2</span></code></pre></td></tr></table></div></figure>


<ul>
<li>The <code>MaxIdleConns: 100</code> setting sets the size of the connection pool to 100 connections, but <em>with one major caveat</em>: this is on a per-host basis.  See the comments on the <code>DefaultMaxIdleConnsPerHost</code> below for more details on the implications of this.</li>
<li>The <code>IdleConnTimeout</code> is set to 90 seconds, meaning that after a connection stays in the pool and is unused for 90 seconds, it will be removed from the pool and closed.</li>
<li>The <code>DefaultMaxIdleConnsPerHost = 2</code> setting below it.  What this means is that even though the entire connection pool is set to 100, there is a <em>per-host</em> cap of only 2 connections!</li>
</ul>


<p>In the above example, there are 100 goroutines trying to concurrently make requests to the same host, but the connection pool can only hold 2 sockets.  So in the first &ldquo;round&rdquo; of the goroutines finishing their http request, 2 of the sockets will remain open in the pool, while the remaining 98 connections will be closed and end up in the <code>TIME_WAIT</code> state.</p>

<p>Since this is happening in a loop, you will quickly accumulate thousands or tens of thousands of connections in the <code>TIME_WAIT</code> state.  Eventually, for that particular host at least, you will run out of ephemeral ports and not be able to open new client connections.  For a load testing tool, this is <em>bad news</em>.</p>

<h2>Fix: Tuning the http client to increase connection pool size</h2>

<p>Here&rsquo;s how to fix this issue.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import (
</span><span class='line'>     .. 
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>var myClient *http.Client
</span><span class='line'>
</span><span class='line'>func startWebserver() {
</span><span class='line'>      ... same code as before
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>func startLoadTest() {
</span><span class='line'>        ... 
</span><span class='line'>  for {
</span><span class='line'>      resp, err := myClient.Get("http://localhost:8080/")  // &lt;-- use a custom client with custom *http.Transport
</span><span class='line'>                ... everything else is the same
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>func main() {
</span><span class='line'>
</span><span class='line'>  // Customize the Transport to have larger connection pool
</span><span class='line'>  defaultRoundTripper := http.DefaultTransport
</span><span class='line'>  defaultTransportPointer, ok := defaultRoundTripper.(*http.Transport)
</span><span class='line'>  if !ok {
</span><span class='line'>      panic(fmt.Sprintf("defaultRoundTripper not an *http.Transport"))
</span><span class='line'>  }
</span><span class='line'>  defaultTransport := *defaultTransportPointer // dereference it to get a copy of the struct that the pointer points to
</span><span class='line'>  defaultTransport.MaxIdleConns = 100
</span><span class='line'>  defaultTransport.MaxIdleConnsPerHost = 100
</span><span class='line'>
</span><span class='line'>  myClient = &http.Client{Transport: &defaultTransport}
</span><span class='line'>
</span><span class='line'>  // start a webserver in a goroutine
</span><span class='line'>  startWebserver()
</span><span class='line'>
</span><span class='line'>  for i := 0; i &lt; 100; i++ {
</span><span class='line'>      go startLoadTest()
</span><span class='line'>  }
</span><span class='line'>
</span><span class='line'>  time.Sleep(time.Second * 2400)
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<p>This bumps the total maximum idle connections (connection pool size) and the per-host connection pool size to 100.</p>

<p>Now when you run this and check the <code>netstat</code> output, the number of <code>TIME_WAIT</code> connections stays at 0</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>root@bbe9a95545ae:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>0
</span><span class='line'>root@bbe9a95545ae:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>0
</span><span class='line'>root@bbe9a95545ae:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>0
</span><span class='line'>root@bbe9a95545ae:/# netstat -n | grep -i 8080 | grep -i time_wait | wc -l
</span><span class='line'>0</span></code></pre></td></tr></table></div></figure>


<p>The problem is now fixed!</p>

<p>If you have higher concurrency requirements, you may want to bump this number to something higher than 100.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/31/install-couchbase-server-plus-mobile-on-docker-cloud/">Install Couchbase Server + Mobile on Docker Cloud</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-31T16:28:00-07:00" pubdate data-updated="true">Oct 31<span>st</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Deploy Couchbase Server and Sync Gateway on Docker Cloud behind a load balancer.</p>

<p>Also available as a <a href="https://www.youtube.com/watch?v=hPmSGGLJmw8&amp;feature=youtu.be">screencast</a></p>

<h2>Launch node cluster</h2>

<p>Launch a node cluster with the following settings:</p>

<ul>
<li>Provider: AWS</li>
<li>Region: us-east-1 (or whatever region makes sense for you)</li>
<li>VPC: Auto (if you don&rsquo;t choose auto, you will need to customize your security group)</li>
<li>Type/Size: m3.medium or greater</li>
<li>IAM Roles: None</li>
</ul>


<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_launch_nodecluster.png" alt="" /></p>

<h2>Create Couchbase Server service</h2>

<p>Go to <strong>Services</strong> and hit the <strong>Create</strong> button:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_service_create.png" alt="" /></p>

<p>Click the globe icon and <strong>Search Docker Hub</strong> for <code>couchbase/server</code>.  You should select the <code>couchbase/server</code> image:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_create_cbs_service.png" alt="" /></p>

<p>Hit the <strong>Select</strong> button and fill out the following values on the Services Wizard:</p>

<ul>
<li>Service Name: couchbaseserver</li>
<li>Containers: 2</li>
<li>Deployment strategy: High Availability</li>
<li>Autorestart: On failure</li>
<li>Network: bridge</li>
</ul>


<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_create_cbs_service2.png" alt="" /></p>

<p>In the Ports section: Enable <strong>published</strong> on each port and set the Node Port to match the Container Port</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_create_cbs_service3.png" alt="" /></p>

<p>Hit the <strong>Create and Deploy</strong> button.  After a few minutes, you should see the Couchbase Server vervice running:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_couchbase_server_running.png" alt="" /></p>

<h2>Configure Couchbase Server Container 1 + Create Buckets</h2>

<p>Go to the <strong>Container</strong> section and choose <strong>couchbaseserver-1</strong>.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_couchbase_container1.png" alt="" /></p>

<p>Copy and paste the domain name (<code>eca0fe88-7fee-446b-b006-99e8cae0dabf.node.dockerapp.io</code>) into your browser, adding 8091 at the end (<code>eca0fe88-7fee-446b-b006-99e8cae0dabf.node.dockerapp.io:8091</code>)</p>

<p>You should now see the Couchbase Server setup screen:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_couchbase_setup.png" alt="" /></p>

<p>You will need to find the <em>container IP</em> of Couchbase Server in order to configure it.  To do that, go to the <strong>Terminal</strong> section of <strong>Containers/couchbaseserver-1</strong>, and enter <code>ifconfig</code>.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_couchbase_container_terminal.png" alt="" /></p>

<p>Look for the <code>ethwe1</code> interface and make a note of the ip: <code>10.7.0.2</code> &mdash; you will need it in the next step.</p>

<p>Switch back to the browser on the Couchbase Server setup screen.  Leave the <strong>Start a new cluster</strong> button checked.  Enter the <code>10.7.0.2</code> ip address (or whatever was returned for your <code>ethwe1</code> interface) under the <strong>Hostname</strong> field.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_couchbase_server_hostname.png" alt="" /></p>

<p>and hit the <strong>Next</strong> button.</p>

<p>For the rest of the wizard, you can:</p>

<ul>
<li>skip adding the samples</li>
<li>skip adding the default bucket</li>
<li>uncheck <strong>Update Notifications</strong></li>
<li>leave Product Registration fields blank</li>
<li>check &ldquo;I agree ..&rdquo;</li>
<li>make sure to write down your password somewhere, otherwise you will be locked out of the web interface</li>
</ul>


<p>Create a new bucket for your application:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_create_bucket.png" alt="" /></p>

<h2>Configure Couchbase Server Container 2</h2>

<p>Go to the <strong>Container</strong> section and choose <strong>couchbaseserver-2</strong>.</p>

<p>As in the previous step, copy and paste the domain name (<code>4d8c7be0-3f47-471b-85df-d2471336af75.node.dockerapp.io</code>) into your browser, adding 8091 at the end (<code>4d8c7be0-3f47-471b-85df-d2471336af75.node.dockerapp.io:8091</code>)</p>

<p>Hit <strong>Setup</strong> and choose <strong>Join a cluster now</strong> with settings:</p>

<ul>
<li>IP Address: 10.7.0.2 (the IP address you setup the first Couchbase Server node with)</li>
<li>Username: Administrator (unless you used a different username in the previous step)</li>
<li>Password: enter the password you used in the previous step</li>
<li>Configure Server Hostname: 10.7.0.3 (you can double check this by going to the <strong>Terminal</strong> for <strong>Containers/couchbaseserver-2</strong> and running <code>ifconfig</code> and looking for the ip of the <code>ethwe1</code> interface)</li>
</ul>


<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_join_couchbase_cluster.png" alt="" /></p>

<p>Trigger a rebalance by hitting the <strong>Rebalance</strong> button:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_trigger_rebalance.png" alt="" /></p>

<h2>Sync Gateway Service</h2>

<p>Now create a Sync Gateway service.</p>

<p>Before going through the steps in the Docker Cloud web UI, you will need to have a Sync Gateway configuration somewhere on the publicly accessible internet.</p>

<p><em>Warning: This is not a secure solution!  Do not use any sensitive passwords if you follow these steps</em></p>

<p>To make it more secure, you could:</p>

<ul>
<li>Use a Volume mount and have Sync Gateway read the configuration from the container filesystem</li>
<li>Use a HTTPS + Basic Auth for the URL that hosts the Sync Gateway configuration</li>
</ul>


<p>Create a Sync Gateway configuration on a <a href="https://gist.github.com/tleyden/f260b2d9b2ef828fadfad462f0014aed">github gist</a> and get the <a href="https://gist.githubusercontent.com/tleyden/f260b2d9b2ef828fadfad462f0014aed/raw/8f544be6b265c0b57848b2ba36fb3e0f958ddcc9/gistfile1.txt">raw url</a> for the gist.</p>

<ul>
<li>Make sure to set the <code>server</code> value to <code>http://couchbaseserver:8091</code> so that it can connect to the Couchbase Service setup in a previous step.</li>
<li>Use the bucket created in the Couchbase Server setup step above</li>
</ul>


<p>In the Docker Cloud web UI, go to <strong>Services</strong> and hit the <strong>Create</strong> button again.</p>

<p>Click the globe icon and <strong>Search Docker Hub</strong> for <code>couchbase/sync-gateway</code>.  You should select the <code>couchbase/sync-gateway</code> image.</p>

<p>Hit the <strong>Select</strong> button and fill out the following values on the Services Wizard:</p>

<ul>
<li>Service Name: sync-gateway</li>
<li>Containers: 2</li>
<li>Deployment strategy: High Availability</li>
<li>Autorestart: On failure</li>
<li>Network: bridge</li>
</ul>


<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_sync_gateway_service.png" alt="" /></p>

<p>In the <strong>Container Configuration</strong> section, customize the <strong>Run Command</strong> to use the raw URL of your gist, eg: <code>https://gist.githubusercontent.com/tleyden/f260b2d9b2ef828fadfad462f0014aed/raw/8f544be6b265c0b57848</code></p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_configure_sg_service.png" alt="" /></p>

<p>In the <strong>Ports</strong> section, use the following values:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_configure_sg_service_ports.png" alt="" /></p>

<p>In the <strong>Links</strong> section, choose <strong>couchbaseserver</strong> and hit the <strong>Plus</strong> button</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_sg_service_links.png" alt="" /></p>

<p>Click the <strong>Create and Deploy</strong> button.</p>

<h2>Verify Sync Gateway</h2>

<p>Click the <strong>Containers</strong> section and you should have two Couchbase Server and two Sync Gateway containers running.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_cbs_sg_containers.png" alt="" /></p>

<p>Click the <strong>sync-gateway-1</strong> container and get the domain name (<code>eca0fe88-7fee-446b-b006-99e8cae0dabf.node.dockerapp.io</code>) and paste it in your browser with a trailing <code>:4984</code>, eg <code>eca0fe88-7fee-446b-b006-99e8cae0dabf.node.dockerapp.io:4984</code></p>

<p>You should see the following JSON response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>   "couchdb":"Welcome",
</span><span class='line'>   "vendor":{
</span><span class='line'>      "name":"Couchbase Sync Gateway",
</span><span class='line'>      "version":1.3
</span><span class='line'>   },
</span><span class='line'>   "version":"Couchbase Sync Gateway/1.3.1(16;f18e833)"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Setup Load Balancer</h2>

<p>Click the <strong>Services</strong> section and hit the <strong>Create</strong> button.  In the bottom right hand corner look for <strong>Proxies</strong> and choose <strong>dockercloud/haproxy</strong></p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_create_load_balancer_service1.png" alt="" /></p>

<p>General Settings:</p>

<ul>
<li>Service Name: sgloadbalancer</li>
<li>Containers: 1</li>
<li>Deployment Strategy: High Availability</li>
<li>Autorestart: Always</li>
<li>Network: Bridge</li>
</ul>


<p>Ports:</p>

<ul>
<li>Port 80 should be <strong>Published</strong> and the <strong>Node Port</strong> should be set to <code>80</code></li>
</ul>


<p>Links:</p>

<ul>
<li>Choose <strong>sync-gateway</strong> and hit the <strong>Plus</strong> button</li>
</ul>


<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_haproxy_ports_links.png" alt="" /></p>

<p>Hit the <strong>Create and Deploy</strong> button</p>

<h2>Verify Load Balancer</h2>

<p>Click the <strong>Containers</strong> section and choose <strong>sgloadbalancer-1</strong>.</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/docker_cloud_sgloadbalancer_container.png" alt="" /></p>

<p>Copy and paste the domain name (eg, <code>eca0fe88-7fee-446b-b006-99e8cae0dabf.node.dockerapp.io</code>) into your browser.</p>

<p>You should see the following JSON response:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>{
</span><span class='line'>   "couchdb":"Welcome",
</span><span class='line'>   "vendor":{
</span><span class='line'>      "name":"Couchbase Sync Gateway",
</span><span class='line'>      "version":1.3
</span><span class='line'>   },
</span><span class='line'>   "version":"Couchbase Sync Gateway/1.3.1(16;f18e833)"
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Congratulations!  You have just setup a Couchbase Server + Sync Gateway cluster on Docker Cloud.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/10/02/deep-dive-of-what-happens-under-the-hood-when-you-open-a-web-page/">Deep Dive of What Happens Under the Hood When You Open a Web Page</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-10-02T12:50:00-07:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a continuation of <a href="/blog/2016/09/30/the-lifecycle-of-an-http-request/">What Happens Under The Hood When You Open A Web Page</a>, and it&rsquo;s meant to be a deeper dive.</p>

<h3>Clients and Servers</h3>

<p>Remember back in the day when you wanted to know what time it was, and you picked up your phone and dialed 853-1212 and it said &ldquo;At the tone, the time will be 8:53 AM?&rdquo;.</p>

<p>Those days are over, but the idea lives on.  The time <em>service</em> is identical in principal to an internet <em>server</em>.  You ask it something, and it gives you an answer.</p>

<p>A well designed service does one thing, and one thing well.</p>

<ul>
<li><p>With the time service, you can only ask one kind of question: &ldquo;What time is it?&rdquo;</p></li>
<li><p>With a DNS server, you can only ask one kind of question: &ldquo;What is the IP address of organic-juice-for-dogs.io&rdquo;</p></li>
</ul>


<p>Clients vs Servers:</p>

<ul>
<li><p>A &ldquo;Client&rdquo; can essentially be thought of as being a &ldquo;Customer&rdquo;.  In the case of calling the time, it&rsquo;s the person dialing the phone number.  In the case of DNS, it&rsquo;s the Google Chrome browser asking for the IP address.</p></li>
<li><p>A &ldquo;Server&rdquo; can be thought of as being a &ldquo;Service&rdquo;.  In the case of calling the time, it&rsquo;s something running at the phone company.  In the case of DNS, it&rsquo;s a service run by a combination of universities, business, and governments.</p></li>
</ul>


<h2>Web Browsers</h2>

<p>The following programs are all web browsers, which are all technically HTTP Clients, meaning they are on the client end of the HTTP tube.</p>

<ul>
<li>Google Chrome</li>
<li>Safari</li>
<li>Firefox</li>
<li>Internet Explorer</li>
<li>Etc..</li>
</ul>


<p>What web browsers do:</p>

<ul>
<li>Lookup IP addresses from DNS servers over the DNS protocol (which in turn sits on top of the UDP protocol)</li>
<li>Retrieve web pages, images, and more from web servers over the HTTP protocol (which in turn sits on top of the TCP protocol)</li>
<li>Render HTML into formatted &ldquo;pages&rdquo;</li>
<li>Executes JavaScript code to add a level of dynamic behavior to web pages</li>
</ul>


<h2>Protocols</h2>

<p>In the previous post, there were a few &ldquo;protocols&rdquo; mentioned, like HTTP.</p>

<p>What are protocols really?</p>

<p><strong>Any protocol is something to make it possible for things that speak the same protocol to speak to each other over that protocol.</strong></p>

<p>A protocol is just a <em>language</em>, and just like everyone in English-speaking countries agree to speak English and can therefore intercommunicate without issues, many things on the internet agree to speak HTTP to each other.</p>

<p>Here&rsquo;s what a conversation looks like in the HTTP protocol:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HTTP Client: GET /
</span><span class='line'>HTTP Server: &lt;html&gt;I'm a &lt;blink&gt;amazing&lt;/blink&gt; HTML web page!!&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>Almost everything that happens on the Internet looks something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                                                                                  
</span><span class='line'> ┌────────────────────┐                                         ┌────────────────────┐
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │     Internet       ◀──────────────Protocol───────────────────▶    Internet        │
</span><span class='line'> │     Thing 1        │                                         │    Thing 2         │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> └────────────────────┘                                         └────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s look at a few protocols.</p>

<h3><strong>TCP</strong> and <strong>UDP</strong></h3>

<p>You can think of the internet as being made up of <em>tubes</em>.  Two very common types of tubes are:</p>

<ul>
<li>TCP (Transmission Control Protocol)</li>
<li>UDP (User Datagram Protocol)</li>
</ul>


<p>Here&rsquo;s what you might imagine an internet tube looking like:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/internet-tube.jpg" alt="image" /></p>

<h3><strong>IP</strong></h3>

<p>Really, you can think of TCP and UDP as internet tubes that are built from the same kind of concrete &mdash; and that concrete is called IP (Internet Protocol)</p>

<p>TCP <em>wraps</em> IP, in the sense that it is built on top of IP.  If you took a <em>slice</em> of a TCP internet tube, it would look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> ┌───────────────────────────────────────────┐
</span><span class='line'> │   TCP - (Transmission Control Protocol)   │
</span><span class='line'> │                                           │
</span><span class='line'> │                                           │
</span><span class='line'> │       ┌──────────────────────────┐        │
</span><span class='line'> │       │ IP - (Internet Protocol) │        │
</span><span class='line'> │       │                          │        │
</span><span class='line'> │       │                          │        │
</span><span class='line'> │       │                          │        │
</span><span class='line'> │       └──────────────────────────┘        │
</span><span class='line'> │                                           │
</span><span class='line'> └───────────────────────────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Ditto for UDP &mdash; it&rsquo;s also built on top of IP.  The slice of a UDP internet tube would look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> ┌───────────────────────────────────────────┐
</span><span class='line'> │    UDP - (Universal Datagram Protocol)    │
</span><span class='line'> │                                           │
</span><span class='line'> │                                           │
</span><span class='line'> │       ┌──────────────────────────┐        │
</span><span class='line'> │       │ IP - (Internet Protocol) │        │
</span><span class='line'> │       │                          │        │
</span><span class='line'> │       │                          │        │
</span><span class='line'> │       │                          │        │
</span><span class='line'> │       └──────────────────────────┘        │
</span><span class='line'> │                                           │
</span><span class='line'> └───────────────────────────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p>IP, or &ldquo;Internet Protocol&rdquo;, is fancy way of saying &ldquo;How machines on the Internet talk to each other&rdquo;, and <strong>IP addresses</strong> are their equivalent of phone numbers.</p>

<p>Why do we need two types of tubes built on top of IP?  They have different properties:</p>

<ul>
<li>TCP tubes are heavy weight, they take a long time to build, and a long time to tear down, but they are super reliable.</li>
<li>UDP tubes are light weight, and have no guarantees. They&rsquo;re like the <code>¯\_(ツ)_/¯</code> of internet tubes.  If you send something down a UDP internet tube, you actually have no idea whether it will make it down the tube or not.  It might seem useless, but it&rsquo;s not.  Pretty much all real time gaming, voice, and video transmissions go through UDP tubes.</li>
</ul>


<h2>HTTP tubes</h2>

<p>If you take a slice of an HTTP tube, it looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>┌───────────────────────────────────────────────────────────┐
</span><span class='line'>│           HTTP - (HyperText Transfer Protocol)            │
</span><span class='line'>│                                                           │
</span><span class='line'>│       ┌───────────────────────────────────────────┐       │
</span><span class='line'>│       │   TCP - (Transmission Control Protocol)   │       │
</span><span class='line'>│       │                                           │       │
</span><span class='line'>│       │        ┌──────────────────────────┐       │       │
</span><span class='line'>│       │        │ IP - (Internet Protocol) │       │       │
</span><span class='line'>│       │        │                          │       │       │
</span><span class='line'>│       │        └──────────────────────────┘       │       │
</span><span class='line'>│       │                                           │       │
</span><span class='line'>│       └───────────────────────────────────────────┘       │
</span><span class='line'>│                                                           │
</span><span class='line'>└───────────────────────────────────────────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p>Because HTTP <em>sits on top of</em> TCP, which in turn <em>sits on top of</em> IP.</p>

<h3>DNS tubes</h3>

<p>DNS tubes are very similar to HTTP tubes, except they sit on top of UDP tubes.  Here&rsquo;s what a slice might look like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>┌───────────────────────────────────────────────────────────┐
</span><span class='line'>│                DNS - (Domain Name Service)                │
</span><span class='line'>│                                                           │
</span><span class='line'>│       ┌───────────────────────────────────────────┐       │
</span><span class='line'>│       │    UDP - (Universal Datagram Protocol)    │       │
</span><span class='line'>│       │                                           │       │
</span><span class='line'>│       │        ┌──────────────────────────┐       │       │
</span><span class='line'>│       │        │ IP - (Internet Protocol) │       │       │
</span><span class='line'>│       │        │                          │       │       │
</span><span class='line'>│       │        └──────────────────────────┘       │       │
</span><span class='line'>│       │                                           │       │
</span><span class='line'>│       └───────────────────────────────────────────┘       │
</span><span class='line'>│                                                           │
</span><span class='line'>└───────────────────────────────────────────────────────────┘</span></code></pre></td></tr></table></div></figure>


<h2>Actually, internet tubes are more complicated</h2>

<p>So when your Google Chrome web browser gets a web page over an HTTP tube, it actually looks more like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                                             
</span><span class='line'>          ┌────────────────────┐             
</span><span class='line'>          │                    │             
</span><span class='line'>          │       Chrome       │             
</span><span class='line'>          │       Browser      │             
</span><span class='line'>          │                    │             
</span><span class='line'>          └─────────┬────▲─────┘             
</span><span class='line'>                    │    │                   
</span><span class='line'>                    │    │                   
</span><span class='line'>          ┌─────────▼────┴─────┐             
</span><span class='line'>          │                    │             
</span><span class='line'>          │   Some random      │             
</span><span class='line'>          │  computer in WA    │             
</span><span class='line'>          │                    │             
</span><span class='line'>          └─────────┬─────▲────┘             
</span><span class='line'>          ┌─────────▼─────┴────┐             
</span><span class='line'>          │                    │             
</span><span class='line'>          │   Some random      │             
</span><span class='line'>          │  computer in IL    │             
</span><span class='line'>          │                    │             
</span><span class='line'>          └────────┬───▲───────┘             
</span><span class='line'>          ┌────────▼───┴───────┐             
</span><span class='line'>          │                    │             
</span><span class='line'>          │   Some random      │             
</span><span class='line'>          │  computer in MA    │             
</span><span class='line'>          │                    │             
</span><span class='line'>          └──────────┬───▲─────┘             
</span><span class='line'>                     │   │                   
</span><span class='line'>                     │   │                   
</span><span class='line'>                     │   │                   
</span><span class='line'> Send me the HTML    │   │ &lt;html&gt;stuff&lt;/html&gt;
</span><span class='line'>                     │   │                   
</span><span class='line'>                     │   │                   
</span><span class='line'>                     │   │                   
</span><span class='line'>                     │   │                   
</span><span class='line'>          ┌──────────▼───┴─────┐             
</span><span class='line'>          │                    │             
</span><span class='line'>          │    HTTP Server     │             
</span><span class='line'>          │                    │             
</span><span class='line'>          └────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p>Each of these random computers in between are called <em>routers</em>, and they basically shuttle traffic across the internet.  They make it possible that any two computers on the internet can communicate with each other, without having a direct connection.</p>

<p>If you&rsquo;re curious to know which computers are in the middle of your connection between you and another computer on the internet, you can run a nifty little utility called <code>traceroute</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ traceroute google.com
</span><span class='line'>traceroute to google.com (172.217.5.110), 64 hops max, 52 byte packets
</span><span class='line'> 1  dd-wrt (192.168.11.1)  1.605 ms  1.049 ms  0.953 ms
</span><span class='line'> 2  96.120.90.157 (96.120.90.157)  9.334 ms  8.796 ms  8.850 ms
</span><span class='line'> 3  te-0-7-0-18-sur03.oakland.ca.sfba.comcast.net (68.87.227.209)  9.744 ms  9.416 ms  9.120 ms
</span><span class='line'> 4  162.151.78.93 (162.151.78.93)  12.310 ms  11.559 ms  11.662 ms
</span><span class='line'> 5  be-33651-cr01.sunnyvale.ca.ibone.comcast.net (68.86.90.93)  11.276 ms  11.187 ms  12.426 ms
</span><span class='line'> 6  hu-0-13-0-1-pe02.529bryant.ca.ibone.comcast.net (68.86.84.14)  11.624 ms
</span><span class='line'>    hu-0-12-0-1-pe02.529bryant.ca.ibone.comcast.net (68.86.87.14)  11.637 ms
</span><span class='line'>    hu-0-13-0-0-pe02.529bryant.ca.ibone.comcast.net (68.86.86.94)  12.404 ms
</span><span class='line'> 7  as15169-3-c.529bryant.ca.ibone.comcast.net (23.30.206.102)  11.024 ms  11.498 ms  11.148 ms
</span><span class='line'> 8  108.170.243.1 (108.170.243.1)  11.037 ms
</span><span class='line'>    108.170.242.225 (108.170.242.225)  12.246 ms
</span><span class='line'>    108.170.243.1 (108.170.243.1)  11.482 ms</span></code></pre></td></tr></table></div></figure>


<p>So from my computer to the computer at google.com, it goes through all of those intermediate computers.  Some have DNS names, like <code>be-33651-cr01.sunnyvale.ca.ibone.comcast.net</code>, but some only have IP addresses, like <code>162.151.78.93</code></p>

<p>Any one of those computers could <em>sniff</em> the traffic going through the tubes (even the <strong>IP</strong> tubes that all the other ones sit on top of!).  That&rsquo;s one of the reasons you don&rsquo;t want to send your credit cards over the internet without using encryption.</p>

<h2>The End</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/09/30/the-lifecycle-of-an-http-request/">What Happens Under the Hood When You Open a Web Page?</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-09-30T20:25:00-07:00" pubdate data-updated="true">Sep 30<span>th</span>, 2016</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>First, the bird&rsquo;s eye view:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                                                                        
</span><span class='line'>┌────┐                   ┌────────────────┐               ┌────────────────┐
</span><span class='line'>│You │                   │ Google Chrome  │               │    Internet    │
</span><span class='line'>└────┘                   └────────────────┘               └────────────────┘
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │    Show me the website for    │                                  │   
</span><span class='line'> │───organic-juice-for-dogs.io──▶│       1. Hey what's the IP of    │   
</span><span class='line'> │                               │─────organic-juice-for-dogs.io?──▶│   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │◀───────────63.120.10.5───────────│   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │        2. HTTP GET / to          │   
</span><span class='line'> │                               │───────────63.120.10.5───────────▶│   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │     HTML Content for homepage    │   
</span><span class='line'> │                               │◀───────────────of ───────────────│   
</span><span class='line'> │                               │     organic-juice-for-dogs.io    │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │         3. Render HTML into   │                                  │   
</span><span class='line'> │◀────────────a Web Page────────│                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │      Click stuff in Google    │                                  │   
</span><span class='line'> │─────────────Chrome───────────▶│                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> │         4. Execute JavaScript │                                  │   
</span><span class='line'> │◀─────────and update Web Page──┤                                  │   
</span><span class='line'> │                               │                                  │   
</span><span class='line'> ▼                               ▼                                  ▼</span></code></pre></td></tr></table></div></figure>


<p>It all starts with a DNS lookup.</p>

<h2>Step 1. The DNS Lookup</h2>

<p>Your Google Chrome software contacts a server on the Internet called a DNS server and asks it &ldquo;Hey what&rsquo;s the IP of organic-juice-for-dogs.io?&rdquo;.</p>

<p>DNS has an official sounding acronym, and for good reason, because it&rsquo;s a very authoritative and fundamental Internet service.</p>

<p>So what exactly is DNS useful for?</p>

<p><strong>It transforms Domain names into IP addresses</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                                                                               
</span><span class='line'> ┌────────────────────┐                                     ┌────────────────────┐
</span><span class='line'> │                    │      What's the IP address of       │                    │
</span><span class='line'> │                    │─────organic-juice-for-dogs.io?──────▶                    │
</span><span class='line'> │                    │                                     │                    │
</span><span class='line'> │       Chrome       │                                     │      DNS Server    │
</span><span class='line'> │       Browser      ◀───────────63.120.10.5───────────────│                    │
</span><span class='line'> │                    │                                     │                    │
</span><span class='line'> │                    │                                     │                    │
</span><span class='line'> │                    │                                     │                    │
</span><span class='line'> └────────────────────┘                                     └────────────────────┘
</span><span class='line'> </span></code></pre></td></tr></table></div></figure>


<p>A <strong>Domain name</strong>, also referred to as a &ldquo;Dot com name&rdquo;, is an easy-to-remember word or group of words, so people don&rsquo;t have to memorize a list of meaningless numbers.  You could think of it like dialing <strong>1-800-FLOWERS</strong>, which is a lot easier to remember than <strong>1-800-901-1111</strong></p>

<p>The IP address <code>63.120.10.5</code> is just like a phone number.  If you are a human being and want to call someone, you might dial <code>415-555-1212</code>.  But if you&rsquo;re a thing on the internet and you want to talk to another thing on the internet, you instead dial the <strong>IP address</strong> <code>63.120.10.5</code> &mdash; same concept though.</p>

<p>So, that&rsquo;s DNS in a nutshell.  Not very complicated on the surface.</p>

<h2>Step 2. Contact the IP address and fetch the HTML over HTTP</h2>

<p>In this step, Google Chrome sends an <code>HTTP GET /</code> HTTP request to the HTTP Server software running on a computer somewhere on the Internet that has the IP address <code>63.120.10.5</code>.</p>

<p>You can think of the <code>GET /</code> as &ldquo;Get me the top-most web page from the website&rdquo;.  This is known as the <em>root</em> of the website, in contrast to things deeper into the website, like <code>GET /juices/oakland</code>, which might return a list of dog juice products local to Oakland, CA.  Since the <em>root</em> is a the top, that means the tree is actually upside down, and folks tend to think of websites as being structured as <em>inverted trees</em>.</p>

<p>The back-and-forth is going to look something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'> ┌────────────────────┐                                         ┌────────────────────┐
</span><span class='line'> │                    │          What's the HTML for            │                    │
</span><span class='line'> │                    ├──────────http://63.120.10.5/?───────────▶                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │       Chrome       │                                         │    HTTP Server     │
</span><span class='line'> │       Browser      ◀──────────────&lt;html&gt;stuff&lt;/html&gt;─────────│                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> │    HTTP CLIENT     │                                         │                    │
</span><span class='line'> │                    │                                         │                    │
</span><span class='line'> └────────────────────┘                                         └────────────────────┘
</span><span class='line'> </span></code></pre></td></tr></table></div></figure>


<p>These things are speaking <strong>HTTP</strong> to each other.  What is HTTP?</p>

<p>You can think of things that communicate with each other over the internet as using <strong>tubes</strong>.  There are lots of different types of tubes, and in this case it&rsquo;s an HTTP tube.  As long as the software on both ends agree on the type of tube they&rsquo;re using, everything <em>just works</em> and they can send stuff back and forth.  HTTP is a really common type of tube, but it&rsquo;s not the only one &mdash; for example the DNS lookup in the previous step used a completely <em>different</em> type of tube.</p>

<p>Usually the stuff sent back from the HTTP Server is something called <strong>HTML</strong>, which stands for  <strong>H</strong>yper<strong>T</strong>ext <strong>M</strong>arkup <strong>L</strong>anguage.</p>

<p>But HTML is not the only kind of stuff that can be sent through an HTTP tube.  In fact, JSON (Javascript Object Notation) and XML (eXtensible Markup Language) are also very common.  In fact there are tons of different types of things that can be sent through HTTP tubes.</p>

<p>So at this point in our walk through, the Google Chrome web browser software has some HTML text, and it needs to <em>render</em> it in order for it to appear on your screen in a nice easy to view format.  That&rsquo;s the next step.</p>

<h2>Step 3. Render HTML in a Web page</h2>

<p>HTML is technically a <em>markup language</em>, which means that the text contains <em>formatting directives</em> which has an agreed upon standard on how it should be formatted.  You can think of HTML as being similar to a Microsoft Word document, but MS Word is obfuscated while HTML is very transparent and simple:</p>

<p>For example, here is some HTML:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;html&gt;
</span><span class='line'>   &lt;Header&gt;My first web page, circa, 1993!&lt;/Header&gt;
</span><span class='line'>   &lt;Paragraph&gt;
</span><span class='line'>        I am so proud to have made my very first web page, I &lt;blink&gt;Love&lt;/blink&gt; the World Wide Web
</span><span class='line'>   &lt;Paragraph&gt;
</span><span class='line'>   &lt;Footer&gt;Best Viewed on NCSA Mosaic&lt;/Footer&gt;
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>Which gets rendered into:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/my_first_webpage.jpg" alt="image" /></p>

<p>So, you&rsquo;ll notice that the <code>&lt;Header&gt;</code> element is in a larger font.  And the <code>&lt;Paragraph&gt;</code> has spaces in between it and the other text.</p>

<p>How does the Google Chrome Web Browser do the rendering?  It&rsquo;s just a piece of software, and rendering HTML is one of it&rsquo;s primary responsibilities.  There are tons of poor engineers at Google who do nothing all day but fix bugs in the Google Chrome rendering code.</p>

<p> Of course, there&rsquo;s a lot more to it, but that&rsquo;s the essence of rendering HTML into a web page.</p>

<h2>Step 4: Execute JavaScript in your Google Chrome Web Browser</h2>

<p>So this step is <em>optional</em> because not all web pages will execute JavaScript in your web browser software, however it&rsquo;s getting more and more common these days.  When you open the Gmail website in your browser, it&rsquo;s running tons of Javascript code to make the website as fast and responsive as possible.</p>

<p>Essentially, JavaScript adds another level of dynamic abilities to HTML, because when the browser is given HTML and it renders it .. that&rsquo;s it!  There&rsquo;s no more action, it just sits there &mdash; it&rsquo;s completely <em>inert</em>.</p>

<p>JavaScript, on the other hand, is basically a program-within-a-program.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>                                                              
</span><span class='line'> ┌───────────────────────────────────────────────────────────────┐
</span><span class='line'> │                         Google Chrome                         │
</span><span class='line'> │           (A program written in C++ you downloaded)           │
</span><span class='line'> │                                                               │
</span><span class='line'> │                                                               │
</span><span class='line'> │      ┌──────────────────────────────────────────────────┐     │
</span><span class='line'> │      │                                                  │     │
</span><span class='line'> │      │                                                  │     │
</span><span class='line'> │      │     JavaScript for organic-juice-for-dogs.io     │     │
</span><span class='line'> │      │  (A program in JavaScript that snuck in via the  │     │
</span><span class='line'> │      │                  HTML document)                  │     │
</span><span class='line'> │      │                                                  │     │
</span><span class='line'> │      │                                                  │     │
</span><span class='line'> │      └──────────────────────────────────────────────────┘     │
</span><span class='line'> │                                                               │
</span><span class='line'> │                                                               │
</span><span class='line'> └───────────────────────────────────────────────────────────────┘</span></code></pre></td></tr></table></div></figure>


<p>How does the JavaScript get to the web browser?  It sneaks in over the HTML!  It&rsquo;s <em>embedded</em> in the HTML, since it&rsquo;s just another form of text, and your Web Browser (Google Chrome) executes it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;html&gt;
</span><span class='line'>     &lt;Javascript&gt;
</span><span class='line'>          if (Paragraph == CLICKED) {
</span><span class='line'>              Window.Alert("YOU MAY BE INFECTED BY A VIRUS, CLICK HERE IMMEDIATELY")
</span><span class='line'>    }
</span><span class='line'>     &lt;/Javascript&gt;
</span><span class='line'>    ...
</span><span class='line'>&lt;/html&gt;</span></code></pre></td></tr></table></div></figure>


<p>What can JavaScript do exactly?  The list is really, really long.  But as a simple example, if you click a button on a webpage:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/html_button.gif" alt="html button" /></p>

<p>A JavasScript program can pop up a little &ldquo;Alert Box&rdquo;, like this:</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/javascript_alert.png" alt="javascript alert" /></p>

<h2>Done!</h2>

<p>And that&rsquo;s the World Wide Web!  You just went from typing a URL in your browser, from a shiny web page in your Google Chrome.  Soup to nuts.</p>

<p>And you can finally buy some juice for your dog!</p>

<p><img src="http://tleyden-misc.s3.amazonaws.com/blog_images/doge_coin_hungry_dog.png" alt="dogecoin dog" /></p>

<p>So that&rsquo;s it for the high level stuff.</p>

<p>If you&rsquo;re dying to know more, continue on to <a href="/blog/2016/10/02/deep-dive-of-what-happens-under-the-hood-when-you-open-a-web-page/">Deep Dive of What Happens Under The Hood When You Open A Web Page</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About Me</h1>
  <p>
  Indie hacker focused on applied Deep Learning.  Formerly Sr. SW Engineer at <a href="http://www.databricks.com">Databricks</a> working on MLOps (feature store).
  </p>

  <p>
  This is my old blog - check out <a href="https://blog.tleyden.net">my new blog</a> for the latest!
  </p>

  <p>
  Follow me on twitter: <a href="https://twitter.com/tleydn">@tleydn</a>
  </p>


</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2022/10/28/moving-to-a-new-blogging-platform/">Moving to a New Blogging Platform</a>
      </li>
    
      <li class="post">
        <a href="/blog/2022/10/19/installing-autoware/">Installing Autoware on Ubuntu 20.04</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/06/27/installing-ghost-on-aws-lightsail-with-sqlite/">Installing Ghost on AWS Lightsail With SQLite</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/07/02/openwhisk-action-sequences/">OpenWhisk Action Sequences</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017/06/14/running-postgresql-in-docker/">Running PostgreSQL in Docker</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/tleyden">@tleyden</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'tleyden',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Traun Leyden -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'sevenstoryrabbithole';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
